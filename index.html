<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZfP Review Audit - Schaeffler Technologies AG & Co. KG</title>
    <style>
        /* === DARK MODE VARIABLEN === */
        :root,
html[data-theme="light"] {
            /* Light Mode Variablen */
            --bg-primary: #eef8ee;      /* sehr helles grün */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3fbf3;     /* sehr helles grün */
            --text-primary: #333333;
            --text-secondary: #7f8c8d;
            --text-tertiary: #111111;   /* NICHT blau */
            --border-color: #bdc3c7;
            --border-light: #ecf0f1;
            --shadow-color: rgba(0,0,0,0.1);
            
            /* Header */
--header-border: #0f2a1a;
--header-bg: #1f6f43;
            /* Buttons */
            --btn-back: #7f8c8d;
            --btn-report: #8e44ad;
            --btn-danger: #e74c3c;
            --btn-info: #17a2b8;
            --btn-desktop: #f39c12; /* unbenutzt, kann bleiben */
            --btn-success: #27ae60;
            --btn-warning: #f39c12;
            --btn-export: #3498db;
            --btn-import: #9b59b6;
            --btn-cloud: #1abc9c;
            --btn-audits: #8e44ad;
            --btn-deviations: #e74c3c;
            --btn-pdf: #e74c3c;
            
            /* Audit Buttons */
            --audit-et: #3498db;
            --audit-mt: #e74c3c;
            --audit-ne: #2ecc71;
            --audit-ut: #9b59b6;

            /* Anforderung: dunkleres Orange/Rot für Cloud/Abweichungen */
            --audit-cloud: #d35400;       /* vorher #f39c12 */
            --audit-deviations: #c0392b;  /* vorher #e74c3c */
            
            /* Progress */
            --progress-bg: #ecf0f1;
            --progress-100: #27ae60;
            --progress-75: #2ecc71;
            --progress-50: #f39c12;
            --progress-25: #e67e22;
            --progress-0: #e74c3c;
            
            /* Questions */
            --question-border: #3498db;
            --question-bg: #f8f9fa;
            --points-0: #e74c3c;
            --points-4: #f39c12;
            --points-8: #2ecc71;
            --points-10: #27ae60;
            --points-na: #95a5a6;
            
            /* Deviation */
            --deviation-bg: #fff3f3;
            --deviation-border: #e74c3c;
            --deviation-open: #e74c3c;
            --deviation-closed: #27ae60;
            --deviation-completed: #95a5a6;
            
            /* Input Fields */
            --input-bg: #ffffff;
            --input-border: #ddd;
            --input-text: #333;
            
            /* Modal */
            --modal-bg: rgba(0,0,0,0.8);
            --modal-content-bg: #ffffff;
            
            /* Status Indicators */
            --status-ok: #27ae60;
            --status-nok: #e74c3c;
            --status-na: #95a5a6;

            /* Glass-Tints  */
            --audit-et-glass: #3498db;
            --audit-mt-glass: #e74c3c;
            --audit-ne-glass: #2ecc71;
            --audit-ut-glass: #9b59b6;
            --audit-cloud-glass: #d35400;       /* dunkleres Orange */
            --audit-deviations-glass: #c0392b;  /* dunkleres Rot */
        }
        
html[data-theme="dark"] {
                /* Dark Mode Variablen */
                --bg-primary: #121212;
                --bg-secondary: #1e1e1e;
                --bg-tertiary: #2d2d2d;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --text-tertiary: #ffffff;   /* NICHT blau */
                --border-color: #444444;
                --border-light: #333333;
                --shadow-color: rgba(0,0,0,0.3);
                
                /* Header */
                --header-border: #1f2a66;
                --header-bg: #2c3e50;
                
                /* Buttons - Darker versions */
                --btn-back: #5d6d7e;
                --btn-report: #6c3483;
                --btn-danger: #c0392b;
                --btn-info: #117a8b;
                --btn-desktop: #b9770e; /* unbenutzt, kann bleiben */
                --btn-success: #229954;
                --btn-warning: #b9770e;
                --btn-export: #2874a6;
                --btn-import: #7d3c98;
                --btn-cloud: #16a085;
                --btn-audits: #6c3483;
                --btn-deviations: #c0392b;
                --btn-pdf: #c0392b;
                
                /* Audit Buttons - Darker */
                --audit-et: #2874a6;
                --audit-mt: #c0392b;
                --audit-ne: #239b56;
                --audit-ut: #7d3c98;
                --audit-cloud: #e67e22;
                --audit-deviations: #c0392b;
                
                /* Progress */
                --progress-bg: #34495e;
                --progress-100: #27ae60;
                --progress-75: #2ecc71;
                --progress-50: #f39c12;
                --progress-25: #e67e22;
                --progress-0: #c0392b;
                
                /* Questions */
                --question-border: #3498db;
                --question-bg: #2d2d2d;
                --points-0: #e74c3c;
                --points-4: #f39c12;
                --points-8: #2ecc71;
                --points-10: #27ae60;
                --points-na: #7f8c8d;
                
                /* Deviation */
                --deviation-bg: #3a1f1f;
                --deviation-border: #c0392b;
                --deviation-open: #c0392b;
                --deviation-closed: #229954;
                --deviation-completed: #5d6d7e;
                
                /* Input Fields */
                --input-bg: #2d2d2d;
                --input-border: #444444;
                --input-text: #e0e0e0;
                
                /* Modal */
                --modal-bg: rgba(0,0,0,0.9);
                --modal-content-bg: #1e1e1e;
                
                /* Status Indicators */
                --status-ok: #27ae60;
                --status-nok: #e74c3c;
                --status-na: #7f8c8d;

                /* Glass-Tints (Dark) */
                --audit-et-glass: #2874a6E6;
                --audit-mt-glass: #c0392bE6;
                --audit-ne-glass: #239b56E6;
                --audit-ut-glass: #7d3c98E6;
                --audit-cloud-glass: #e67e22E6;
                --audit-deviations-glass: #c0392bE6;
            }
/* Fallback: wenn KEIN data-theme gesetzt ist -> System Dark nutzen */
@media (prefers-color-scheme: dark) {
  :root:not([data-theme]) {
    /* Dark Mode Variablen (identisch wie oben) */
    --bg-primary: #121212;
    --bg-secondary: #1e1e1e;
    --bg-tertiary: #2d2d2d;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --text-tertiary: #ffffff;
    --border-color: #444444;
    --border-light: #333333;
    --shadow-color: rgba(0,0,0,0.3);

    --header-border: #ffffff;
    --header-bg: #2c3e50;

    --btn-back: #5d6d7e;
    --btn-report: #6c3483;
    --btn-danger: #c0392b;
    --btn-info: #117a8b;
    --btn-desktop: #b9770e;
    --btn-success: #229954;
    --btn-warning: #b9770e;
    --btn-export: #2874a6;
    --btn-import: #7d3c98;
    --btn-cloud: #16a085;
    --btn-audits: #6c3483;
    --btn-deviations: #c0392b;
    --btn-pdf: #c0392b;

    --audit-et: #2874a6;
    --audit-mt: #c0392b;
    --audit-ne: #239b56;
    --audit-ut: #7d3c98;
    --audit-cloud: #e67e22;
    --audit-deviations: #c0392b;

    --progress-bg: #34495e;
    --progress-100: #27ae60;
    --progress-75: #2ecc71;
    --progress-50: #f39c12;
    --progress-25: #e67e22;
    --progress-0: #c0392b;

    --question-border: #3498db;
    --question-bg: #2d2d2d;
    --points-0: #e74c3c;
    --points-4: #f39c12;
    --points-8: #2ecc71;
    --points-10: #27ae60;
    --points-na: #7f8c8d;

    --deviation-bg: #3a1f1f;
    --deviation-border: #c0392b;
    --deviation-open: #c0392b;
    --deviation-closed: #229954;
    --deviation-completed: #5d6d7e;

    --input-bg: #2d2d2d;
    --input-border: #444444;
    --input-text: #e0e0e0;

    --modal-bg: rgba(0,0,0,0.9);
    --modal-content-bg: #1e1e1e;

    --status-ok: #27ae60;
    --status-nok: #e74c3c;
    --status-na: #7f8c8d;

    --audit-et-glass: #2874a6E6;
    --audit-mt-glass: #c0392bE6;
    --audit-ne-glass: #239b56E6;
    --audit-ut-glass: #7d3c98E6;
    --audit-cloud-glass: #e67e22E6;
    --audit-deviations-glass: #c0392bE6;
  }
}
        
        /* === ALLE EXISTIERENDEN STYLES === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            padding: 6px;
            font-size: 14px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            position: relative; /* Theme Toggle innerhalb der Containerkarte */
        }
        
        header {
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--header-border);
        }
        
        h1 {
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-size: 1.3em;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

/* Theme Toggle - Vereinfacht mit konstante Moon/Sun Emoji */
.theme-toggle {
  position: fixed;
  right: 16px;
  bottom: 16px;
  z-index: 900;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: 1px solid #ccc;
  background: var(--toggle-bg, #ffffff);
  color: var(--toggle-text, #333333);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  font-size: 18px;
  transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
}

.theme-toggle:hover {
  transform: translateY(-1px);
  background: var(--toggle-bg-hover, #f9fafb);
}

.theme-toggle:active { 
  transform: translateY(0); 
}

/* Dark Theme Variablen */
[data-theme="dark"] .theme-toggle {
  --toggle-bg: #2d2d2d;
  --toggle-text: #e0e0e0;
  --toggle-bg-hover: #333333;
  border-color: #444;
}

/* Light Theme Variablen */
[data-theme="light"] .theme-toggle {
  --toggle-bg: #ffffff;
  --toggle-text: #333333;
  --toggle-bg-hover: #f9fafb;
  border-color: #ccc;
}
        /* === MEHR KONTRAST FÜR STARTSEITE-KACHELN === */
        .audit-btn.glass {
          border: 2px solid rgba(255,255,255,0.38) !important;
          box-shadow: 0 10px 22px rgba(0,0,0,0.22) !important;
        }
/* App-Theme Light (unabhängig vom Browser/OS Theme) */
html[data-theme="light"] .audit-btn.glass {
  border-color: rgba(0,0,0,0.38) !important;
  box-shadow:
    0 12px 26px rgba(0,0,0,0.22),
    0 0 0 1px rgba(255,255,255,0.35) inset !important;
}

/* Glanz/Overlay etwas dezenter */
html[data-theme="light"] .audit-buttons .audit-btn.glass::before {
  opacity: 0.65;
}

/* Prozent/Status wieder WEISS (wie gewünscht) */
html[data-theme="light"] .audit-btn .btn-progress {
  background: rgba(0,0,0,0.22) !important;   /* dunkler Chip -> weiß lesbar */
  color: #fff !important;
  font-weight: 900 !important;
  border: 1px solid rgba(255,255,255,0.35) !important;
}
        /* === KONTROLLELEMENTE MIT SCROLLBAR === */
        .controls-container {
            width: 100%;
            margin-bottom: 6px;
        }
        
        .controls-scroll {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--bg-tertiary);
        }
        
        .controls-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .controls-scroll::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        
        .controls-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .controls-scroll button {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75em;
            min-height: 30px;
            min-width: 70px;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .btn-back { background: var(--btn-back); color: white; }
        .btn-report { background: var(--btn-report); color: white; }
        .btn-danger { background: var(--btn-danger); color: white; }
        .btn-info { background: var(--btn-info); color: white; }
        .btn-success { background: var(--btn-success); color: white; }
        .btn-cloud { background: var(--btn-cloud); color: white; }
        .btn-pdf { background: var(--btn-pdf); color: white; }
        
        button:hover { 
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* === MODAL STYLES === */
        .cloud-modal,
        .deviations-modal,
        .image-modal,
        .pdf-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .cloud-modal-content,
        .deviations-modal-content,
        .image-modal-content,
        .pdf-modal-content {
            background: var(--modal-content-bg);
            padding: 25px;
            border-radius: 10px;
            max-width: 95%;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            min-width: 300px;
        }
        
        .image-modal-content {
            max-width: 90%;
            width: auto;
            padding: 15px;
        }
        
        .image-modal-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            border: 2px solid var(--border-color);
        }

        /* Tabellen Layout für Cloud Audits und Abweichungen */
        .audits-table,
        .deviations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            table-layout: fixed;
        }

        .audits-table thead,
        .deviations-table thead {
            background: var(--header-bg);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Alle Header zentrieren */
        .audits-table th,
        .deviations-table th {
            padding: 12px 10px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid var(--header-border);
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Alle Zellen zentrieren */
        .audits-table td,
        .deviations-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
            height: 60px;
            overflow: hidden;
            text-align: center;
        }

        /* Spaltenbreiten für Cloud Audits */
        .audits-table th:nth-child(1),
        .audits-table td:nth-child(1) {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        .audits-table th:nth-child(2),
        .audits-table td:nth-child(2) {
            width: 180px;
            min-width: 180px;
            max-width: 180px;
            text-align: left;
        }

        .audits-table th:nth-child(3),
        .audits-table td:nth-child(3) {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            text-align: left;
        }

        .audits-table th:nth-child(4),
        .audits-table td:nth-child(4) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .audits-table th:nth-child(5),
        .audits-table td:nth-child(5) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .audits-table th:nth-child(6),
        .audits-table td:nth-child(6) {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
        }

        .audits-table th:nth-child(7),
        .audits-table td:nth-child(7) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .audits-table th:nth-child(8),
        .audits-table td:nth-child(8) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .audits-table th:nth-child(9),
        .audits-table td:nth-child(9) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        /* Spaltenbreiten für Abweichungen */
        .deviations-table th:nth-child(1),
        .deviations-table td:nth-child(1) {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        .deviations-table th:nth-child(2),
        .deviations-table td:nth-child(2) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            text-align: left;
        }

        .deviations-table th:nth-child(3),
        .deviations-table td:nth-child(3) {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            text-align: left;
        }

        .deviations-table th:nth-child(4),
        .deviations-table td:nth-child(4) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            text-align: left;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .deviations-table th:nth-child(5),
        .deviations-table td:nth-child(5) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            text-align: left;
        }

        .deviations-table th:nth-child(6),
        .deviations-table td:nth-child(6) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .deviations-table th:nth-child(7),
        .deviations-table td:nth-child(7) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .deviations-table th:nth-child(8),
        .deviations-table td:nth-child(8) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        /* Spezifische Zentrierung für verschiedene Elemente */
        .audit-type-cell,
        .deviation-type-cell {
            text-align: center;
            padding: 5px !important;
        }

        .audit-type-icon,
        .deviation-type-icon {
            font-size: 1.8em;
            display: block;
            margin: 0 auto;
            text-align: center;
        }

        .audit-title-cell,
        .deviation-audit-cell {
            text-align: left;
            padding-left: 10px;
        }

        /* Abweichungstext mit Zeilenumbruch */
        .deviation-text-cell {
            text-align: left;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
            font-size: 0.9em;
        }

        .department-badge-centered,
        .responsible-badge-centered {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 80px;
            max-width: 200px;
            margin: 0 auto;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .responsible-badge-centered {
            max-width: 300px;
            text-align: left;
            white-space: normal;
            word-wrap: break-word;
        }

        .year-badge-centered,
        .date-badge-centered {
            background: #2ecc71;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 700;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            margin: 0 auto;
        }

        .progress-circle-centered {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            margin: 0 auto;
            color: white;
        }

        .progress-high { background: #2ecc71; }
        .progress-medium { background: #f39c12; }
        .progress-low { background: #e74c3c; }

        .standards-centered {
            text-align: center;
            padding: 8px 5px;
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .date-centered {
            text-align: center;
            padding: 5px;
        }

        .date-main {
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 0.9em;
            display: block;
            text-align: center;
        }

        .date-time {
            font-size: 0.8em;
            color: var(--text-secondary);
            opacity: 0.8;
            display: block;
            text-align: center;
        }

        .actions-centered {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            width: fit-content;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 40px;
            justify-content: center;
        }

        .action-btn.open {
            background: var(--audit-cloud);
            color: white;
        }

        .action-btn.delete {
            background: var(--btn-danger);
            color: white;
        }

        .action-btn.complete {
            background: var(--btn-success);
            color: white;
        }

        .action-btn.image {
            background: #3498db;
            color: white;
        }

        .action-btn.view {
            background: var(--btn-info);
            color: white;
        }

        .action-btn.pdf {
            background: var(--btn-pdf);
            color: white;
        }

        /* Status Badge für Abweichungen */
        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 90px;
            margin: 0 auto;
        }

        .status-open {
            background: var(--deviation-open);
            color: white;
        }

        .status-closed {
            background: var(--deviation-closed);
            color: white;
        }

        .status-completed {
            background: var(--deviation-completed);
            color: white;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .filter-btn.active {
            background: var(--btn-info);
            color: white;
            border-color: var(--btn-info);
        }

        /* Mobile Anpassungen */
        @media (max-width: 768px) {
            .audits-table,
            .deviations-table {
                display: table;
                width: 100%;
                min-width: 1000px;
            }
            
            .audits-table thead,
            .deviations-table thead {
                display: table-header-group;
            }
            
            .audits-table tbody tr,
            .deviations-table tbody tr {
                display: table-row;
                margin-bottom: 0;
                border: none;
                border-radius: 0;
                padding: 0;
                text-align: left;
            }
            
            .audits-table td,
            .deviations-table td {
                display: table-cell;
                width: auto !important;
                border: 1px solid var(--border-light);
                padding: 8px 5px;
                height: auto;
                text-align: center;
            }
            
            .audits-table td:before,
            .deviations-table td:before {
                display: none;
            }
            
            .audits-table-container,
            .deviations-table-container {
                overflow-x: auto;
                overflow-y: hidden;
                max-height: 70vh;
                -webkit-overflow-scrolling: touch;
            }
            
            .audits-table,
            .deviations-table {
                table-layout: auto;
            }
            
            .audits-table th,
            .audits-table td,
            .deviations-table th,
            .deviations-table td {
                padding: 6px 4px;
                font-size: 0.8em;
            }
            
            .controls-scroll button {
                min-width: 60px;
                font-size: 0.7em;
                padding: 4px 6px;
            }
        }
        
        .cloud-modal h3,
        .deviations-modal h3 {
            margin-bottom: 15px;
            color: var(--text-tertiary);
            text-align: center;
        }

        /* Cloud Button Wrapper */
        .cloud-button-wrapper,
        .deviations-button-wrapper {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            text-align: center;
            width: 100%;
        }

        .cloud-button-wrapper .audit-btn,
        .deviations-button-wrapper .audit-btn {
            width: 80%;
            max-width: 500px;
            min-width: 250px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90px;
            transition: all 0.3s ease;
        }

        .cloud-button-wrapper .audit-btn {
            background: var(--audit-cloud);
        }

        .deviations-button-wrapper .audit-btn {
            background: var(--audit-deviations);
        }

        .cloud-button-wrapper .audit-btn .btn-icon,
        .deviations-button-wrapper .audit-btn .btn-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .cloud-button-wrapper .audit-btn span,
        .deviations-button-wrapper .audit-btn span {
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 5px;
        }
/* Responsive Anpassungen */
        @media (max-width: 768px) {
            .cloud-button-wrapper,
            .deviations-button-wrapper {
                margin-top: 20px;
                padding-top: 15px;
            }
            
            .cloud-button-wrapper .audit-btn,
            .deviations-button-wrapper .audit-btn {
                width: 90%;
                max-width: 350px;
                min-width: 200px;
                padding: 12px 15px;
                min-height: 80px;
            }
            
            .cloud-button-wrapper .audit-btn .btn-icon,
            .deviations-button-wrapper .audit-btn .btn-icon {
                font-size: 1.6em;
            }
            
            .cloud-button-wrapper .audit-btn span,
            .deviations-button-wrapper .audit-btn span {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .cloud-button-wrapper .audit-btn,
            .deviations-button-wrapper .audit-btn {
                width: 95%;
                max-width: 300px;
                min-width: 180px;
                padding: 10px 12px;
                min-height: 75px;
            }
            
            .cloud-button-wrapper .audit-btn .btn-icon,
            .deviations-button-wrapper .audit-btn .btn-icon {
                font-size: 1.5em;
            }
        }

        /* === DRUCK-STYLES FÜR DEN BERICHT === */
        @media print {
            body * {
                visibility: hidden;
            }
            .report-container, .report-container * {
                visibility: visible;
            }
            .report-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
        }

        /* === REST DER EXISTIERENDEN STYLES === */
        .audit-selection {
            text-align: center;
            margin: 15px 0;
        }
        
        .audit-selection h2 {
            color: var(--text-tertiary);
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        .audit-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .audit-btn {
            padding: 12px 8px;
            background: var(--audit-et);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .audit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
.audit-btn:focus-visible {
  outline: 3px solid rgba(0, 120, 255, 0.6);
  outline-offset: 3px;
}
        
        .audit-btn.wirbelstrom { background: var(--audit-et); }
        .audit-btn.magnetpulver { background: var(--audit-mt); }
        .audit-btn.nital { background: var(--audit-ne); }
        .audit-btn.ultraschall { background: var(--audit-ut); }
        .audit-btn.cloud { background: var(--audit-cloud); }
        .audit-btn.deviations { background: var(--audit-deviations); }
        
        .audit-btn .btn-icon {
            font-size: 1.6em;
            margin-bottom: 6px;
        }
        
        .audit-btn .btn-progress {
            margin-top: 4px;
            font-size: 0.7em;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 35px;
        }

        .participants-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--btn-export);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .participants-section h3 {
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-align: center;
            font-size: 0.9em;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .participant-group {
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            transition: background-color 0.3s ease;
        }
        
        .participant-group h4 {
            color: var(--text-tertiary);
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 3px;
            font-size: 0.8em;
        }
        
        .participant-input-container {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .participant-input {
            flex: 1;
            padding: 4px 5px;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.8em;
            background: var(--input-bg);
            color: var(--input-text);
        }
        
        .add-participant {
            background: var(--btn-success);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.65em;
            width: 24px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .participant-list {
            margin-top: 5px;
            max-height: 80px;
            overflow-y: auto;
            font-size: 0.75em;
        }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .remove-participant {
            background: var(--btn-danger);
            color: white;
            border: none;
            padding: 1px 5px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.7em;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audit-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.8em;
            background: var(--bg-tertiary);
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            flex-wrap: wrap;
        }
        
        .audit-status span {
            flex: 1;
            text-align: center;
            min-width: 100px;
            margin: 2px 0;
        }
        
        .audit-progress-container {
            margin: 10px 0;
            background: var(--progress-bg);
            border-radius: 5px;
            height: 10px;
            overflow: hidden;
        }
        
        .audit-progress-bar {
            height: 100%;
            background: var(--progress-100);
            border-radius: 5px;
            transition: width 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.5em;
            font-weight: bold;
        }

        .section {
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section-header {
            background: var(--header-bg);
            color: white;
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header:hover {
            background: var(--header-border);
        }
        
        .section-header h2 { 
            margin: 0; 
            font-size: 1em;
        }
        
        .section-header span {
            transition: transform 0.3s;
        }
        
        .section.expanded .section-header span {
            transform: rotate(90deg);
        }
        
        .section-content {
            padding: 8px;
            display: none;
        }
        
        .section.expanded .section-content { 
            display: block; 
        }

        .question {
            margin-bottom: 8px;
            padding: 10px;
            background: var(--question-bg);
            border-radius: 4px;
            border-left: 3px solid var(--question-border);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .question-text { 
            flex: 1; 
            font-weight: 500;
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        .question-id {
            background: var(--question-border);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 8px;
            white-space: nowrap;
        }
        
        .points-options {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .points-option {
            flex: 1;
            min-width: 40px;
            padding: 6px 2px;
            border: 2px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .points-option.selected { background: var(--question-border); color: white; }
        .points-option[data-points="0"] { border-color: var(--points-0); color: var(--points-0); }
        .points-option[data-points="0"].selected { background: var(--points-0); color: white; }
        .points-option[data-points="4"] { border-color: var(--points-4); color: var(--points-4); }
        .points-option[data-points="4"].selected { background: var(--points-4); color: #333; }
        .points-option[data-points="8"] { border-color: var(--points-8); color: var(--points-8); }
        .points-option[data-points="8"].selected { background: var(--points-8); color: white; }
        .points-option[data-points="10"] { border-color: var(--points-10); color: var(--points-10); }
        .points-option[data-points="10"].selected { background: var(--points-10); color: white; }
        
        .points-display {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            padding: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
        }
        
        .evidence {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 0.85em;
            background: var(--input-bg);
            color: var(--input-text);
        }
        
        .deviation-section {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background-color: var(--deviation-bg);
            border-radius: 3px;
            border-left: 3px solid var(--deviation-border);
        }
        
        .deviation-section h4 { 
            color: var(--deviation-border); 
            margin-bottom: 5px; 
            font-size: 0.85em;
        }
        
        .deviation-field, .responsible-field {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--deviation-border);
            border-radius: 3px;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 0.85em;
            background: var(--input-bg);
            color: var(--input-text);
        }
        
        .responsible-field { border-color: var(--input-border); min-height: auto; }
        
        .image-upload { margin-bottom: 8px; }
        
        .file-input-wrapper { position: relative; display: inline-block; margin-top: 5px; }
        
        .file-input-label {
            display: inline-block;
            padding: 5px 8px;
            background: var(--question-border);
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            display: none;
        }
        
        .remove-image {
            background: var(--btn-danger);
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.75em;
        }

        .mobile-view .participants-section { padding: 8px; margin-bottom: 8px; }
        
        .mobile-participant-type { display: flex; gap: 4px; margin-bottom: 4px; }
        
        .mobile-participant-type-btn {
            flex: 1;
            padding: 4px;
            border: 1px solid var(--question-border);
            border-radius: 3px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            font-size: 0.7em;
        }
        
        .mobile-participant-type-btn.active { background: var(--question-border); color: white; }
        
        .mobile-participant-input-container { display: flex; gap: 4px; margin-bottom: 6px; }
        
        .mobile-participant-input {
            flex: 1;
            padding: 4px 5px;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            font-size: 0.8em;
            background: var(--input-bg);
            color: var(--input-text);
        }
        
        .mobile-add-participant {
            background: var(--btn-success);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
        }

        .mobile-nav { display: flex; justify-content: space-between; margin-top: 10px; align-items: center; }
        .mobile-nav button { padding: 6px 10px; font-size: 0.8em; min-width: 80px; border: none; border-radius: 4px; background: var(--btn-back); color: white; cursor: pointer; }
        #mobileCounter { font-size: 0.85em; padding: 0 10px; text-align: center; font-weight: bold; }

        .mobile-section-selector { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 8px; }
        .section-btn { flex: 1; min-width: 60px; font-size: 0.7em; padding: 4px 5px; text-align: center; border: none; border-radius: 3px; background: var(--question-border); color: white; }

        .evaluation { display: none; margin-top: 12px; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; background: var(--bg-secondary); }
        .evaluation.active { display: block; }
        .evaluation h2 { font-size: 1em; margin-bottom: 8px; color: var(--text-tertiary); }

        .desktop-view { display: block; }
        .mobile-view { display: none; }
        .audit-content { display: none; }
        .audit-content.active { display: block; }
        .audit-selection { display: none; }
        .audit-selection.active { display: block; }

        footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .creator-info { font-weight: bold; color: var(--text-primary); margin-top: 4px; font-size: 0.9em; }
        .version-info { margin-top: 2px; font-size: 0.8em; color: var(--text-secondary); }

        /* Dark Mode Optimierungen */
        @media (prefers-color-scheme: dark) {
            .points-option[data-points="4"].selected { color: #1a1a1a !important; }
            .file-input-wrapper input[type="file"] { color: var(--text-primary); }
            .image-preview { background: #1a1a1a; }
            .remove-image:hover { background: #e74c3c; }
            .mobile-participant-type-btn { border-color: var(--border-color); }
        }

        @media (max-width: 768px) {
            body { padding: 5px; font-size: 13px; }
            .container { padding: 8px !important; }
            .desktop-view { display: none !important; }
            .mobile-view { display: block !important; }
            .audit-buttons { grid-template-columns: 1fr; gap: 6px; }
            .audit-btn { padding: 10px 6px; min-height: 70px; font-size: 0.85em; flex-direction: row; justify-content: flex-start; text-align: left; padding-left: 12px; }
            .audit-btn .btn-icon { font-size: 1.4em; margin-right: 8px; margin-bottom: 0; }
            .audit-btn .btn-progress { margin-left: auto; margin-top: 0; }
            .controls-container { margin-bottom: 6px; }
            .participants-grid { grid-template-columns: 1fr; gap: 6px; }
            .question { padding: 8px; }
            .question-text { font-size: 0.85em; }
            .question-id { font-size: 0.7em; margin-left: 5px; }
            .points-options { gap: 2px; }
            .points-option { min-width: 30px; padding: 4px 2px; font-size: 0.8em; }
            .mobile-nav button { min-width: 60px; padding: 5px 8px; }
            .mobile-section-selector { gap: 2px; }
            .section-btn { min-width: 50px; font-size: 0.65em; padding: 3px 4px; }
            .evidence, .deviation-field, .responsible-field { font-size: 0.8em; padding: 5px 6px; }
        }

        @media (max-width: 360px) {
            .container { padding: 6px !important; }
            .audit-btn { padding: 8px 5px; min-height: 60px; font-size: 0.8em; }
            .question-text { font-size: 0.8em; }
            .mobile-nav button { min-width: 50px; padding: 4px 6px; }
            #mobileCounter { font-size: 0.75em; }
        }
        
        @media (min-width: 769px) {
            body { font-size: 15px; }
            .container { padding: 15px; }
            .participants-section { padding: 12px; }
            .participant-input { padding: 6px 8px; font-size: 0.9em; }
            .question { padding: 12px; }
            .question-text { font-size: 1em; }
            .question-id { font-size: 0.85em; padding: 3px 8px; }
            .points-option { min-width: 45px; padding: 8px 2px; font-size: 1em; }
            .evidence, .deviation-field, .responsible-field { padding: 8px 10px; font-size: 0.9em; min-height: 45px; }
        }

        /* === GLASS-EFFECT: ALLE 6 KACHELN (ET/MT/NE/UT + Cloud + Abweichungen) === */
        .audit-buttons .audit-btn.glass {
          position: relative;
          color: #fff;
          border-radius: 10px;
          border: 1px solid rgba(255,255,255,0.35);
          border-right-color: rgba(255,255,255,0.25);
          border-bottom-color: rgba(255,255,255,0.25);
          box-shadow: 0 8px 18px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.25);
          transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
          isolation: isolate;
        }
        .audit-buttons .audit-btn.wirbelstrom.glass {
          background: linear-gradient(135deg, rgba(255,255,255,0.01), rgba(255,255,255,0.08)), linear-gradient(0deg, var(--audit-et-glass), var(--audit-et-glass));
        }
        .audit-buttons .audit-btn.magnetpulver.glass {
          background: linear-gradient(135deg, rgba(255,255,255,0.01), rgba(255,255,255,0.08)), linear-gradient(0deg, var(--audit-mt-glass), var(--audit-mt-glass));
        }
        .audit-buttons .audit-btn.nital.glass {
          background: linear-gradient(135deg, rgba(255,255,255,0.01), rgba(255,255,255,0.08)), linear-gradient(0deg, var(--audit-ne-glass), var(--audit-ne-glass));
        }
        .audit-buttons .audit-btn.ultraschall.glass {
          background: linear-gradient(135deg, rgba(255,255,255,0.01), rgba(255,255,255,0.08)), linear-gradient(0deg, var(--audit-ut-glass), var(--audit-ut-glass));
        }

        .cloud-button-wrapper .audit-btn.cloud.glass,
        .deviations-button-wrapper .audit-btn.deviations.glass {
          position: relative;
          color: #fff;
          border-radius: 12px;
          border: 1px solid rgba(255,255,255,0.1);
          border-right-color: rgba(255,255,255,0.1);
          border-bottom-color: rgba(255,255,255,0.1);
          box-shadow: 0 8px 18px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.25);
          transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
          isolation: isolate;
        }
        .cloud-button-wrapper .audit-btn.cloud.glass {
          background: linear-gradient(135deg, rgba(255,255,255,0.16), rgba(255,255,255,0.08)), linear-gradient(0deg, var(--audit-cloud-glass), var(--audit-cloud-glass));
        }
        .deviations-button-wrapper .audit-btn.deviations.glass {
          background: linear-gradient(135deg, rgba(255,255,255,0.16), rgba(255,255,255,0.08)), linear-gradient(0deg, var(--audit-deviations-glass), var(--audit-deviations-glass));
        }

        .audit-buttons .audit-btn.glass::before,
        .cloud-button-wrapper .audit-btn.cloud.glass::before,
        .deviations-button-wrapper .audit-btn.deviations.glass::before {
          content: "";
          position: absolute;
          inset: 2px 2px auto 2px;
          height: 45%;
          border-radius: 8px;
          background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.15));
          pointer-events: none;
        }

        .audit-buttons .audit-btn.glass:hover,
        .cloud-button-wrapper .audit-btn.cloud.glass:hover,
        .deviations-button-wrapper .audit-btn.deviations.glass:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 22px rgba(0,0,0,0.01), inset 0 1px 0 rgba(255,255,255,0.01);
        }
        .audit-buttons .audit-btn.glass:active,
        .cloud-button-wrapper .audit-btn.cloud.glass:active,
        .deviations-button-wrapper .audit-btn.deviations.glass:active {
          transform: translateY(0);
          box-shadow: 0 6px 14px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.25);
        }

        .audit-buttons .audit-btn.glass .btn-icon,
        .audit-buttons .audit-btn.glass span,
        .audit-buttons .audit-btn.glass .btn-progress,
        .cloud-button-wrapper .audit-btn.cloud.glass .btn-icon,
        .cloud-button-wrapper .audit-btn.cloud.glass span,
        .cloud-button-wrapper .audit-btn.cloud.glass .btn-progress,
        .deviations-button-wrapper .audit-btn.deviations.glass .btn-icon,
        .deviations-button-wrapper .audit-btn.deviations.glass span,
        .deviations-button-wrapper .audit-btn.deviations.glass .btn-progress {
          text-shadow: 0 1px 2px rgba(0,0,0,0.25);
        }
        .audit-buttons .audit-btn.glass .btn-progress,
        .cloud-button-wrapper .audit-btn.cloud.glass .btn-progress,
        .deviations-button-wrapper .audit-btn.deviations.glass .btn-progress {
          background: rgba(255,255,255,0.22);
          border-radius: 999px;
          padding: 2px 8px;
        }

        @supports ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))) {
          .audit-buttons .audit-btn.glass,
          .cloud-button-wrapper .audit-btn.cloud.glass,
          .deviations-button-wrapper .audit-btn.deviations.glass {
            backdrop-filter: blur(10px) saturate(140%);
            -webkit-backdrop-filter: blur(10px) saturate(140%);
          }
        }

        @media (prefers-color-scheme: dark) {
          .audit-buttons .audit-btn.glass,
          .cloud-button-wrapper .audit-btn.cloud.glass,
          .deviations-button-wrapper .audit-btn.deviations.glass {
            border-color: rgba(255,255,255,0.28);
            box-shadow: 0 8px 18px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08);
          }
          .audit-buttons .audit-btn.glass::before,
          .cloud-button-wrapper .audit-btn.cloud.glass::before,
          .deviations-button-wrapper .audit-btn.deviations.glass::before {
            background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.06));
          }
        }

        /* === Datenbalken (Punkte) für Cloud-Liste === */
        .points-bar {
          position: relative;
          width: 100%;
          height: 22px;
          background: #eceff1;
          border-radius: 6px;
          overflow: hidden;
        }
        .points-bar__fill {
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #ffffff;
          font-weight: 600;
          font-size: 12px;
          white-space: nowrap;
          transition: width 0.3s ease, background-color 0.3s ease;
          padding: 0 6px;
        }
        .points-bar__label--outside {
          position: absolute;
          left: 6px;
          top: 50%;
          transform: translateY(-50%);
          font-weight: 600;
          font-size: 12px;
          color: #1b1b1b;
          pointer-events: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPi8X4O6R2pPu8Q1V2VuJ28PSIP22sQ6rM9GKUvKBpU384j4Uo2nN1I6V7b1WJR1iZsZ/bxpJQXQ0xZbQ0g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ZfP Review Audit</h1>
            <div class="subtitle">IN_QP_29005</div>
        </header>

        <!-- CLOUD MODAL -->
        <div id="cloudModal" class="cloud-modal">
            <div class="cloud-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-light); padding-bottom: 15px;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">☁️</span>
                        <span>abgeschlossene Audits</span>
                    </h3>
                    <button onclick="closeCloudModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                
                <div id="auditsList" class="audits-list">
                    <!-- Audits werden hier geladen -->
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light);">
                    <button onclick="closeCloudModal()" style="padding: 10px 25px; background: var(--btn-back); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        ← Zurück zur Startseite
                    </button>
                </div>
            </div>
        </div>

        <!-- PDF MODAL -->
        <div id="pdfModal" class="pdf-modal">
            <div class="pdf-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-light); padding-bottom: 15px;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">📄</span>
                        <span>PDF Bericht</span>
                    </h3>
                    <button onclick="closePdfModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                
                <div id="pdfViewer" style="width: 100%; height: 70vh; border: 1px solid var(--border-color); border-radius: 5px;">
                    <!-- PDF wird hier angezeigt -->
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light);">
                    <button onclick="closePdfModal()" style="padding: 10px 25px; background: var(--btn-back); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        Schließen
                    </button>
                </div>
            </div>
        </div>

        <!-- ABWEICHUNGEN MODAL -->
        <div id="deviationsModal" class="deviations-modal">
            <div class="deviations-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-light); padding-bottom: 15px;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">⚠️</span>
                        <span>Abweichungen</span>
                    </h3>
                    <button onclick="closeDeviationsModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
<button class="filter-btn active" data-filter="all" onclick="filterDeviations('all')">Alle</button>
<button class="filter-btn" data-filter="open" onclick="filterDeviations('open')">Offen</button>
<button class="filter-btn" data-filter="completed" onclick="filterDeviations('completed')">Abgeschlossen</button>
                    <button class="filter-btn" onclick="syncDeviationsWithCloud()" title="Abweichungen mit Cloud synchronisieren" style="background: var(--btn-cloud); color: white;">
                        🔄 Sync
                    </button>
                </div>
                
                <div id="deviationsList" class="audits-list">
                    <!-- Abweichungen werden hier geladen -->
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light);">
                    <button onclick="closeDeviationsModal()" style="padding: 10px 25px; background: var(--btn-back); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        ← Zurück zur Startseite
                    </button>
                </div>
            </div>
        </div>

        <!-- BILD MODAL -->
        <div id="imageModal" class="image-modal">
            <div class="image-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Bildansicht</h3>
                    <button onclick="closeImageModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                <img id="modalImage" src="" alt="Bildansicht">
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="closeImageModal()" style="padding: 8px 20px; background: var(--btn-back); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Schließen
                    </button>
                </div>
            </div>
        </div>

        <!-- AUDIT AUSWAHL -->
        <div id="auditSelection" class="audit-selection active">
            <h2>Audit-Verfahren auswählen:</h2>
            <div class="audit-buttons">
                <button class="audit-btn wirbelstrom glass" data-audit="wirbelstrom">
                    <div class="btn-icon">⚡</div>
                    <span>Wirbelstromprüfung</span>
                    <div class="btn-progress" id="wirbelstromProgress">0%</div>
                </button>
                <button class="audit-btn magnetpulver glass" data-audit="magnetpulver">
                    <div class="btn-icon">🧲</div>
                    <span>Magnetpulverprüfung</span>
                    <div class="btn-progress" id="magnetpulverProgress">0%</div>
                </button>
                <button class="audit-btn nital glass" data-audit="nital">
                    <div class="btn-icon">🧪</div>
                    <span>Nital-Ätzen</span>
                    <div class="btn-progress" id="nitalProgress">0%</div>
                </button>
                <button class="audit-btn ultraschall glass" data-audit="ultraschall">
                    <div class="btn-icon">📡</div>
                    <span>Ultraschallprüfung</span>
                    <div class="btn-progress" id="ultraschallProgress">0%</div>
                </button>
            </div>
            
            <div class="cloud-button-wrapper">
                <button class="audit-btn cloud glass" onclick="openCloudModal()">
                    <div class="btn-icon">☁️</div>
                    <span>abgeschlossene Audits</span>
                    <div class="btn-progress" id="cloudProgress">0 Audits</div>
                </button>
            </div>
            
            <div class="deviations-button-wrapper">
                <button class="audit-btn deviations glass" onclick="openDeviationsModal()">
                    <div class="btn-icon">⚠️</div>
                    <span>Abweichungen</span>
                    <div class="btn-progress" id="deviationsProgress">0</div>
                </button>
            </div>
        </div>

        <!-- AUDIT CONTENT -->
        <div id="auditContent" class="audit-content">
            <!-- ALLE BUTTONS IN EINER ZEILE MIT SCROLL -->
            <div class="controls-container">
                <div class="controls-scroll">
                    <button class="btn-back" id="backBtn">← Zurück</button>
                    <button class="btn-report" id="reportBtn">📋 Drucken</button>
                    <button class="btn-danger" id="resetBtn">🗑️ Reset</button>
                    <button class="btn-info" id="evaluationBtn">📊 Auswertung</button>
                    <button class="btn-cloud" onclick="saveAuditToCloud()" title="In Cloud speichern">💾 Speichern</button>
                </div>
            </div>

            <!-- Desktop Teilnehmer -->
            <div class="participants-section desktop-view">
                <h3>📋 Teilnehmer</h3>
                <div class="participants-grid">
                    <div class="participant-group">
                        <h4>👨‍💼 Auditor</h4>
                        <div class="participant-input-container">
                            <input type="text" class="participant-input" id="auditorInput" placeholder="Name">
                            <button class="add-participant" onclick="addParticipant('auditor')">+</button>
                        </div>
                        <div class="participant-list" id="auditorList"></div>
                    </div>
                    <div class="participant-group">
                        <h4>👥 Auditiert</h4>
                        <div class="participant-input-container">
                            <input type="text" class="participant-input" id="auditeeInput" placeholder="Name">
                            <button class="add-participant" onclick="addParticipant('auditee')">+</button>
                        </div>
                        <div class="participant-list" id="auditeeList"></div>
                    </div>
                </div>
            </div>

            <!-- Mobile Teilnehmer -->
            <div class="participants-section mobile-view">
                <h3>📋 Teilnehmer</h3>
                <div class="mobile-participant-type">
                    <button class="mobile-participant-type-btn active" data-type="auditor">👨‍💼 Auditor</button>
                    <button class="mobile-participant-type-btn" data-type="auditee">👥 Auditiert</button>
                </div>
                <div class="mobile-participant-input-container">
                    <input type="text" class="mobile-participant-input" id="mobileParticipantInput" placeholder="Name">
                    <button class="mobile-add-participant" onclick="addMobileParticipant()">+</button>
                </div>
                <div class="participant-list" id="mobileParticipantList"></div>
            </div>

            <!-- Statusanzeige -->
            <div class="audit-status">
                <span class="status-part">Fortschritt: <strong id="progressText">0%</strong></span>
                <span class="separator"> </span>
                <span class="status-part">Frage <strong id="answeredCount">0</strong>/<strong id="totalCount">24</strong></span>
                <span class="separator"> </span>
                <span class="status-part"><strong id="pointsTotal">0</strong>/<strong id="pointsMax">240</strong> Punkte</span>
            </div>
            <div class="audit-progress-container">
                <div class="audit-progress-bar" id="auditProgressBar" style="width: 0%">0%</div>
            </div>

            <!-- Desktop Ansicht -->
            <div class="desktop-view" id="desktopView">
                <div id="auditSections"></div>
            </div>

            <!-- Mobile Ansicht -->
            <div class="mobile-view" id="mobileView">
                <div class="mobile-section-selector" id="sectionSelector"></div>
                <div id="mobileQuestions"></div>
                <div class="mobile-nav">
                    <button class="btn-secondary" id="prevBtn">← Zurück</button>
                    <span id="mobileCounter">Frage 1/1</span>
                    <button class="btn-secondary" id="nextBtn">Weiter →</button>
                </div>
            </div>

            <!-- Evaluation -->
            <div class="evaluation" id="evaluation">
                <h2>Auswertung</h2>
                <div id="evaluationContent"></div>
            </div>
        </div>

        <footer>
            <p>ZfP Review Audit &copy; 2026 Schaeffler Technologies AG & Co. KG</p>
            <div class="version-info">Version 00, 29.01.2026</div>
            <div class="creator-info">Ersteller: Daniel Häusner, WI/SW2-PQT</div>
        </footer>
    </div>

    <button id="themeToggleBtn" class="theme-toggle" title="Hell/Dunkel umschalten">🌓</button>

    <script>
        // === SUPABASE KONFIGURATION ===
        const SUPABASE_URL = 'https://agyktwyeahwrcsmaoibe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_fiPWCIMlRxbt3fy6DXf8iQ_JibUoEUo';
        const AUDIT_PASSWORD = 'ZfPOperatorAudit';

        // === GLOBALE VARIABLEN ===
        let currentAuditType = null;
        let currentAuditData = null;
        let allQuestions = [];
        let allQuestionElements = [];
        let currentMobileQuestion = 0;
        let imageStorage = {};
        let participants = { auditors: [], auditees: [] };
        let currentMobileParticipantType = 'auditor';
        let deviations = []; // Array für alle Abweichungen
        let currentDeviationFilter = 'all'; // Filter für Abweichungen

        // === KONSTANTEN UND DATENSTRUKTUREN ===
        const AUDIT_TYPES = {
            wirbelstrom: { id: 'wirbelstrom', title: 'Wirbelstromprüfung', short: 'ET', color: 'var(--audit-et)', icon: '⚡', standards: 'S245006-1 / S245008-1 / S245007-1 / S245012' },
            magnetpulver: { id: 'magnetpulver', title: 'Magnetpulverprüfung', short: 'MT', color: 'var(--audit-mt)', icon: '🧲', standards: 'S245008-2 / S245012' },
            nital: { id: 'nital', title: 'Nital-Ätzen', short: 'NE', color: 'var(--audit-ne)', icon: '🧪', standards: 'S245013-1 / S245012-1' },
            ultraschall: { id: 'ultraschall', title: 'Ultraschallprüfung', short: 'UT', color: 'var(--audit-ut)', icon: '📡', standards: 'S245009-3 / S245012' }
        };

        // === HELFER: DATUM & DARSTELLUNG ===
        function formatDateDMY(dateInput) {
            const d = new Date(dateInput);
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}.${mm}.${yyyy}`;
        }

        function deviationColorClass(count) {
            if (count === 0) return 'progress-high';
            if (count <= 5) return 'progress-medium';
            return 'progress-low';
        }

        function clamp01(x) {
            return Math.max(0, Math.min(1, x));
        }

        function pointsHue(points, max = 240) {
            const ratio = clamp01(max > 0 ? (points / max) : 0);
            return ratio * 120; // 0=rot, 60=gelb, 120=grün
        }

        function pointsColorHsl(points, max = 240) {
            const hue = pointsHue(points, max);
            return `hsl(${hue}, 90%, 45%)`;
        }

        function pointsWidthPct(points, max = 240) {
            return `${clamp01(max > 0 ? (points / max) : 0) * 100}%`;
        }

        // VOLLSTÄNDIGE AUDIT-DATEN
        const AUDIT_DATA = {
            wirbelstrom: [
                { title: "1.1 Personal und Qualifikation", short: "1.1 Personal", questions: [
                    { id: "1.1.1", text: "Ist der Level-2-Experte für die Wirbelstromprüfung qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "1.1.2", text: "Sind alle Bediener für die Wirbelstromprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "1.1.3", text: "Ist ein Verantwortlicher (Supervisor) für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                    { id: "1.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                ]},
                { title: "1.2 Ausrüstung und Plausibilitätsprüfung", short: "1.2 Ausrüstung", questions: [
                    { id: "1.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert?" },
                    { id: "1.2.2", text: "Wird die jährliche Überprüfung durchgeführt und dokumentiert?" },
                    { id: "1.2.3", text: "Wird die Maschine einschließlich relevanter Messgeräte in SAP überwacht? (Maschine, Restmagnetfeldmessgerät, Magnetfeldstärkemessgerät)" },
                    { id: "1.2.4", text: "Befindet sich die Maschine in einem guten technischen Zustand? (Software gemäß IATF, Hardware)" }
                ]},
                { title: "1.3 Prüfanweisungen", short: "1.3 Anweisungen", questions: [
                    { id: "1.3.1", text: "Ist die Prüfanweisung vollständig? (Parameter, Gerät, Sonde, Grenzwerte, Maßnahmen, Unterschrift eines Level-2-Prüfers)" },
                    { id: "1.3.2", text: "Ist der Prüfprozess im Control1- oder Prüfplan beschrieben?" },
                    { id: "1.3.3", text: "Existiert eine Prüfdokumentation, die Informationen über Prüfergebnisse und Prozessentscheidungen enthält (siehe 1.3.1)?" },
                    { id: "1.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                    { id: "1.3.5", text: "Sind die Messungen des Restmagnetismus im Prüfplan enthalten (falls erforderlich)?" }
                ]},
                { title: "1.4 Referenzteile S285066", short: "1.4 Referenzteile", questions: [
                    { id: "1.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                    { id: "1.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                    { id: "1.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                    { id: "1.4.4", text: "Werden die Referenzteile überwacht?" }
                ]},
                { title: "1.5 Prozess", short: "1.5 Prozess", questions: [
                    { id: "1.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähig?" },
                    { id: "1.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                    { id: "1.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                    { id: "1.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                    { id: "1.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                    { id: "1.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                    { id: "1.5.7", text: "Ist die Schutzausrüstung funktionsfähig und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                ]}
            ],
            magnetpulver: [
                { title: "2.1 Qualifikation", short: "2.1 Qualifikation", questions: [
                    { id: "2.1.1", text: "Ist der Level-2-Experte für Magnetpulverprüfung (MPI) qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "2.1.2", text: "Sind alle Bediener für die Magnetpulverprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "2.1.3", text: "Ist ein Verantwortlicher für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                    { id: "2.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                ]},
                { title: "2.2 Ausrüstung und Plausibilitätsprüfung", short: "2.2 Ausrüstung", questions: [
                    { id: "2.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert? (ASTM-Röhre, MTU Nr. 3)" },
                    { id: "2.2.2", text: "Wird die monatliche Überprüfung der UV-Lampe durchgeführt und dokumentiert?" },
                    { id: "2.2.3", text: "Wird die jährliche Überprüfung durchgeführt und dokumentiert?" },
                    { id: "2.2.4", text: "Wird die Maschine in SAP überwacht (Software gemäß IATF)?" },
                    { id: "2.2.5", text: "Sind die Magnetisierungswerte stabil?" },
                    { id: "2.2.6", text: "Werden die Messgeräte überwacht und in SAP geführt? (UV-Meter, Lux-Meter, Magnetfeldstärkemessgerät inkl. Referenzmagnet)" },
                    { id: "2.2.7", text: "Wird ein Restmagnetfeldmessgerät (Gaussmeter) verwendet? (Handhabung, Überwachung, SAP, Referenzblock)" },
                    { id: "2.2.8", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gemäß IATF, Hardware)" }
                ]},
                { title: "2.3 Prüfanweisungen", short: "2.3 Anweisungen", questions: [
                    { id: "2.3.1", text: "Ist die Prüfanweisung vollständik? (Parameter, Gerät, Grenzwerte, Maßnahmen, Unterschrift Level 2)" },
                    { id: "2.3.2", text: "Ist der Prüfprozess im Control- oder Prüfplan enthalten?" },
                    { id: "2.3.3", text: "Existiert eine Prüfdokumentation mit Ergebnissen und Prozessentscheidungen (siehe 1.3.1)?" },
                    { id: "2.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der neuesten Version vor?" },
                    { id: "2.3.5", text: "Sind Restmagnetismus-Messungen im Prüfplan enthalten (falls erforderlich)?" }
                ]},
                { title: "2.4 Referenzteile S285066", short: "2.4 Referenzteile", questions: [
                    { id: "2.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                    { id: "2.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                    { id: "2.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                    { id: "2.4.4", text: "Werden die Referenzteile überwacht?" }
                ]},
                { title: "2.5 Prozess", short: "2.5 Prozess", questions: [
                    { id: "2.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähig?" },
                    { id: "2.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                    { id: "2.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                    { id: "2.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                    { id: "2.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                    { id: "2.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                    { id: "2.5.7", text: "Ist die Schutzausrüstung funktionsfähig und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                ]}
            ],
            nital: [
                { title: "3.1 Qualifikation", short: "3.1 Qualifikation", questions: [
                    { id: "3.1.1", text: "Ist der Level-2-Experte für Nital-Ätzprüfung qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "3.1.2", text: "Sind alle Bediener für die Nital-Ätzprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "3.1.3", text: "Ist ein Verantwortlicher für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                    { id: "3.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                ]},
                { title: "3.2 Ausrüstung und Plausibilitätsprüfung", short: "3.2 Ausrüstung", questions: [
                    { id: "3.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert?" },
                    { id: "3.2.2", text: "Entspricht der Reinigungsprozess der Norm? (Parameter, Ultraschall)" },
                    { id: "3.2.3", text: "Entspricht der Ätzprozess der Norm? (Material, chemische Analyse, Überwachung)" },
                    { id: "3.2.4", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gemäß IATF, Hardware)" }
                ]},
                { title: "3.3 Prüfanweisungen", short: "3.3 Anweisungen", questions: [
                    { id: "3.3.1", text: "Ist die Prüfanweisung vollständig? (Parameter, Gerät, Grenzwerte, Maßnahmen, Unterschrift eines Level-2-Prüfers)" },
                    { id: "3.3.2", text: "Ist der Prüfprozess im Control- oder Prüfplan beschrieben?" },
                    { id: "3.3.3", text: "Existiert eine Prüfdokumentation, die Informationen über Prüfergebnisse und Prozessentscheidungen enthält?" },
                    { id: "3.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                    { id: "3.3.5", text: "Sind die Messungen des Restmagnetismus im Prüfplan enthalten (falls erforderlich)?" }
                ]},
                { title: "3.4 Referenzteile S285066", short: "3.4 Referenzteile", questions: [
                    { id: "3.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                    { id: "3.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                    { id: "3.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                    { id: "3.4.4", text: "Werden die Referenzteile überwacht?" }
                ]},
                { title: "3.5 Prozess", short: "3.5 Prozess", questions: [
                    { id: "3.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähig?" },
                    { id: "3.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                    { id: "3.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                    { id: "3.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                    { id: "3.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                    { id: "3.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                    { id: "3.5.7", text: "Ist die Schutzausrüstung funktionsfähik und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                ]}
            ],
            ultraschall: [
                { title: "4.1 Qualifikation", short: "4.1 Qualifikation", questions: [
                    { id: "4.1.1", text: "Ist der Level-2-Experte für Ultraschallprüfung (UT) qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "4.1.2", text: "Sind alle Bediener für die Ultraschallprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                    { id: "4.1.3", text: "Ist ein Verantwortlicher für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                    { id: "4.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                ]},
                { title: "4.2 Ausrüstung und Plausibilitätsprüfung", short: "4.2 Ausrüstung", questions: [
                    { id: "4.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert?" },
                    { id: "4.2.2", text: "Wird die jährliche Überprüfung durchgeführt und dokumentiert?" },
                    { id: "4.2.3", text: "Wird die Maschine einschließlich relevanter Messgeräte in SAP überwacht? (Maschine, Restmagnetfeldmessgerät, Magnetfeldstärkemessgerät, Software gemäß IATF)" },
                    { id: "4.2.4", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gemäß IATF, Hardware)" }
                ]},
                { title: "4.3 Prüfanweisungen", short: "4.3 Anweisungen", questions: [
                    { id: "4.3.1", text: "Ist die Prüfanweisung vollständig? (Parameter, Gerät, Grenzwerte, Maßnahmen, Unterschrift eines Level-2-Prüfers)" },
                    { id: "4.3.2", text: "Ist der Prüfprozess im Control- oder Prüfplan beschrieben?" },
                    { id: "4.3.3", text: "Existiert eine Prüfdokumentation, die Informationen über Prüfergebnisse und Prozessentscheidungen enthält?" },
                    { id: "4.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                    { id: "4.3.5", text: "Sind die Messungen des Restmagnetismus im Prüfplan enthalten (falls erforderlich)?" }
                ]},
                { title: "4.4 Referenzteile S285066", short: "4.4 Referenzteile", questions: [
                    { id: "4.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                    { id: "4.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                    { id: "4.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                    { id: "4.4.4", text: "Werden die Referenzteile überwacht?" }
                ]},
                { title: "4.5 Prozess", short: "4.5 Prozess", questions: [
                    { id: "4.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähik?" },
                    { id: "4.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                    { id: "4.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                    { id: "4.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                    { id: "4.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                    { id: "4.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                    { id: "4.5.7", text: "Ist die Schutzausrüstung funktionsfähik und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                ]}
            ]
        };
// === INITIALISIERUNG ===
        document.addEventListener('DOMContentLoaded', function() {
            initThemeToggle();
            initializeApp();
            setupEventListeners();
            loadDeviations(); // Lokale Abweichungen laden
            loadDeviationsFromCloud(); // Cloud-Abweichungen laden
        });

/* ========= THEME FUNKTIONEN ========= */
function getSavedTheme() {
  return localStorage.getItem('zfp_theme'); // 'light' | 'dark' | null
}

function updateToggleAppearance() {
  // Symbol bleibt immer gleich (🌓)
  const btn = document.getElementById('themeToggleBtn');
  if (!btn) return;
  btn.textContent = '🌓'; // Immer das gleiche Symbol
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const darkEl = document.getElementById('darkModeStyles');
  if (darkEl) {
    if (theme === 'dark') darkEl.media = 'all';
    else if (theme === 'light') darkEl.media = 'not all';
    else darkEl.media = '(prefers-color-scheme: dark)';
  }
  document.body.classList.toggle('dark-mode', theme === 'dark');
  document.body.classList.toggle('light-mode', theme === 'light');
  updateToggleAppearance(); // Symbol bleibt gleich, nur Hintergrund ändert sich
}

function initThemeToggle() {
  const saved = getSavedTheme();
  const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const initial = saved || (systemDark ? 'dark' : 'light');
  applyTheme(initial);
  
  const btn = document.getElementById('themeToggleBtn');
  if (btn) {
    btn.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || (systemDark ? 'dark' : 'light');
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('zfp_theme', next);
      applyTheme(next);
    });
  }
}
        
        function initializeApp() {
            loadAllAuditData();
            updateAuditProgressDisplays();
            loadActualAuditCountFromCloud();
        }

        // === ABWEICHUNGEN CLOUD-SYNCHRONISIERUNG ===
        function deviationBaseKey(dev) {
          return dev.audit_id || dev.auditNumber || dev.auditId;
        }
        function deviationKeyFromParts(base, questionId) {
          return `${base}__${questionId}`;
        }
        function deviationKey(dev) {
          const base = deviationBaseKey(dev);
          return deviationKeyFromParts(base, dev.questionId);
        }

        async function loadDeviationsFromCloud() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/deviations?select=*&order=updated_at.desc`,
                    { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                );
                if (!response.ok) return;
                const cloudDeviations = await response.json();

                const savedDeviations = localStorage.getItem('zfpAuditDeviations');
                const localDeviations = savedDeviations ? JSON.parse(savedDeviations) : [];

                const byKey = new Map();

                // Cloud priorisieren
                cloudDeviations.forEach(cd => {
                    const base = cd.audit_id;
                    const key = deviationKeyFromParts(base, cd.question_id);
                    const mergedDev = {
                        id: cd.id || key,
                        key,
                        cloudId: cd.id,
                        audit_id: cd.audit_id,
                        auditId: cd.audit_type || 'unknown',
                        auditTitle: cd.audit_title,
                        auditNumber: cd.audit_number,
                        department: cd.department,
                        questionId: cd.question_id,
                        questionText: cd.question_text,
                        deviationText: cd.deviation_text,
                        responsible: cd.responsible,
                        date: cd.date || cd.created_at,
                        status: cd.status || 'offen',
                        points: cd.points,
                        hasImage: cd.has_image || false,
                        imageData: cd.image_data,
                        completedAt: cd.completed_at,
                        completedBy: cd.completed_by,
                        reopenedAt: cd.reopened_at,
                        updatedAt: cd.updated_at || cd.created_at,
                        fromCloud: true
                    };
                    byKey.set(key, mergedDev);
                });

                // Lokal ergänzen (wenn nicht vorhanden)
                localDeviations.forEach(ld => {
                    const base = ld.audit_id || ld.auditNumber || ld.auditId;
                    const key = ld.key || deviationKeyFromParts(base, ld.questionId);
                    if (!byKey.has(key)) {
                        byKey.set(key, { ...ld, key });
                    }
                });

                deviations = Array.from(byKey.values());
                saveDeviations();
                updateDeviationsProgressDisplay();
            } catch (error) {
                console.error('Fehler beim Laden der Abweichungen:', error);
            }
        }

        async function syncDeviationsWithCloud() {
            try {
                await loadDeviationsFromCloud();

                const localToUpload = deviations.filter(d => !d.fromCloud && d.audit_id);

                if (localToUpload.length > 0) {
                    for (const deviation of localToUpload) {
                        await saveSingleDeviationToCloud(deviation);
                    }
                    alert(`✅ Synchronisierung abgeschlossen!\n\n${localToUpload.length} lokale Abweichungen hochgeladen.`);
                } else {
                    alert('✅ Synchronisierung abgeschlossen!\n\nKeine lokalen Abweichungen mit audit_id zu laden.');
                }

                displayDeviationsList();
            } catch (error) {
                console.error('Synchronisierungsfehler:', error);
                alert('❌ Fehler bei der Synchronisierung: ' + error.message);
            }
        }

        async function saveSingleDeviationToCloud(deviation) {
          try {
            const auditIdForCloud = deviation.audit_id || deviation.auditId;
            if (!auditIdForCloud) {
              throw new Error('Keine audit_id für Abweichung vorhanden');
            }

            const checkUrl = `${SUPABASE_URL}/rest/v1/deviations?audit_id=eq.${encodeURIComponent(auditIdForCloud)}&question_id=eq.${encodeURIComponent(deviation.questionId)}`;
            const checkResponse = await fetch(checkUrl, {
              headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            if (!checkResponse.ok) throw new Error(`Check fehlgeschlagen: ${checkResponse.status}`);
            const existing = await checkResponse.json();

            const deviationData = {
              audit_id: auditIdForCloud,
              audit_title: deviation.auditTitle,
              audit_number: deviation.auditNumber,
              department: deviation.department,
              question_id: deviation.questionId,
              question_text: deviation.questionText,
              deviation_text: deviation.deviationText,
              responsible: deviation.responsible,
              status: deviation.status || 'offen',
              points: deviation.points,
              has_image: deviation.hasImage || false,
              image_data: deviation.imageData,
              completed_at: deviation.completedAt,
              completed_by: deviation.completedBy,
              reopened_at: deviation.reopenedAt,
              password: AUDIT_PASSWORD,
              updated_at: new Date().toISOString()
            };

            if (existing.length > 0) {
              const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/deviations?id=eq.${existing[0].id}`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  'apikey': SUPABASE_KEY,
                  'Authorization': `Bearer ${SUPABASE_KEY}`,
                  'Prefer': 'return=representation'
                },
                body: JSON.stringify(deviationData)
              });
              if (!updateResponse.ok) {
                const txt = await updateResponse.text();
                throw new Error(`Update fehlgeschlagen: ${updateResponse.status} - ${txt}`);
              }
              const updated = await updateResponse.json();
              deviation.cloudId = updated?.[0]?.id || existing[0].id;
              deviation.fromCloud = true;
              saveDeviations();
              return true;
            } else {
              deviationData.created_at = new Date().toISOString();
              const createResponse = await fetch(`${SUPABASE_URL}/rest/v1/deviations`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'apikey': SUPABASE_KEY,
                  'Authorization': `Bearer ${SUPABASE_KEY}`,
                  'Prefer': 'return=representation'
                },
                body: JSON.stringify(deviationData)
              });
              if (!createResponse.ok) {
                const txt = await createResponse.text();
                throw new Error(`Insert fehlgeschlagen: ${createResponse.status} - ${txt}`);
              }
              const result = await createResponse.json();
              if (result && result[0]) {
                deviation.cloudId = result[0].id;
                deviation.fromCloud = true;
                saveDeviations();
              }
              return true;
            }
          } catch (error) {
            console.error('Fehler beim Speichern der Abweichung in Cloud:', error);
            throw error;
          }
        }

        async function deleteDeviationFromCloud(deviationId) {
            try {
                const deviation = deviations.find(d => d.id === deviationId);
                if (!deviation) {
                    console.log('Abweichung nicht gefunden');
                    return false;
                }
                if (deviation.cloudId) {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/deviations?id=eq.${deviation.cloudId}`, 
                        { method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }
                    );
                    if (!response.ok) throw new Error('Löschen aus Cloud fehlgeschlagen');
                }
                return true;
            } catch (error) {
                console.error('Fehler beim Löschen aus Cloud:', error);
                return false;
            }
        }

        // === ABWEICHUNGS-FUNKTIONEN (LOKAL) ===
        function loadDeviations() {
            const savedDeviations = localStorage.getItem('zfpAuditDeviations');
            deviations = savedDeviations ? JSON.parse(savedDeviations) : [];
            updateDeviationsProgressDisplay();
        }
        
        function saveDeviations() {
            localStorage.setItem('zfpAuditDeviations', JSON.stringify(deviations));
            updateDeviationsProgressDisplay();
        }
        
        function updateDeviationsProgressDisplay() {
            const openDeviationsCount = deviations.filter(d => d.status === 'offen').length;
            const totalDeviationsCount = deviations.length;
            const deviationsProgressElement = document.getElementById('deviationsProgress');
            if (deviationsProgressElement) {
                deviationsProgressElement.textContent = `${openDeviationsCount}/${totalDeviationsCount}`;
            }
        }
        
        function displayDeviationsList() {
            const container = document.getElementById('deviationsList');
            container.innerHTML = '';
            
            let filteredDeviations = deviations;
            if (currentDeviationFilter === 'open') filteredDeviations = deviations.filter(d => d.status === 'offen');
            else if (currentDeviationFilter === 'completed') filteredDeviations = deviations.filter(d => d.status === 'abgeschlossen');
            
            if (filteredDeviations.length === 0) {
                let message = currentDeviationFilter === 'all' ? 'Keine Abweichungen vorhanden'
                            : currentDeviationFilter === 'open' ? 'Keine offenen Abweichungen'
                            : 'Keine abgeschlossenen Abweichungen';
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${message}</div>
                        <div style="font-size: 0.9em;">${currentDeviationFilter === 'open' ? 'Alle Maßnahmen sind abgeschlossen' : 'Erfassen Sie Abweichungen in den Audits'}</div>
                    </div>
                `;
                return;
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'deviations-table-container';
            
            let tableHTML = `
                <table class="deviations-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Typ</th>
                            <th style="text-align: left;">Audit</th>
                            <th style="text-align: center;">Abteilung</th>
                            <th style="text-align: left;">Abweichung</th>
                            <th style="text-align: left;">Verantwortlicher</th>
                            <th style="text-align: center;">Datum</th>
                            <th style="text-align: center;">Status</th>
                            <th style="text-align: center;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredDeviations.forEach((deviation, index) => {
                const deviationDate = new Date(deviation.date);
                const formattedDate = formatDateDMY(deviationDate);
                
                const auditIcons = { wirbelstrom: '⚡', magnetpulver: '🧲', nital: '🧪', ultraschall: '📡', unknown: '📋' };
                
                let auditTitle = deviation.auditTitle || 'Unbekannt';
                if (auditTitle.length > 20) auditTitle = auditTitle.substring(0, 20) + '...';
                
                let deviationText = deviation.deviationText || '';
                
                let department = deviation.department || 'N/A';
                if (department.length > 15) department = department.substring(0, 15) + '...';
                
                let responsible = deviation.responsible || 'Nicht angegeben';
                
                let statusClass = 'status-open';
                let statusText = 'Offen';
                if (deviation.status === 'abgeschlossen') { statusClass = 'status-completed'; statusText = 'Abgeschlossen'; }
                
                tableHTML += `
                    <tr style="${deviation.status === 'abgeschlossen' ? 'background-color: var(--bg-tertiary); opacity: 0.8;' : ''}">
                        <td class="deviation-type-cell" data-label="Typ">
                            <div class="deviation-type-icon" title="${deviation.auditId}">
                                ${auditIcons[deviation.auditId] || '📋'}
                            </div>
                        </td>
                        
                        <td class="deviation-audit-cell" data-label="Audit" title="${deviation.auditTitle || 'Unbekannt'}">
                            <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;">
                                ${auditTitle}
                            </div>
                            <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 2px;">
                                ${deviation.questionId}
                            </div>
                            <div style="font-size: 0.7em; color: var(--text-secondary);">
                                ${deviation.auditNumber || ''}
                            </div>
                        </td>
                        
                        <td data-label="Abteilung" title="${deviation.department || ''}">
                            <div class="department-badge-centered">${department}</div>
                        </td>
                        
                        <td class="deviation-text-cell" data-label="Abweichung">
                            <div style="max-height: 100px; overflow-y: auto; padding-right: 5px;">
                                ${deviationText.replace(/\n/g, '<br>')}
                            </div>
                        </td>
                        
                        <td data-label="Verantwortlicher" title="${deviation.responsible || 'Nicht angegeben'}">
                            <div class="responsible-badge-centered">${responsible}</div>
                        </td>
                        
                        <td data-label="Datum">
                            <div class="date-badge-centered">${formattedDate}</div>
                        </td>
                        
                        <td data-label="Status">
                            <div class="status-badge ${statusClass}">${statusText}</div>
                        </td>
                        
                        <td data-label="Aktionen">
                            <div class="actions-centered">
${deviation.hasImage ? `<button onclick="viewDeviationImageByKey('${(deviation.key || deviation.id)}')" class="action-btn image" title="Bild ansehen">📷</button>` : ''}
${deviation.status === 'offen'
  ? `<button onclick="completeDeviationByKey('${(deviation.key || deviation.id)}')" class="action-btn complete" title="Als abgeschlossen markieren">✅</button>`
  : `<button onclick="reopenDeviationByKey('${(deviation.key || deviation.id)}')" class="action-btn open" title="Wieder öffnen">🔄</button>`}
<button onclick="deleteDeviationByKey('${(deviation.key || deviation.id)}')" class="action-btn delete" title="Abweichung löschen">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.9em; color: var(--text-secondary);">
                    ${filteredDeviations.length} Abweichung${filteredDeviations.length !== 1 ? 'en' : ''} 
                    (${deviations.filter(d => d.status === 'offen').length} offen, 
                    ${deviations.filter(d => d.status === 'abgeschlossen').length} abgeschlossen)
                </div>
            `;
            
            tableContainer.innerHTML = tableHTML;
            container.appendChild(tableContainer);
        }
        
function filterDeviations(filter) {
    currentDeviationFilter = filter;

    document.querySelectorAll('.filter-controls .filter-btn[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
    });

    displayDeviationsList();
}

function findDeviationIndexByKeyOrId(keyOrId) {
    return deviations.findIndex(d => (d.key && d.key === keyOrId) || d.id === keyOrId);
}
async function completeDeviationByKey(keyOrId) {
    const idx = findDeviationIndexByKeyOrId(keyOrId);
    if (idx < 0) return alert('Abweichung nicht gefunden');

    deviations[idx].status = 'abgeschlossen';
    deviations[idx].completedAt = new Date().toISOString();
    deviations[idx].completedBy = participants.auditors[0] || 'Unbekannt';
    await saveSingleDeviationToCloud(deviations[idx]);
    saveDeviations();
    displayDeviationsList();
    alert('✅ Abweichung wurde als abgeschlossen markiert!');
}

async function reopenDeviationByKey(keyOrId) {
    const idx = findDeviationIndexByKeyOrId(keyOrId);
    if (idx < 0) return alert('Abweichung nicht gefunden');

    deviations[idx].status = 'offen';
    deviations[idx].reopenedAt = new Date().toISOString();
    await saveSingleDeviationToCloud(deviations[idx]);
    saveDeviations();
    displayDeviationsList();
    alert('🔄 Abweichung wurde wieder geöffnet!');
}

async function deleteDeviationByKey(keyOrId) {
    if (!confirm('Sind Sie sicher, dass Sie diese Abweichung löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden.')) return;

    const pw = prompt('Bitte Passwort eingeben, um die Abweichung zu löschen:');
    if (pw !== 'ZfP-Review') {
        alert('❌ Falsches Passwort. Löschvorgang abgebrochen.');
        return;
    }

    const idx = findDeviationIndexByKeyOrId(keyOrId);
    if (idx < 0) return alert('Abweichung nicht gefunden');

    await deleteDeviationFromCloud(deviations[idx].id);
    deviations.splice(idx, 1);
    saveDeviations();
    displayDeviationsList();
    alert('✅ Abweichung wurde gelöscht!');
}       
function viewDeviationImageByKey(keyOrId) {
    const idx = findDeviationIndexByKeyOrId(keyOrId);
    if (idx < 0) return alert('Abweichung nicht gefunden');

    const deviation = deviations[idx];
    if (deviation.imageData) {
        document.getElementById('modalImage').src = deviation.imageData;
        document.getElementById('imageModal').style.display = 'flex';
    } else {
        alert('Kein Bild für diese Abweichung vorhanden');
    }
}
        
        async function completeDeviation(index) {
            if (index >= 0 && index < deviations.length) {
                deviations[index].status = 'abgeschlossen';
                deviations[index].completedAt = new Date().toISOString();
                deviations[index].completedBy = participants.auditors[0] || 'Unbekannt';
                await saveSingleDeviationToCloud(deviations[index]);
                saveDeviations();
                displayDeviationsList();
                alert('✅ Abweichung wurde als abgeschlossen markiert!');
            }
        }
        
        async function reopenDeviation(index) {
            if (index >= 0 && index < deviations.length) {
                deviations[index].status = 'offen';
                deviations[index].reopenedAt = new Date().toISOString();
                await saveSingleDeviationToCloud(deviations[index]);
                saveDeviations();
                displayDeviationsList();
                alert('🔄 Abweichung wurde wieder geöffnet!');
            }
        }
        
        async function deleteDeviation(index) {
            if (confirm('Sind Sie sicher, dass Sie diese Abweichung löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden.')) {
                if (index >= 0 && index < deviations.length) {
                    await deleteDeviationFromCloud(deviations[index].id);
                    deviations.splice(index, 1);
                    saveDeviations();
                    displayDeviationsList();
                    alert('✅ Abweichung wurde gelöscht!');
                }
            }
        }

        // === REPORT FUNKTIONEN ===
        function generateReport() {
            if (!currentAuditType || !currentAuditData) {
                alert("Bitte zuerst ein Audit auswählen und Daten eingeben!");
                return;
            }
            saveCurrentAuditData();
            const reportHtml = createReportHTML();
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(reportHtml);
            printWindow.document.close();
            printWindow.onload = function() { setTimeout(() => { printWindow.print(); }, 1000); };
        }

        async function saveAndGeneratePDF() {
            if (!currentAuditType || !currentAuditData) {
                alert("Bitte zuerst ein Audit auswählen und Daten eingeben!");
                return;
            }
            saveCurrentAuditData();
            const localDeviations = extractDeviationsForLocal();

            localDeviations.forEach(newDeviation => {
                const newKey = newDeviation.key || deviationKey(newDeviation);
                const exists = deviations.some(d => {
                    const existingKey = d.key || deviationKey(d);
                    return existingKey === newKey;
                });
                if (!exists) deviations.push(newDeviation);
            });
            saveDeviations();
            
            try {
                const pdfBlob = await generatePDFBlob();
                if (!pdfBlob) throw new Error('PDF-Generierung fehlgeschlagen');
                
                const auditTypeLocal = (currentAuditData.meta.audit_type || currentAuditData.meta.auditType || currentAuditType);
                const auditNumberConsistent = currentAuditData.meta.auditNumber;

                const auditData = {
                    meta: {
                        ...currentAuditData.meta,
                        audit_type: auditTypeLocal,
                        saved_at: new Date().toISOString(),
                        password: AUDIT_PASSWORD,
                        department: extractDepartment(),
                        audit_number: auditNumberConsistent,
                        has_pdf: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    },
                    participants: currentAuditData.participants,
                    questions: currentAuditData.questions,
                    images: currentAuditData.images
                };              

                const auditResponse = await fetch(`${SUPABASE_URL}/rest/v1/audits`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(auditData)
                });
                
                if (!auditResponse.ok) throw new Error('Audit speichern fehlgeschlagen');

                const auditResult = await auditResponse.json();
                const auditId = auditResult[0]?.id;
                
                if (auditId) {
                    const pdfFormData = new FormData();
                    pdfFormData.append('file', pdfBlob, `audit_${auditId}.pdf`);
                    
                    await fetch(`${SUPABASE_URL}/storage/v1/object/pdfs/audit_${auditId}.pdf`, {
                        method: 'POST',
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` },
                        body: pdfFormData
                    });

                    deviations = deviations.map(dev => {
                        const isSameAudit = (dev.audit_id === auditId)
                          || (dev.auditNumber && dev.auditNumber === auditNumberConsistent)
                          || (dev.auditId === currentAuditType && !dev.audit_id);
                        if (isSameAudit) {
                          const newKey = deviationKeyFromParts(auditId, dev.questionId);
                          return { ...dev, audit_id: auditId, key: newKey };
                        }
                        return dev;
                    });
                    saveDeviations();

                    const toUpload = deviations.filter(d => d.audit_id === auditId);
                    for (const deviation of toUpload) {
                        await saveSingleDeviationToCloud({ ...deviation, audit_id: auditId });
                    }
                }
                
                alert(`✅ Audit und PDF gespeichert!\n\n${localDeviations.length} Abweichungen in die Cloud übertragen.\n\nPDF kann über die Cloud-Liste geöffnet werden.`);
                updateDeviationsProgressDisplay();
                updateCloudProgressDisplay();
            } catch (error) {
                console.error('PDF-Fehler:', error);
                alert(`❌ Fehler: ${error.message}\n\nVersuchen Sie es erneut oder speichern Sie nur das Audit.`);
            }
        }

        function normalizeAuditType(value) {
          if (typeof value !== 'string') return null;
          const v = value.trim().toLowerCase();
          const map = { wirbelstrom: 'wirbelstrom', magnetpulver: 'magnetpulver', nital: 'nital', ultraschall: 'ultraschall', et: 'wirbelstrom', mt: 'magnetpulver', ne: 'nital', ut: 'ultraschall' };
          return map[v] || null;
        }

        function extractDeviationsForLocal() {
            const newDeviations = [];
            const auditNumberConsistent = currentAuditData?.meta?.auditNumber
              || currentAuditData?.meta?.audit_number
              || generateAuditNumber();
            const baseKey = currentAuditData?.meta?.auditNumber || currentAuditType;

            allQuestions.forEach(q => {
                const needsDeviation = (q.points !== null && q.points <= 8 && q.deviation && q.deviation.text && q.deviation.text.trim() !== '');
                if (!needsDeviation) return;

                const key = deviationKeyFromParts(auditNumberConsistent, q.id);
                const localId = `${baseKey}_${q.id}`;

                newDeviations.push({
                    id: localId,
                    key,
                    auditId: currentAuditType,
                    auditNumber: auditNumberConsistent,
                    department: extractDepartment(),
                    auditTitle: AUDIT_TYPES[currentAuditType].title,
                    questionId: q.id,
                    questionText: q.text,
                    deviationText: q.deviation.text,
                    responsible: q.deviation.responsible || 'Nicht angegeben',
                    date: new Date().toISOString(),
                    status: 'offen',
                    points: q.points,
                    hasImage: q.deviation.hasImage || false,
                    imageData: q.deviation.hasImage ? imageStorage[q.id] : null,
                    fromCloud: false
                });
            });
            return newDeviations;
        }

        function extractDepartment() {
            if (participants?.auditees?.length > 0) {
                const firstAuditee = participants.auditees[0];
                const match = firstAuditee.match(/(WI\/[A-Z0-9-]+)/);
                return match ? match[1] : 'Nicht angegeben';
            }
            return 'Nicht angegeben';
        }

        function generateAuditNumber() {
            const date = new Date();
            const year = date.getFullYear().toString().substr(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `AUD-${year}${month}${day}-${random}`;
        }
function generatePDFBlob() {
            return new Promise((resolve, reject) => {
                try {
                    const reportHtml = createReportHTML();
                    const printWindow = window.open('', '_blank');
                    printWindow.document.open();
                    printWindow.document.write(reportHtml);
                    printWindow.document.close();
                    printWindow.onload = function() {
                        const element = printWindow.document.querySelector('.main-container');
                        const opt = {
                            margin:[15, 10, 15, 15],
                            filename: `ZfP-Audit_${AUDIT_TYPES[currentAuditType].title}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true, logging: false,
                                onclone: function(clonedDoc) {
                                    const printBtn = clonedDoc.querySelector('.print-container');
                                    if (printBtn) printBtn.style.display = 'none';
                                }
                            },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true }
                        };
                        html2pdf().set(opt).from(element).outputPdf('blob').then(blob => {
                            printWindow.close();
                            resolve(blob);
                        }).catch(error => {
                            printWindow.close();
                            reject(new Error('PDF-Generierung fehlgeschlagen: ' + error.message));
                        });
                    };
                } catch (error) {
                    reject(new Error('PDF-Generierung fehlgeschlagen: ' + error.message));
                }
            });
        }

        // === MODAL FUNKTIONEN ===
        async function openCloudModal() {
            document.getElementById('cloudModal').style.display = 'flex';
            await loadDeviationsFromCloud();
            await loadAuditsFromCloud();
        }
        
        function closeCloudModal() {
            document.getElementById('cloudModal').style.display = 'none';
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            document.querySelector('h1').textContent = 'ZfP Review Audit';
            document.querySelector('.subtitle').textContent = 'Zerstörungsfreie Prüfung';
            updateAuditProgressDisplays();
            updateCloudProgressDisplay();
        }
        
        function openDeviationsModal() {
            document.getElementById('deviationsModal').style.display = 'flex';
            displayDeviationsList();
        }
        
        function closeDeviationsModal() {
            document.getElementById('deviationsModal').style.display = 'none';
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            document.querySelector('h1').textContent = 'ZfP Review Audit';
            document.querySelector('.subtitle').textContent = 'Zerstörungsfreie Prüfung';
        }
        
        function closeImageModal() { document.getElementById('imageModal').style.display = 'none'; document.getElementById('modalImage').src = ''; }
        function closePdfModal() { document.getElementById('pdfModal').style.display = 'none'; }

        // === AUDIT-FUNKTIONEN ===
        function loadAllAuditData() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const saved = localStorage.getItem(`zfpAuditReview_${auditType}`);
                if (!saved) {
                    const sections = AUDIT_DATA[auditType];
                    const allQuestionsForAudit = sections.flatMap(section => 
                        section.questions.map(q => ({
                            ...q,
                            sectionTitle: section.title,
                            sectionShort: section.short,
                            points: null,
                            evidence: "",
                            deviation: { text: "", responsible: "", hasImage: false }
                        }))
                    );
                    
                    const initialData = {
                        meta: {
                            created: new Date().toISOString(),
                            lastModified: new Date().toISOString(),
                            auditType: auditType,
                            audit_type: auditType,
                            title: AUDIT_TYPES[auditType].title,
                            standards: AUDIT_TYPES[auditType].standards,
                            auditNumber: generateAuditNumber()
                        },
                        participants: { auditors: [], auditees: [] },
                        questions: allQuestionsForAudit,
                        images: {}
                    };
                    localStorage.setItem(`zfpAuditReview_${auditType}`, JSON.stringify(initialData));
                }
            });
        }

        function startAudit(auditType) {
            currentAuditType = auditType;
            document.getElementById('auditSelection').classList.remove('active');
            document.getElementById('auditContent').classList.add('active');

            // Wenn Daten bereits (z.B. aus Cloud) gesetzt wurden, nicht überschreiben
            if (!currentAuditData || !currentAuditData.questions || currentAuditData.meta?.audit_type !== auditType) {
                loadCurrentAuditData();
            } else {
                allQuestions = currentAuditData.questions || [];
                participants = currentAuditData.participants || { auditors: [], auditees: [] };
                imageStorage = currentAuditData.images || {};
                allQuestionElements = allQuestions;
            }
            
            const auditInfo = AUDIT_TYPES[auditType];
            document.querySelector('h1').textContent = `ZfP Audit - ${auditInfo.title}`;
            document.querySelector('.subtitle').textContent = auditInfo.standards;
            
            renderAuditSections();
            setupDesktopEventListeners();
            updateCurrentAuditProgress();
            renderParticipants();
            setupMobileParticipants();
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.getElementById('desktopView').style.display = 'none';
                document.getElementById('mobileView').style.display = 'block';
                renderMobileQuestion();
            } else {
                document.getElementById('desktopView').style.display = 'block';
                document.getElementById('mobileView').style.display = 'none';
            }
            
            const evalElem = document.getElementById('evaluation');
            if (evalElem) evalElem.classList.remove('active');
            const evalBtn = document.getElementById('evaluationBtn');
            if (evalBtn) evalBtn.textContent = '📊 Auswertung';
        }

        function loadCurrentAuditData() {
            const saved = localStorage.getItem(`zfpAuditReview_${currentAuditType}`);
            if (saved) {
                currentAuditData = JSON.parse(saved);
                allQuestions = currentAuditData.questions || [];
                participants = currentAuditData.participants || { auditors: [], auditees: [] };
                imageStorage = currentAuditData.images || {};
                if (!currentAuditData.meta.auditNumber) currentAuditData.meta.auditNumber = generateAuditNumber();
            } else {
                const sections = AUDIT_DATA[currentAuditType];
                allQuestions = sections.flatMap(section => 
                    section.questions.map(q => ({
                        ...q,
                        sectionTitle: section.title,
                        sectionShort: section.short,
                        points: null,
                        evidence: "",
                        deviation: { text: "", responsible: "", hasImage: false }
                    }))
                );
                currentAuditData = {
                    meta: {
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        auditType: currentAuditType,
                        title: AUDIT_TYPES[currentAuditType].title,
                        standards: AUDIT_TYPES[currentAuditType].standards,
                        auditNumber: generateAuditNumber()
                    },
                    participants: { auditors: [], auditees: [] },
                    questions: allQuestions,
                    images: {}
                };
            }
            allQuestionElements = allQuestions;
        }

        function saveCurrentAuditData() {
            if (!currentAuditType || !currentAuditData) return;
            currentAuditData.questions = allQuestions;
            currentAuditData.participants = participants;
            currentAuditData.images = imageStorage;
            currentAuditData.meta.lastModified = new Date().toISOString();
            if (!currentAuditData.meta.auditNumber) currentAuditData.meta.auditNumber = generateAuditNumber();
            localStorage.setItem(`zfpAuditReview_${currentAuditType}`, JSON.stringify(currentAuditData));
            updateAuditProgressDisplays();
            updateCurrentAuditProgress();
            updateCloudProgressDisplay();
        }

        function goBackToSelection() {
            saveCurrentAuditData();
            currentAuditType = null;
            currentAuditData = null;
            allQuestions = [];
            allQuestionElements = [];
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            document.querySelector('h1').textContent = 'ZfP Review Audit';
            document.querySelector('.subtitle').textContent = 'Zerstörungsfreie Prüfung';
        }

        function updateCurrentAuditProgress() {
            if (!allQuestions.length) return;
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.points !== null).length;
            const points = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('progressText').textContent = `${percent}%`;
            document.getElementById('pointsTotal').textContent = points;
            document.getElementById('pointsMax').textContent = maxPoints;
            const progressBar = document.getElementById('auditProgressBar');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
            if (percent === 100) progressBar.style.backgroundColor = 'var(--progress-100)';
            else if (percent >= 75) progressBar.style.backgroundColor = 'var(--progress-75)';
            else if (percent >= 50) progressBar.style.backgroundColor = 'var(--progress-50)';
            else if (percent >= 25) progressBar.style.backgroundColor = 'var(--progress-25)';
            else progressBar.style.backgroundColor = 'var(--progress-0)';
            if (currentAuditType) updateAuditProgressDisplays();
        }

        function updateAuditProgressDisplays() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const progress = calculateAuditProgress(auditType);
                const progressElement = document.getElementById(`${auditType}Progress`);
                if (progressElement) progressElement.textContent = `${progress.percent}%`;
            });
            updateCloudProgressDisplay();
        }

        function updateCloudProgressDisplay() {
            const cloudProgressElement = document.getElementById('cloudProgress');
            if (cloudProgressElement) {
                cloudProgressElement.textContent = 'Lädt...';
                const savedAudits = countAuditsFromLocalStorage();
                if (savedAudits > 0) cloudProgressElement.textContent = `${savedAudits} Audits`;
                loadActualAuditCountFromCloud();
            }
        }

        async function loadActualAuditCountFromCloud() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?select=id&order=id`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) {
                    const audits = await response.json();
                    const cloudProgressElement = document.getElementById('cloudProgress');
                    if (cloudProgressElement && audits) {
                        const count = audits.length || 0;
                        cloudProgressElement.textContent = `${count} Audit${count !== 1 ? 's' : ''}`;
                        localStorage.setItem('cloudAuditCount', count.toString());
                    }
                }
            } catch (error) {
                console.log('Cloud-Zählung nicht verfügbar');
            }
        }

        function countAuditsFromLocalStorage() {
            let count = 0;
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const saved = localStorage.getItem(`zfpAuditReview_${auditType}`);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        const hasAnswers = data.questions?.some(q => q.points !== null);
                        if (hasAnswers) count++;
                    } catch (e) {}
                }
            });
            return count;
        }

        function calculateAuditProgress(auditType) {
            const saved = localStorage.getItem(`zfpAuditReview_${auditType}`);
            if (!saved) {
                const sections = AUDIT_DATA[auditType];
                const total = sections.reduce((sum, section) => sum + section.questions.length, 0);
                return { answered: 0, total: total, percent: 0, points: 0, maxPoints: total * 10 };
            }
            const data = JSON.parse(saved);
            const questions = data.questions || [];
            const total = questions.length;
            const answered = questions.filter(q => q.points !== null).length;
            const points = questions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            return { answered, total, percent, points, maxPoints };
        }

        // === EVENT LISTENERS ===
        function setupEventListeners() {
            document.querySelectorAll('.audit-btn').forEach(btn => {
                if (btn.dataset.audit) btn.addEventListener('click', function() { startAudit(this.dataset.audit); });
            });

            const backBtn = document.getElementById('backBtn');
            if (backBtn) backBtn.addEventListener('click', goBackToSelection);

            const reportBtn = document.getElementById('reportBtn');
            if (reportBtn) reportBtn.addEventListener('click', generateReport);

            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showResetConfirmation();
                });
            }

            const evaluationBtn = document.getElementById('evaluationBtn');
            if (evaluationBtn) evaluationBtn.addEventListener('click', showEvaluation);

            const prevBtn = document.getElementById('prevBtn');
            if (prevBtn) prevBtn.addEventListener('click', function() {
                if (currentMobileQuestion > 0) { currentMobileQuestion--; renderMobileQuestion(); }
            });

            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) nextBtn.addEventListener('click', function() {
                if (currentMobileQuestion < allQuestionElements.length - 1) { currentMobileQuestion++; renderMobileQuestion(); }
            });

            window.addEventListener('resize', handleResize);
        }

        // === RENDER FUNKTIONEN ===
        function renderAuditSections() {
            const sectionsContainer = document.getElementById('auditSections');
            const mobileSectionSelector = document.getElementById('sectionSelector');
            sectionsContainer.innerHTML = '';
            mobileSectionSelector.innerHTML = '';
            const sections = AUDIT_DATA[currentAuditType];
            
            sections.forEach((section, sectionIndex) => {
                // Desktop Section
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section';
                sectionElement.dataset.sectionIndex = sectionIndex;
                
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `<h2>${section.title}</h2><span>▶</span>`;
                
                const sectionContent = document.createElement('div');
                sectionContent.className = 'section-content';
                
                const questionsHTML = section.questions.map((question) => {
                    const questionData = getQuestionData(question.id);
                    const points = questionData?.points;
                    return `
                        <div class="question" data-question-id="${question.id}">
                            <div class="question-header">
                                <div class="question-text">${question.text}</div>
                                <div class="question-id" style="background: ${getPointsColor(points)}">${question.id}</div>
                            </div>
                            
                            <div class="points-display" style="display: ${points !== null ? 'block' : 'none'}; border-color: ${getPointsColor(points)}; background: ${getPointsColor(points)}20;">
                                <span style="color: ${getPointsColor(points)}; font-weight: bold;">
                                    ${points !== null ? `${points} Punkte vergeben` : 'Keine Bewertung'}
                                </span>
                            </div>
                            
                            <div class="points-options">
                                <button class="points-option ${points === 0 ? 'selected' : ''}" data-points="0" onclick="selectPoints('${question.id}', 0)">0 Punkte</button>
                                <button class="points-option ${points === 4 ? 'selected' : ''}" data-points="4" onclick="selectPoints('${question.id}', 4)">4 Punkte</button>
                                <button class="points-option ${points === 8 ? 'selected' : ''}" data-points="8" onclick="selectPoints('${question.id}', 8)">8 Punkte</button>
                                <button class="points-option ${points === 10 ? 'selected' : ''}" data-points="10" onclick="selectPoints('${question.id}', 10)">10 Punkte</button>
                            </div>
                            
                            <textarea class="evidence" placeholder="Nachweise / Bemerkungen" oninput="updateQuestionData('${question.id}', 'evidence', this.value)" rows="2">${questionData?.evidence || ''}</textarea>
                            
                            <div class="deviation-section" style="display: ${(points !== null && points <= 8) ? 'block' : 'none'};">
                                <h4>⚠️ Abweichung erfassen</h4>
                                <textarea class="deviation-field" placeholder="Abweichungsbeschreibung" oninput="updateQuestionData('${question.id}', 'deviation.text', this.value)" rows="3">${questionData?.deviation?.text || ''}</textarea>
                                
                                <input type="text" class="responsible-field" placeholder="Verantwortlicher" value="${questionData?.deviation?.responsible || ''}" oninput="updateQuestionData('${question.id}', 'deviation.responsible', this.value)">
                                
                                <div class="image-upload">
                                    <div class="file-input-wrapper">
                                        <label class="file-input-label">
                                            📷 Bild hochladen
                                            <input type="file" accept="image/*" style="display: none;" onchange="handleImageUploadDesktop(event, '${question.id}')">
                                        </label>
                                    </div>
                                    ${questionData?.deviation?.hasImage ? `
                                        <div class="image-preview-container">
                                            <img src="${imageStorage[question.id] || ''}" class="image-preview" style="display: block;" onclick="openImageModal('${question.id}')">
                                            <button class="remove-image" onclick="removeImageForQuestion('${question.id}')">Bild entfernen</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                sectionContent.innerHTML = questionsHTML;
                sectionElement.appendChild(sectionHeader);
                sectionElement.appendChild(sectionContent);
                sectionsContainer.appendChild(sectionElement);
                
                // Mobile Section Button
                const sectionBtn = document.createElement('button');
                sectionBtn.className = 'section-btn';
                sectionBtn.textContent = section.short;
                sectionBtn.onclick = function() {
                    const firstQuestionIndex = sections.slice(0, sectionIndex).reduce((sum, s) => sum + s.questions.length, 0);
                    currentMobileQuestion = firstQuestionIndex;
                    renderMobileQuestion();
                };
                mobileSectionSelector.appendChild(sectionBtn);
                
                // Event Listener für Section Toggle
                sectionHeader.addEventListener('click', function() {
                    sectionElement.classList.toggle('expanded');
                });
            });
            setupDesktopEventListeners();
        }

        function renderMobileQuestion() {
            const container = document.getElementById('mobileQuestions');
            const counter = document.getElementById('mobileCounter');
            if (allQuestionElements.length === 0) {
                container.innerHTML = '<p>Keine Fragen verfügbar</p>';
                counter.textContent = '0/0';
                return;
            }
            const question = allQuestionElements[currentMobileQuestion];
            const questionData = getQuestionData(question.id);
            const points = questionData?.points;
            container.innerHTML = `
                <div class="question">
                    <div class="question-header">
                        <div class="question-text">${question.text}</div>
                        <div class="question-id" style="background: ${getPointsColor(points)}">${question.id}</div>
                    </div>
                    
                    <div class="points-display" style="display: ${points !== null ? 'block' : 'none'}; border-color: ${getPointsColor(points)}; background: ${getPointsColor(points)}20;">
                        <span style="color: ${getPointsColor(points)}; font-weight: bold;">
                            ${points !== null ? `${points} Punkte vergeben` : 'Keine Bewertung'}
                        </span>
                    </div>
                    
                    <div class="points-options">
                        <button class="points-option ${points === 0 ? 'selected' : ''}" data-points="0" onclick="selectPointsMobile('${question.id}', 0)">0</button>
                        <button class="points-option ${points === 4 ? 'selected' : ''}" data-points="4" onclick="selectPointsMobile('${question.id}', 4)">4</button>
                        <button class="points-option ${points === 8 ? 'selected' : ''}" data-points="8" onclick="selectPointsMobile('${question.id}', 8)">8</button>
                        <button class="points-option ${points === 10 ? 'selected' : ''}" data-points="10" onclick="selectPointsMobile('${question.id}', 10)">10</button>
                    </div>
                    
                    <textarea class="evidence" placeholder="Nachweise / Bemerkungen" oninput="updateQuestionData('${question.id}', 'evidence', this.value)" rows="2">${questionData?.evidence || ''}</textarea>
                    
                    <div class="deviation-section" style="display: ${(points !== null && points <= 8) ? 'block' : 'none'};">
                        <h4>⚠️ Abweichung erfassen</h4>
                        <textarea class="deviation-field" placeholder="Abweichungsbeschreibung" oninput="updateQuestionData('${question.id}', 'deviation.text', this.value)" rows="3">${questionData?.deviation?.text || ''}</textarea>
                        
                        <input type="text" class="responsible-field" placeholder="Verantwortlicher" value="${questionData?.deviation?.responsible || ''}" oninput="updateQuestionData('${question.id}', 'deviation.responsible', this.value)">
                        
                        <div class="image-upload">
                            <div class="file-input-wrapper">
                                <label class="file-input-label">
                                    📷 Bild hochladen
                                    <input type="file" accept="image/*" style="display: none;" onchange="handleImageUploadMobile(event, '${question.id}')">
                                </label>
                            </div>
                            ${questionData?.deviation?.hasImage ? `
                                <div class="image-preview-container">
                                    <img src="${imageStorage[question.id] || ''}" class="image-preview" style="display: block;" onclick="openImageModal('${question.id}')">
                                    <button class="remove-image" onclick="removeImageForQuestion('${question.id}')">Bild entfernen</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            counter.textContent = `Frage ${currentMobileQuestion + 1}/${allQuestionElements.length}`;
            document.getElementById('prevBtn').disabled = currentMobileQuestion === 0;
            document.getElementById('nextBtn').disabled = currentMobileQuestion === allQuestionElements.length - 1;
        }

        // === POINTS FUNKTIONEN ===
        function selectPoints(questionId, points) {
            updateQuestionData(questionId, 'points', points);
            const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
            if (questionElement) {
                const pointsDisplay = questionElement.querySelector('.points-display');
                const pointsOptions = questionElement.querySelectorAll('.points-option');
                const deviationSection = questionElement.querySelector('.deviation-section');
                const questionIdBadge = questionElement.querySelector('.question-id');
                if (points !== null) {
                    pointsDisplay.style.display = 'block';
                    pointsDisplay.style.borderColor = getPointsColor(points);
                    pointsDisplay.style.background = getPointsColor(points) + '20';
                    pointsDisplay.querySelector('span').textContent = `${points} Punkte vergeben`;
                    pointsDisplay.querySelector('span').style.color = getPointsColor(points);
                } else {
                    pointsDisplay.style.display = 'none';
                }
                questionIdBadge.style.background = getPointsColor(points);
                pointsOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (parseInt(option.dataset.points) === points) option.classList.add('selected');
                });
                if (deviationSection) deviationSection.style.display = (points !== null && points <= 8) ? 'block' : 'none';
            }
            saveCurrentAuditData();
            updateCurrentAuditProgress();
        }

        function selectPointsMobile(questionId, points) { selectPoints(questionId, points); renderMobileQuestion(); }

        function getQuestionData(questionId) { return allQuestionElements.find(q => q.id === questionId); }

        function getPointsColor(points) {
            if (points === null) return 'var(--points-na)';
            if (points === 0) return 'var(--points-0)';
            if (points === 4) return 'var(--points-4)';
            if (points === 8) return 'var(--points-8)';
            if (points === 10) return 'var(--points-10)';
            return 'var(--points-na)';
        }

        function updateQuestionData(questionId, field, value) {
            const question = getQuestionData(questionId);
            if (!question) return;
            const fieldPath = field.split('.');
            let current = question;
            for (let i = 0; i < fieldPath.length - 1; i++) {
                if (!current[fieldPath[i]]) current[fieldPath[i]] = {};
                current = current[fieldPath[i]];
            }
            current[fieldPath[fieldPath.length - 1]] = value;
            if (field === 'deviation.text' && value.trim() !== '') {
                if (!question.deviation.hasImage) question.deviation.hasImage = false;
            }
            saveCurrentAuditData();
        }

        // === BILD FUNKTIONEN ===
        function processAndLimitImage(file) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) return reject(new Error('Nur Bilddateien sind erlaubt'));
                if (file.size > 5 * 1024 * 1024) return reject(new Error('Bild darf maximal 5MB groß sein'));
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width, height = img.height;
                        const maxSize = 1200;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) { height = (height * maxSize) / width; width = maxSize; }
                            else { width = (width * maxSize) / height; height = maxSize; }
                        }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedDataUrl);
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleImageUploadDesktop(event, questionId) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const compressedImage = await processAndLimitImage(file);
                imageStorage[questionId] = compressedImage;
                updateQuestionData(questionId, 'deviation.hasImage', true);
                const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                if (questionElement) {
                    let previewContainer = questionElement.querySelector('.image-preview-container');
                    if (!previewContainer) {
                        const imageUploadDiv = questionElement.querySelector('.image-upload');
                        previewContainer = document.createElement('div');
                        previewContainer.className = 'image-preview-container';
                        imageUploadDiv.appendChild(previewContainer);
                    }
                    previewContainer.innerHTML = `
                        <img src="${compressedImage}" class="image-preview" style="display: block;" onclick="openImageModal('${questionId}')">
                        <button class="remove-image" onclick="removeImageForQuestion('${questionId}')">Bild entfernen</button>
                    `;
                }
                saveCurrentAuditData();
                alert('✅ Bild erfolgreich hochgeladen!');
            } catch (error) {
                alert('❌ Fehler: ' + error.message);
            }
            event.target.value = '';
        }

        async function handleImageUploadMobile(event, questionId) {
            await handleImageUploadDesktop(event, questionId);
            renderMobileQuestion();
        }

        function openImageModal(questionId) {
            const imageData = imageStorage[questionId];
            if (imageData) {
                document.getElementById('modalImage').src = imageData;
                document.getElementById('imageModal').style.display = 'flex';
            }
        }

        function removeImageForQuestion(questionId) {
            if (confirm('Bild wirklich entfernen?')) {
                delete imageStorage[questionId];
                updateQuestionData(questionId, 'deviation.hasImage', false);
                const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                if (questionElement) {
                    const previewContainer = questionElement.querySelector('.image-preview-container');
                    if (previewContainer) previewContainer.remove();
                }
                saveCurrentAuditData();
                if (window.innerWidth <= 768) renderMobileQuestion();
            }
        }

        // === TEILNEHMER FUNKTIONEN ===
        function renderParticipants() {
            document.getElementById('auditorList').innerHTML = participants.auditors.map((auditor, index) => `
                <div class="participant-item">
                    <span>${auditor}</span>
                    <button class="remove-participant" onclick="removeParticipant('auditor', ${index})">×</button>
                </div>
            `).join('');
            document.getElementById('auditeeList').innerHTML = participants.auditees.map((auditee, index) => `
                <div class="participant-item">
                    <span>${auditee}</span>
                    <button class="remove-participant" onclick="removeParticipant('auditee', ${index})">×</button>
                </div>
            `).join('');
            updateMobileParticipantList();
        }

        function addParticipant(type) {
            const input = document.getElementById(`${type}Input`);
            const name = input.value.trim();
            if (name && !participants[type === 'auditor' ? 'auditors' : 'auditees'].includes(name)) {
                participants[type === 'auditor' ? 'auditors' : 'auditees'].push(name);
                input.value = '';
                renderParticipants();
                saveCurrentAuditData();
            }
        }

        function addMobileParticipant() {
            const input = document.getElementById('mobileParticipantInput');
            const name = input.value.trim();
            const type = currentMobileParticipantType === 'auditor' ? 'auditors' : 'auditees';
            if (name && !participants[type].includes(name)) {
                participants[type].push(name);
                input.value = '';
                updateMobileParticipantList();
                saveCurrentAuditData();
            }
        }

        function removeParticipant(type, index) {
            const arrayName = type === 'auditor' ? 'auditors' : 'auditees';
            participants[arrayName].splice(index, 1);
            renderParticipants();
            saveCurrentAuditData();
        }

        function removeMobileParticipant(index) {
            const type = currentMobileParticipantType === 'auditor' ? 'auditors' : 'auditees';
            participants[type].splice(index, 1);
            updateMobileParticipantList();
            saveCurrentAuditData();
        }

        function setupMobileParticipants() {
            document.querySelectorAll('.mobile-participant-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mobile-participant-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMobileParticipantType = this.dataset.type;
                    updateMobileParticipantList();
                });
            });
        }

        function updateMobileParticipantList() {
            const type = currentMobileParticipantType === 'auditor' ? 'auditors' : 'auditees';
            const list = document.getElementById('mobileParticipantList');
            list.innerHTML = participants[type].map((participant, index) => `
                <div class="participant-item">
                    <span>${participant}</span>
                    <button class="remove-participant" onclick="removeMobileParticipant(${index})">×</button>
                </div>
            `).join('');
        }

        // === RESET FUNKTION ===
        function showResetConfirmation() {
            if (confirm('MÖCHTEN SIE WIRKLICH DAS KOMPLETTE AUDIT ZURÜCKSETZEN?\n\nDiese Aktion löscht alle Bewertungen, Nachweise, Bilder UND die Teilnehmer.\n\nDiese Aktion kann nicht rückgängig gemacht werden!')) {
                resetAudit();
            }
        }

        function resetAudit() {
            if (!currentAuditType) return;

            allQuestions.forEach(question => {
                question.points = null;
                question.evidence = '';
                question.deviation = { text: '', responsible: '', hasImage: false };
            });

            imageStorage = {};

            // Teilnehmer ebenfalls leeren (Anforderung)
            participants = { auditors: [], auditees: [] };

            // Eingabefelder leeren
            const aIn = document.getElementById('auditorInput');
            const eIn = document.getElementById('auditeeInput');
            const mIn = document.getElementById('mobileParticipantInput');
            if (aIn) aIn.value = '';
            if (eIn) eIn.value = '';
            if (mIn) mIn.value = '';

            currentAuditData.questions = allQuestions;
            currentAuditData.images = {};
            currentAuditData.participants = participants;
            currentAuditData.meta.lastModified = new Date().toISOString();

            saveCurrentAuditData();
            renderAuditSections();
            renderParticipants();
            if (window.innerWidth <= 768) renderMobileQuestion();
            updateCurrentAuditProgress();
            alert('✅ Audit wurde zurückgesetzt!');
        }

        // === REPORT GENERATOR ===
        function createReportHTML() {
            const auditInfo = AUDIT_TYPES[currentAuditType];
            const auditDate = new Date(currentAuditData.meta.lastModified);
            const formattedDate = formatDateDMY(auditDate);
            const totalQuestions = allQuestions.length;
            const answeredQuestions = allQuestions.filter(q => q.points !== null).length;
            const totalPoints = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = totalQuestions * 10;
            const percentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
            
            const deviationsCount = allQuestions.filter(q => 
                q.points !== null && q.points <= 8 && q.deviation && q.deviation.text && q.deviation.text.trim() !== ''
            ).length;
            
            const pointsDistribution = {
                10: allQuestions.filter(q => q.points === 10).length,
                8: allQuestions.filter(q => q.points === 8).length,
                4: allQuestions.filter(q => q.points === 4).length,
                0: allQuestions.filter(q => q.points === 0).length,
                unanswered: allQuestions.filter(q => q.points === null).length
            };
            
            const criticalQuestions = allQuestions.filter(q => 
                q.points !== null && q.points <= 4 && q.deviation && q.deviation.text && q.deviation.text.trim() !== ''
            );
            
            let grade = '';
            let gradeText = '';
            let gradeColor = '';
            if (percentage >= 90) { grade = 'A'; gradeText = 'Exzellent'; gradeColor = '#27ae60'; }
            else if (percentage >= 80) { grade = 'B'; gradeText = 'Sehr gut'; gradeColor = '#2ecc71'; }
            else if (percentage >= 70) { grade = 'C'; gradeText = 'Gut'; gradeColor = '#f39c12'; }
            else if (percentage >= 60) { grade = 'D'; gradeText = 'Befriedigend'; gradeColor = '#e67e22'; }
            else { grade = 'E'; gradeText = 'Ausreichend'; gradeColor = '#e74c3c'; }
            
            let recommendations = [];
            if (percentage >= 80) {
                recommendations = [
                    '✅ Sehr gutes Ergebnis. Alle wesentlichen Anforderungen erfüllt.',
                    '✅ Prozesse sind gut dokumentiert und umgesetzt.',
                    '⚠️ Geringfügige Abweichungen sollten trotzdem behoben werden.'
                ];
            } else if (percentage >= 70) {
                recommendations = [
                    '⚠️ Gutes Ergebnis. Einige Verbesserungspotentiale vorhanden.',
                    '⚠️ Kritische Fragen sollten priorisiert angegangen werden.',
                    '✅ Bilder dokumentieren Abweichungen effektiv.'
                ];
            } else if (percentage >= 60) {
                recommendations = [
                    '⚠️ Verbesserungsbedarf vorhanden. Mehrere kritische Abweichungen.',
                    '🔴 Priorisierte Maßnahmen zur Behebung erforderlich.',
                    '📋 Regelmäßige Nachverfolgung der Maßnahmen empfohlen.'
                ];
            } else {
                recommendations = [
                    '🔴 Erheblicher Handlungsbedarf. Audit nicht bestanden.',
                    '🔴 Sofortmaßnahmen zur Prozessverbesserung erforderlich.',
                    '📋 Intensive Nachbetreuung und Follow-up-Audit notwendig.'
                ];
            }
            
            const imagesCount = Object.keys(imageStorage).length;
            
            return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditbericht - ${auditInfo.title} | Schaeffler Technologies AG & Co. KG</title>

    <style>

        @page {
            size: A4 portrait;
            margin: 15mm 10mm 15mm 15mm;
            @bottom-right {
                content: "Seite " counter(page) " von " counter(pages);
                font-size: 8pt;
                color: #666;
            }
        }
        
        body {
            font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        
        .main-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 0 auto !important;
            box-sizing: border-box;
        }
        
        /* ===== KOPFZEILE ===== */
        .header-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 0 auto 6mm auto !important;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1.5pt solid #003865;
            padding-bottom: 4mm;
            box-sizing: border-box;
        }
        
        .title-section {
            flex: 1;
            text-align: left;
            padding-right: 10mm;
        }
        
        .report-title {
            font-size: 16pt;
            font-weight: bold;
            color: #003865;
            margin-bottom: 1mm;
            text-transform: uppercase;
        }
        
        .report-subtitle {
            font-size: 12pt;
            color: #333;
            font-weight: 600;
            margin-bottom: 1mm;
        }
        
        .report-standards {
            font-size: 10pt;
            color: #666;
            font-style: italic;
        }
        
        .logo-section {
            flex-shrink: 0;
            text-align: right;
        }
        
        .schaeffler-logo {
            width: 45mm;
            height: auto;
        }
        
        /* ===== METADATEN ===== */
        .meta-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 0 auto 8mm auto !important;
            background: #f8f9fa;
            border: 1pt solid #ddd;
            border-radius: 4px;
            padding: 4mm;
            box-sizing: border-box;
        }
        
        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6mm;
            font-size: 9pt;
        }
        
        .meta-column {
            display: flex;
            flex-direction: column;
            gap: 2mm;
        }
        
        .meta-row {
            display: flex;
            justify-content: space-between;
            padding-bottom: 1.5mm;
            border-bottom: 0.5pt dotted #ccc;
        }
        
        .meta-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .meta-label {
            font-weight: bold;
            color: #003865;
            min-width: 35mm;
        }
        
        .meta-value {
            text-align: right;
            flex: 1;
        }
        
        /* ===== TEILNEHMER ===== */
        .participants-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 0 auto 8mm auto !important;
            background: #f0f7ff;
            border: 1pt solid #003865;
            border-radius: 4px;
            padding: 4mm;
            box-sizing: border-box;
        }
        
        .container-title {
            font-weight: bold;
            color: #003865;
            font-size: 11pt;
            text-align: center;
            margin-bottom: 3mm;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8mm;
        }
        
        .participant-group {
            background: white;
            padding: 3mm;
            border-radius: 3px;
            border: 1pt solid #ddd;
        }
        
        .group-label {
            font-weight: bold;
            color: #003865;
            font-size: 10pt;
            margin-bottom: 1mm;
            border-bottom: 1pt solid #ddd;
            padding-bottom: 1mm;
        }
        
        .group-content {
            min-height: 8mm;
            font-size: 10pt;
            line-height: 1.4;
        }
        
        /* ===== ZUSAMMENFASSUNG MIT AUSWERTUNG ===== */
        .summary-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 0 auto 10mm auto !important;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            border: 1.5pt solid #003865;
            border-radius: 5px;
            padding: 5mm;
            box-sizing: border-box;
        }
        
        .summary-title {
            font-weight: bold;
            color: #003865;
            font-size: 12pt;
            text-align: center;
            margin-bottom: 5mm;
            text-transform: uppercase;
        }
        
        /* ERGEBNIS-ÜBERSICHT */
        .results-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4mm;
            margin-bottom: 6mm;
        }
        
        .result-item {
            background: white;
            padding: 3mm;
            border-radius: 3px;
            border: 1pt solid #003865;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 20mm;
        }
        
        .result-value {
            font-size: 14pt;
            font-weight: bold;
            color: #003865;
            margin-bottom: 1mm;
        }
        
        .result-label {
            font-size: 8pt;
            color: #666;
            line-height: 1.3;
        }
        
        /* AUSWERTUNGS-DETAILS */
        .evaluation-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6mm;
            margin-top: 6mm;
            padding-top: 4mm;
            border-top: 1pt dashed #003865;
        }
        
        .evaluation-column {
            display: flex;
            flex-direction: column;
            gap: 3mm;
        }
        
        .grade-box {
            background: white;
            padding: 4mm;
            border-radius: 4px;
            border: 2pt solid ${gradeColor};
            text-align: center;
        }
        
        .grade-value {
            font-size: 24pt;
            font-weight: bold;
            color: ${gradeColor};
            margin-bottom: 1mm;
        }
        
        .grade-text {
            font-size: 10pt;
            font-weight: bold;
            color: ${gradeColor};
            margin-bottom: 1mm;
        }
        
        .grade-percentage {
            font-size: 12pt;
            font-weight: bold;
            color: #003865;
        }
        
        .points-distribution {
            background: white;
            padding: 3mm;
            border-radius: 3px;
            border: 1pt solid #ddd;
        }
        
        .distribution-title {
            font-weight: bold;
            color: #003865;
            font-size: 10pt;
            margin-bottom: 2mm;
            text-align: center;
        }
        
        .distribution-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2mm;
        }
        
        .distribution-item {
            text-align: center;
            padding: 1mm;
            border-radius: 2px;
            background: #f8f9fa;
        }
        
        .distribution-points {
            font-weight: bold;
            font-size: 10pt;
            color: #003865;
        }
        
        .distribution-count {
            font-size: 9pt;
            color: #666;
        }
        
        .critical-issues {
            background: white;
            padding: 3mm;
            border-radius: 3px;
            border: 1pt solid #e74c3c;
            background-color: #fff5f5;
        }
        
        .critical-title {
            font-weight: bold;
            color: #e74c3c;
            font-size: 10pt;
            margin-bottom: 2mm;
            text-align: center;
        }
        
        .critical-list {
            font-size: 8pt;
            line-height: 1.4;
            max-height: 25mm;
            overflow-y: auto;
        }
        
        .critical-item {
            margin-bottom: 1mm;
            padding-bottom: 1mm;
            border-bottom: 0.5pt dotted #ffcccc;
        }
        
        .recommendations {
            background: white;
            padding: 3mm;
            border-radius: 3px;
            border: 1pt solid #f39c12;
            background-color: #fff9e6;
        }
        
        .recommendations-title {
            font-weight: bold;
            color: #f39c12;
            font-size: 10pt;
            margin-bottom: 2mm;
            text-align: center;
        }
        
        .recommendations-list {
            font-size: 8pt;
            line-height: 1.4;
        }
        
        /* ===== FRAGEN TABELLE ===== */
        .questions-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 0 auto !important;
            box-sizing: border-box;
        }
        
        .section {
            margin: 6mm 0;
            width: 100%;
        }
        
        .section-header {
            background-color: #003865;
            color: white;
            padding: 2.5mm 4mm;
            font-weight: bold;
            font-size: 11pt;
            margin: 5mm 0 3mm 0;
            border-radius: 3px;
            width: 96%;
        }
        
        .questions-table {
            width: 180mm !important;
            border-collapse: collapse;
            margin: 0;
            font-size: 9pt;
            table-layout: fixed;
        }
        
        .questions-table th {
            background-color: #e6f0ff;
            padding: 2.5mm 2mm;
            text-align: left;
            font-weight: bold;
            border-bottom: 1.5pt solid #003865;
            border-right: 1pt solid #ddd;
            color: #003865;
            height: 8mm;
        }
        
        .questions-table td {
            padding: 2.5mm 2mm;
            border-bottom: 0.5pt solid #eee;
            border-right: 1pt solid #eee;
            vertical-align: top;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .status-indicator {
            display: inline-block;
            width: 6pt;
            height: 6pt;
            border-radius: 50%;
            margin-right: 1.5mm;
        }
        
        .status-ok { background-color: #38a169; }
        .status-nok { background-color: #e53e3e; }
        .status-na { background-color: #a0aec0; }
        
        .question-id {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .image-row {
            background-color: #f9f9f9;
        }
        
        .report-image-container {
            padding: 2mm;
            text-align: center;
            border: 1pt dashed #ccc;
            border-radius: 3px;
            margin: 2mm 0;
            background-color: white;
            page-break-inside: avoid;
        }
        
        .report-image {
            max-width: 150mm;
            max-height: 100mm;
            height: auto;
            border: 1pt solid #ddd;
            border-radius: 2px;
        }
        
        /* ===== LEGENDE ===== */
        .legend-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 8mm auto 5mm auto !important;
            font-size: 8pt;
            color: #666;
            text-align: center;
            border-top: 1pt dashed #ccc;
            padding-top: 3mm;
            box-sizing: border-box;
        }
        
        /* ===== UNTERSCHRIFTEN ===== */
        .signature-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 10mm auto 0 auto !important;
            padding-top: 6mm;
            border-top: 1.5pt solid #003865;
            font-size: 9pt;
            box-sizing: border-box;
        }
        
        .signature-grid {
            display: flex;
            justify-content: space-between;
            margin-top: 8mm;
            width: 100%;
        }
        
        .signature-item {
            text-align: center;
            width: 85mm;
        }
        
        .signature-line {
            border-top: 1pt solid #000;
            padding-top: 2mm;
            margin-top: 12mm;
            min-height: 15mm;
        }
        
        /* ===== DRUCK-STEUERUNG ===== */
        .print-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 12mm auto 8mm auto !important;
            padding: 4mm;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1pt solid #ddd;
            text-align: center;
            box-sizing: border-box;
        }
        
        .print-btn {
            padding: 6mm 12mm;
            background: #003865;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11pt;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4mm;
            min-width: 50mm;
        }
        
        .print-btn:hover { background: #00274d; }
        
        /* ===== FOOTER ===== */
        .footer-container {
            width: 180mm !important;
            max-width: 180mm !important;
            margin: 5mm auto 0 auto !important;
            font-size: 7pt;
            color: #666;
            text-align: center;
            padding-top: 2mm;
            border-top: 1pt solid #eee;
            box-sizing: border-box;
        }
        
        /* ===== DRUCK-STYLES ===== */
        @media print {
            body { margin: 0; padding: 0; width: 210mm; height: 297mm; font-size: 10pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .print-container { display: none !important; }
            .header-container, .meta-container, .participants-container, .summary-container, .questions-container, .legend-container, .signature-container, .footer-container {
                width: 180mm !important; max-width: 180mm !important; margin-left: auto !important; margin-right: auto !important;
            }
            .questions-table { width: 180mm !important; }
            .section, tr { page-break-inside: avoid; }
        }
        
        @media screen {
            body { background: #f5f5f5; padding: 20px; }
            .main-container { background: white; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.1); width: calc(180mm + 40px); margin: 0 auto; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- KOPFZEILE -->
        <div class="header-container">
            <div class="title-section">
                <div class="report-title">Auditbericht: ${auditInfo.title}</div>
                <div class="report-subtitle">Zerstörungsfreie Prüfverfahren</div>
                <div class="report-standards">Standards: ${auditInfo.standards}</div>
            </div>
            <div class="logo-section">
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg" class="schaeffler-logo" alt="Schaeffler Logo">
            </div>
        </div>
        
        <!-- METADATEN -->
        <div class="meta-container">
            <div class="meta-grid">
                <div class="meta-column">
                    <div class="meta-row"><span class="meta-label">Audit-Verfahren:</span><span class="meta-value">${auditInfo.title}</span></div>
                    <div class="meta-row"><span class="meta-label">Standards:</span><span class="meta-value">${auditInfo.standards}</span></div>
                    <div class="meta-row"><span class="meta-label">Abteilung:</span><span class="meta-value">${extractDepartment()}</span></div>
                </div>
                <div class="meta-column">
                    <div class="meta-row"><span class="meta-label">Erstellt am:</span><span class="meta-value">${formattedDate}</span></div>
                    <div class="meta-row"><span class="meta-label">Geändert am:</span><span class="meta-value">${formattedDate}</span></div>
                    <div class="meta-row"><span class="meta-label">Dokument-ID:</span><span class="meta-value">${currentAuditData.meta.auditNumber || generateAuditNumber()}</span></div>
                </div>
            </div>
        </div>
        
        <!-- TEILNEHMER -->
        <div class="participants-container">
            <div class="container-title">Teilnehmer</div>
            <div class="participants-grid">
                <div class="participant-group">
                    <div class="group-label">Auditoren:</div>
                    <div class="group-content">${participants.auditors.join(', ') || 'Nicht angegeben'}</div>
                </div>
                <div class="participant-group">
                    <div class="group-label">Auditierte Personen:</div>
                    <div class="group-content">${participants.auditees.join(', ') || 'Nicht angegeben'}</div>
                </div>
            </div>
        </div>
        
        <!-- ZUSAMMENFASSUNG MIT AUSWERTUNG -->
        <div class="summary-container">
            <div class="summary-title">Zusammenfassung & Auswertung</div>
            <div class="results-overview">
                <div class="result-item"><div class="result-value">${totalPoints}/${maxPoints}</div><div class="result-label">Gesamtpunkte<br>erreicht/maximal</div></div>
                <div class="result-item"><div class="result-value">${pointsDistribution[10]}</div><div class="result-label"><span class="status-indicator status-ok"></span>I.O.<br>(10 Punkte)</div></div>
                <div class="result-item"><div class="result-value">${pointsDistribution[8] + pointsDistribution[4] + pointsDistribution[0]}</div><div class="result-label"><span class="status-indicator status-nok"></span>N.I.O.<br>(&lt; 10 Punkte)</div></div>
                <div class="result-item"><div class="result-value">${imagesCount}</div><div class="result-label">📷<br>Dokumentierte Bilder</div></div>
            </div>
            <div class="evaluation-details">
                <div class="evaluation-column">
                    <div class="grade-box">
                        <div class="grade-value">${grade}</div>
                        <div class="grade-text">${gradeText}</div>
                        <div class="grade-percentage">${percentage}% erreicht</div>
                    </div>
                    <div class="points-distribution">
                        <div class="distribution-title">Punkteverteilung</div>
                        <div class="distribution-grid">
                            <div class="distribution-item"><div class="distribution-points">10 Pkte</div><div class="distribution-count">${pointsDistribution[10]} Fragen</div></div>
                            <div class="distribution-item"><div class="distribution-points">8 Pkte</div><div class="distribution-count">${pointsDistribution[8]} Fragen</div></div>
                            <div class="distribution-item"><div class="distribution-points">4 Pkte</div><div class="distribution-count">${pointsDistribution[4]} Fragen</div></div>
                            <div class="distribution-item"><div class="distribution-points">0 Pkte</div><div class="distribution-count">${pointsDistribution[0]} Fragen</div></div>
                            <div class="distribution-item"><div class="distribution-points">Nicht bew.</div><div class="distribution-count">${pointsDistribution.unanswered} Fragen</div></div>
                        </div>
                    </div>
                </div>
                <div class="evaluation-column">
                    <div class="critical-issues">
                        <div class="critical-title">Kritische Fragen (≤ 4 Punkte)</div>
                        <div class="critical-list">
                            ${criticalQuestions.length > 0 ? 
                                criticalQuestions.map(q => `
                                    <div class="critical-item">
                                        <strong>${q.id} (${q.points} Pkte):</strong><br>
                                        ${q.text.substring(0, 80)}${q.text.length > 80 ? '...' : ''}<br>
                                        <em>${q.deviation.text.substring(0, 80)}${q.deviation.text.length > 80 ? '...' : ''}</em>
                                    </div>
                                `).join('') 
                                : '<div class="critical-item">Keine kritischen Fragen</div>'
                            }
                        </div>
                    </div>
                    <div class="recommendations">
                        <div class="recommendations-title">Empfehlungen</div>
                        <div class="recommendations-list">
                            ${recommendations.map(rec => `<div>${rec}</div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FRAGEN TABELLE -->
        <div class="questions-container">
            ${AUDIT_DATA[currentAuditType].map((section) => `
                <div class="section">
                    <div class="section-header">${section.title}</div>
                    <table class="questions-table" style="width: 180mm;">
                        <thead>
                            <tr>
                                <th class="col-id" style="width: 10mm;">ID</th>
                                <th class="col-question" style="width: 52mm;">Frage / Prüfpunkt</th>
                                <th class="col-evidence" style="width: 30mm;">Evidenz / Nachweis</th>
                                <th class="col-deviation" style="width: 32mm;">Abweichung / Maßnahme</th>
                                <th class="col-responsible" style="width: 25mm;">Verantwortlich</th>
                                <th class="col-points" style="width: 6mm;">Pkt.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${section.questions.map(question => {
                                const questionData = allQuestions.find(q => q.id === question.id) || {};
                                const points = questionData.points ?? null;
                                const evidence = questionData.evidence || '';
                                const deviation = questionData.deviation || {};
                                const hasImage = deviation.hasImage || false;
                                const imageData = imageStorage[question.id];
                                let statusClass = 'status-na';
                                if (points === 10) statusClass = 'status-ok';
                                else if (points !== null && points < 10) statusClass = 'status-nok';
                                return `
                                    <tr ${hasImage && imageData ? 'class="image-row"' : ''}>
                                        <td class="col-id" style="width: 10mm;">
                                            <div class="question-id">
                                                <span class="status-indicator ${statusClass}"></span>
                                                ${question.id}
                                            </div>
                                        </td>
                                        <td class="col-question" style="width: 52mm;">${question.text}</td>
                                        <td class="col-evidence" style="width: 30mm;">${evidence}</td>
                                        <td class="col-deviation" style="width: 32mm;">${deviation.text || ''}</td>
                                        <td class="col-responsible" style="width: 25mm;">${deviation.responsible || ''}</td>
                                        <td class="col-points" style="width: 6mm; text-align: center; font-weight: bold;">${points !== null ? points : ''}</td>
                                    </tr>
                                    ${hasImage && imageData ? `
                                        <tr class="image-row">
                                            <td colspan="6">
                                                <div class="report-image-container">
                                                    <img src="${imageData}" class="report-image" alt="Beweisfoto">
                                                </div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `).join('')}
        </div>
        
        <!-- LEGENDE -->
        <div class="legend-container">
            <span class="status-indicator status-ok"></span> = I.O. (10 Punkte) &nbsp;&nbsp; | &nbsp;&nbsp;
            <span class="status-indicator status-nok"></span> = N.I.O. (&lt; 10 Punkte) &nbsp;&nbsp; | &nbsp;&nbsp;
            <span class="status-indicator status-na"></span> = Nicht bewertet
        </div>
        
        <!-- UNTERSCHRIFTEN -->
        <div class="signature-container">
            <div style="text-align: center; margin-bottom: 6mm; font-weight: bold; color: #003865;">
                Unterschriften zur Bestätigung der Audit-Ergebnisse
            </div>
            <div class="signature-grid">
                <div class="signature-item">
                    Auditor / Prüfer<br>
                    <div class="signature-line"></div>
                    <div style="font-size: 8pt; margin-top: 1mm; color: #666;">Name, Datum, Unterschrift</div>
                </div>
                <div class="signature-item">
                    Auditierter / Bereichsverantwortlicher<br>
                    <div class="signature-line"></div>
                    <div style="font-size: 8pt; margin-top: 1mm; color: #666;">Name, Datum, Unterschrift</div>
                </div>
            </div>
        </div>
        
        <!-- DRUCK-STEUERUNG -->
        <div class="print-container">
            <button class="print-btn" onclick="window.print();">🖨️ BERICHTSDRUCK STARTEN</button>
        </div>
        
        <!-- FOOTER -->
        <div class="footer-container">
            Häusner Daniel | WI/SW2-PQT | ZfP Review Audit AE - 27.01.2026<br>
            Erstellt mit ZfP Review Audit | Generiert am: ${formatDateDMY(new Date())}
        </div>
    </div>
</body>
</html>`;
        }

        // === AUDITS CLOUD-SYNCHRONISIERUNG ===
        async function saveAuditToCloud() {
            if (!currentAuditType || !currentAuditData) {
                alert("Bitte zuerst ein Audit auswählen und Daten eingeben!");
                return;
            }
            saveCurrentAuditData();

            const localDeviations = extractDeviationsForLocal();

            localDeviations.forEach(newDeviation => {
                const newKey = newDeviation.key || deviationKey(newDeviation);
                const exists = deviations.some(d => {
                    const existingKey = d.key || deviationKey(d);
                    return existingKey === newKey;
                });
                if (!exists) deviations.push(newDeviation);
            });

            saveDeviations();

            const auditTypeLocal = (currentAuditData.meta.audit_type || currentAuditData.meta.auditType || currentAuditType);
            const auditNumberConsistent = currentAuditData.meta.auditNumber;

            const auditData = {
                meta: {
                    ...currentAuditData.meta,
                    audit_type: auditTypeLocal,
                    saved_at: new Date().toISOString(),
                    password: AUDIT_PASSWORD,
                    department: extractDepartment(),
                    audit_number: auditNumberConsistent,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                },
                participants: currentAuditData.participants,
                questions: currentAuditData.questions,
                images: currentAuditData.images
            };

            try {
                const auditResponse = await fetch(`${SUPABASE_URL}/rest/v1/audits`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(auditData)
                });

                if (!auditResponse.ok) throw new Error('Audit speichern fehlgeschlagen');

                const auditResult = await auditResponse.json();
                const auditId = auditResult[0]?.id;

                if (auditId) {
                    deviations = deviations.map(dev => {
                        const isSameAudit = (dev.audit_id === auditId)
                          || (dev.auditNumber && dev.auditNumber === auditNumberConsistent)
                          || (dev.auditId === currentAuditType && !dev.audit_id);
                        if (isSameAudit) {
                          const newKey = deviationKeyFromParts(auditId, dev.questionId);
                          return { ...dev, audit_id: auditId, key: newKey };
                        }
                        return dev;
                    });
                    saveDeviations();

                    const toUpload = deviations.filter(d => d.audit_id === auditId);
                    for (const deviation of toUpload) {
                        await saveSingleDeviationToCloud({ ...deviation, audit_id: auditId });
                    }
                }

                alert(`✅ Audit gespeichert!\n\n${localDeviations.length} Abweichungen in die Cloud übertragen.`);
                updateDeviationsProgressDisplay();
                updateCloudProgressDisplay();
            } catch (error) {
                console.error('Cloud-Fehler:', error);
                alert(`✅ Audit lokal gespeichert!\n\n${localDeviations.length} Abweichungen lokal übernommen.\n\nCloud: ${error.message}`);
            }

            setTimeout(() => { syncDeviationsWithCloud(); }, 1000);
        }

        // === CLOUD FUNKTIONEN (AUDITS) ===
        async function loadAuditsFromCloud() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?select=*&order=created_at.desc`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) {
                    const audits = await response.json();
                    displayAuditsList(audits);
                    const cloudProgressElement = document.getElementById('cloudProgress');
                    if (cloudProgressElement && audits) {
                        cloudProgressElement.textContent = `${audits.length} Audit${audits.length !== 1 ? 's' : ''}`;
                    }
                } else {
                    throw new Error('Laden fehlgeschlagen');
                }
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                const container = document.getElementById('auditsList');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        <p><strong>Fehler beim Laden:</strong></p>
                        <p>${error.message}</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            Bitte prüfe die Internetverbindung<br>
                            oder speichere ein neues Audit.
                        </p>
                    </div>
                `;
            }
        }

        function displayAuditsList(audits) {
            const container = document.getElementById('auditsList');
            container.innerHTML = '';
            if (!audits || audits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">Keine Audits gefunden</div>
                        <div style="font-size: 0.9em;">Speichere dein erstes Audit in der Cloud</div>
                    </div>
                `;
                return;
            }
            const tableContainer = document.createElement('div');
            tableContainer.className = 'audits-table-container';
            let tableHTML = `
                <table class="audits-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Typ</th>
                            <th style="text-align: left;">Audit</th>
                            <th style="text-align: left;">Verantwortlicher</th>
                            <th style="text-align: center;">Abteilung</th>
                            <th style="text-align: center;">Audit-Nr.</th>
                            <th style="text-align: center;">Abw. offen</th>
                            <th style="text-align: center;">Punkte</th>
                            <th style="text-align: center;">Datum</th>
                            <th style="text-align: center;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            audits.forEach(audit => {
                const auditDate = new Date(audit.meta?.saved_at || audit.created_at);
                const formattedDate = formatDateDMY(auditDate);
                let department = audit.meta?.department || '-';
                if (department.length > 12) department = department.substring(0, 12) + '...';
                let responsible = 'Nicht angegeben';
                if (audit.participants?.auditors?.length > 0) responsible = audit.participants.auditors[0];
                const auditNumber = audit.meta?.audit_number || '-';

                const questions = Array.isArray(audit.questions) ? audit.questions : [];
                const totalQuestions = questions.length;
                const achievedPointsAll = questions.reduce((sum, q) => sum + (q.points || 0), 0);
                const maxPointsAll = totalQuestions * 10;

                const openDeviationsCount = deviations.filter(d => d.audit_id === audit.id && d.status === 'offen').length;
                const devClass = deviationColorClass(openDeviationsCount);

                const widthPct = pointsWidthPct(achievedPointsAll, maxPointsAll);
                const barColor = pointsColorHsl(achievedPointsAll, maxPointsAll);
                const ratio = maxPointsAll > 0 ? (achievedPointsAll / maxPointsAll) : 0;
                const pointsLabel = maxPointsAll ? `${achievedPointsAll}/${maxPointsAll}` : '-';

                const auditType = normalizeAuditType(audit.meta?.audit_type || audit.meta?.auditType || '') || 'unknown';
                const auditIcons = { wirbelstrom: '⚡', magnetpulver: '🧲', nital: '🧪', ultraschall: '📡', unknown: '📋' };
                let title = audit.meta?.title || 'Unbenannt';
                if (title.length > 25) title = title.substring(0, 25) + '...';

                tableHTML += `
                    <tr>
                        <td class="audit-type-cell" data-label="Typ">
                            <div class="audit-type-icon" title="${auditType}">${auditIcons[auditType] || '📋'}</div>
                        </td>
                        <td class="audit-title-cell" data-label="Audit" title="${audit.meta?.title || 'Unbenannt'}">
                            <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;">${title}</div>
                        </td>
                        <td class="audit-title-cell" data-label="Verantwortlicher" title="${responsible}">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;">${responsible}</div>
                        </td>
                        <td data-label="Abteilung" title="${audit.meta?.department || ''}">
                            <div class="department-badge-centered">${department}</div>
                        </td>
                        <td data-label="Audit-Nr." title="${auditNumber}">
                            <div style="font-size: 0.8em; font-weight: 600; color: var(--text-tertiary);">${auditNumber}</div>
                        </td>
                        <td data-label="Abw. offen" title="Offene Abweichungen: ${openDeviationsCount}">
                            <div class="progress-circle-centered ${devClass}">${openDeviationsCount}</div>
                        </td>
                        <td data-label="Punkte" title="${maxPointsAll ? `${achievedPointsAll}/${maxPointsAll} Punkte` : '-'}">
                            <div class="points-bar">
                              <div class="points-bar__fill" style="width: ${widthPct}; background-color: ${barColor};">
                                ${ratio >= 0.2 ? pointsLabel : ''}
                              </div>
                              ${ratio < 0.2 ? `<div class="points-bar__label--outside">${pointsLabel}</div>` : ''}
                            </div>
                        </td>
                        <td class="date-centered" data-label="Datum">
                            <div><span class="date-main">${formattedDate}</span></div>
                        </td>
                        <td data-label="Aktionen">
                            <div class="actions-centered">
                                <button onclick="loadAuditFromCloudById('${audit.id}')" class="action-btn open" title="Audit öffnen">👁️</button>
                                ${audit.meta?.has_pdf ? `<button onclick="loadPDFFromCloud('${audit.id}')" class="action-btn pdf" title="PDF öffnen">📄</button>` : ''}
                                <button onclick="viewAuditReport('${audit.id}')" class="action-btn view" title="Bericht ansehen">🖨️</button>
                                <button onclick="deleteAuditFromCloud('${audit.id}')" class="action-btn delete" title="Audit löschen">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tableHTML += `
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.9em; color: var(--text-secondary);">
                    ${audits.length} Audit${audits.length !== 1 ? 's' : ''} gespeichert
                </div>
            `;
            tableContainer.innerHTML = tableHTML;
            container.appendChild(tableContainer);
        }

        async function loadAuditFromCloudById(auditId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?id=eq.${auditId}`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) {
                    const audits = await response.json();
                    if (audits.length > 0) {
                        const audit = audits[0];
                        if (audit.meta?.password !== AUDIT_PASSWORD) {
                            alert('❌ Ungültiges Passwort für dieses Audit');
                            return;
                        }
                        const auditTypeRaw = audit.meta?.audit_type || audit.meta?.auditType;
                        const auditType = normalizeAuditType(auditTypeRaw);
                        if (!auditType || !AUDIT_TYPES[auditType]) {
                            alert(`❌ Ungültiger Audit-Typ: "${auditTypeRaw ?? ''}"`);
                            return;
                        }
                        const auditDate = new Date(audit.meta?.saved_at || audit.created_at);
                        closeCloudModal();
                        setTimeout(() => {
                            const loadedParticipants = audit.participants || {};
                            const normalizedParticipants = {
                                auditors: Array.isArray(loadedParticipants.auditors) ? loadedParticipants.auditors : [],
                                auditees: Array.isArray(loadedParticipants.auditees) ? loadedParticipants.auditees : []
                            };

                            currentAuditData = {
                                meta: audit.meta || {},
                                participants: normalizedParticipants,
                                questions: Array.isArray(audit.questions) ? audit.questions : [],
                                images: audit.images || {}
                            };
                            allQuestions = currentAuditData.questions || [];
                            participants = currentAuditData.participants || { auditors: [], auditees: [] };
                            imageStorage = currentAuditData.images || {};
                            localStorage.setItem(`zfpAuditReview_${auditType}`, JSON.stringify(currentAuditData));
                            startAudit(auditType);
                            alert(`✅ Audit wurde geladen:\n\n${audit.meta?.title || 'Unbekannt'}\n${audit.meta?.department || ''}\n${formatDateDMY(auditDate)}`);
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('Ladefehler:', error);
                alert('❌ Fehler beim Laden: ' + error.message);
            }
        }

        function viewAuditReport(auditId) { loadAuditFromCloudByIdForReport(auditId); }

        async function loadAuditFromCloudByIdForReport(auditId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?id=eq.${auditId}`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) {
                    const audits = await response.json();
                    if (audits.length > 0) {
                        const audit = audits[0];
                        const originalAuditType = currentAuditType;
                        const originalAuditData = currentAuditData;
                        const auditTypeRaw = audit.meta?.audit_type || audit.meta?.auditType;
                        const normalizedType = normalizeAuditType(auditTypeRaw);
                        if (!normalizedType) { alert('❌ Ungültiger Audit-Typ'); return; }
                        currentAuditType = normalizedType;
                        currentAuditData = {
                            meta: audit.meta,
                            participants: audit.participants || { auditors: [], auditees: [] },
                            questions: audit.questions || [],
                            images: audit.images || {}
                        };
                        allQuestions = currentAuditData.questions || [];
                        generateReport();
                        currentAuditType = originalAuditType;
                        currentAuditData = originalAuditData;
                    }
                }
            } catch (error) {
                console.error('Fehler beim Laden für Report:', error);
                alert('Fehler beim Laden des Reports');
            }
        }

async function deleteAuditFromCloud(auditId) {
    if (!confirm('Sind Sie sicher, dass Sie dieses Audit aus der Cloud löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden.')) {
        return;
    }
    // Passwort prüfen
    const pw = prompt('Bitte Passwort eingeben, um das Audit zu löschen:');
    if (pw !== 'ZfP-Review') {
        alert('❌ Falsches Passwort. Löschvorgang abgebrochen.');
        return;
    }

    try {
        await fetch(`${SUPABASE_URL}/storage/v1/object/pdfs/audit_${auditId}.pdf`, {
            method: 'DELETE',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        }).catch(() => {});

        const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?id=eq.${auditId}`, {
            method: 'DELETE',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        if (!response.ok) throw new Error('Löschen fehlgeschlagen');

        alert('✅ Audit wurde aus der Cloud gelöscht!');
        loadAuditsFromCloud();
        loadDeviationsFromCloud();
    } catch (error) {
        console.error('Löschfehler:', error);
        alert('❌ Fehler beim Löschen: ' + error.message);
    }
}
        async function loadPDFFromCloud(auditId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/pdfs/audit_${auditId}.pdf`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (response.ok) {
                    const pdfBlob = await response.blob();
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    const pdfViewer = document.getElementById('pdfViewer');
                    pdfViewer.innerHTML = `<iframe src="${pdfUrl}" style="width: 100%; height: 100%; border: none;" title="PDF Viewer"></iframe>`;
                    document.getElementById('pdfModal').style.display = 'flex';
                } else {
                    throw new Error('PDF nicht gefunden');
                }
            } catch (error) {
                console.error('PDF-Fehler:', error);
                alert('❌ PDF konnte nicht geladen werden: ' + error.message);
            }
        }

        // === EVALUATION FUNKTION ===
        function showEvaluation() {
            const evaluation = document.getElementById('evaluation');
            const btn = document.getElementById('evaluationBtn');
            if (!evaluation) return;

            if (evaluation.classList.contains('active')) {
                evaluation.classList.remove('active');
                if (btn) btn.textContent = '📊 Auswertung';
            } else {
                evaluation.classList.add('active');
                if (btn) btn.textContent = '⬆️ Ausblenden';
                renderEvaluation();
            }
        }

        function renderEvaluation() {
            if (!allQuestions.length) return;
            const totalQuestions = allQuestions.length;
            const answeredQuestions = allQuestions.filter(q => q.points !== null).length;
            const totalPoints = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = totalQuestions * 10;
            const percentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
            const deviationsCount = allQuestions.filter(q => q.points !== null && q.points <= 8 && q.deviation && q.deviation.text && q.deviation.text.trim() !== '').length;
            const pointsDistribution = {
                0: allQuestions.filter(q => q.points === 0).length,
                4: allQuestions.filter(q => q.points === 4).length,
                8: allQuestions.filter(q => q.points === 8).length,
                10: allQuestions.filter(q => q.points === 10).length,
                unanswered: allQuestions.filter(q => q.points === null).length
            };
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 5px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-tertiary);">Gesamtauswertung</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="text-align: center; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Fragen</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--text-tertiary);">${answeredQuestions}/${totalQuestions}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Punkte</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--text-tertiary);">${totalPoints}/${maxPoints}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Erfüllung</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${getPointsColor(Math.round(percentage/10)*10)};">${percentage}%</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: var(--bg-secondary); border-radius: 4px;">
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Abweichungen</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${deviationsCount > 0 ? 'var(--points-0)' : 'var(--points-10)'}">${deviationsCount}</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 5px;">
                    <h3 style="margin-bottom: 10px; color: var(--text-tertiary);">Punkteverteilung</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                        ${[10, 8, 4, 0].map(points => `
                            <div style="text-align: center; padding: 6px; background: ${getPointsColor(points)}; color: white; border-radius: 4px;">
                                <div style="font-size: 0.8em;">${points} Punkte</div>
                                <div style="font-size: 1.1em; font-weight: bold;">${pointsDistribution[points]}</div>
                            </div>
                        `).join('')}
                        <div style="text-align: center; padding: 6px; background: var(--points-na); color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em;">Nicht bewertet</div>
                            <div style="font-size: 1.1em; font-weight: bold;">${pointsDistribution.unanswered}</div>
                        </div>
                    </div>
                </div>
            `;
            if (deviationsCount > 0) {
                const auditDeviations = allQuestions.filter(q => q.points !== null && q.points <= 8 && q.deviation && q.deviation.text && q.deviation.text.trim() !== '');
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: var(--deviation-bg); border-radius: 5px; border-left: 3px solid var(--deviation-border);">
                        <h3 style="margin-bottom: 10px; color: var(--deviation-border);">⚠️ Erfasste Abweichungen</h3>
                        <div style="font-size: 0.9em;">
                            ${auditDeviations.map(q => `
                                <div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                    <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 3px;">
                                        ${q.id} - ${q.points <= 4 ? 'Kritisch (' + q.points + 'P)' : 'Verbesserungspotenzial (' + q.points + 'P)'}
                                    </div>
                                    <div style="color: var(--text-secondary); margin-bottom: 3px; font-size: 0.9em;">
                                        ${q.text}
                                    </div>
                                    <div style="color: var(--text-primary); margin-bottom: 3px;">
                                        <strong>Abweichung:</strong> ${q.deviation.text}
                                    </div>
                                    ${q.deviation.responsible ? `<div style="color: var(--text-primary);"><strong>Verantwortlich:</strong> ${q.deviation.responsible}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            let recommendation = '';
            let recommendationColor = '';
            if (percentage >= 90) { recommendation = '✅ EXZELLENT - Das Audit wurde mit sehr hoher Punktzahl bestanden. Alle Anforderungen sind erfüllt oder übertroffen.'; recommendationColor = 'var(--points-10)'; }
            else if (percentage >= 80) { recommendation = '✅ GUT - Das Audit wurde bestanden. Es gibt nur geringfügige Abweichungen, die behoben werden sollten.'; recommendationColor = 'var(--points-8)'; }
            else if (percentage >= 70) { recommendation = '⚠️ BEFRIEDIGEND - Das Audit wurde bestanden, jedoch gibt es mehrere Abweichungen, die umgehend behoben werden müssen.'; recommendationColor = 'var(--points-4)'; }
            else if (percentage >= 60) { recommendation = '❌ AUSREICHEND - Das Audit wurde knapp bestanden. Es gibt erhebliche Abweichungen, die dringend behoben werden müssen.'; recommendationColor = 'var(--points-0)'; }
            else { recommendation = '❌ NICHT BESTANDEN - Das Audit wurde nicht bestanden. Es besteht erheblicher Handlungsbedarf.'; recommendationColor = 'var(--points-0)'; }
            html += `
                <div style="margin-top: 15px; padding: 10px; background: ${recommendationColor}20; border-radius: 5px; border-left: 3px solid ${recommendationColor};">
                    <h3 style="margin-bottom: 8px; color: ${recommendationColor};">Empfehlung</h3>
                    <div style="font-size: 0.95em; color: var(--text-primary);">${recommendation}</div>
                    ${deviationsCount > 0 ? `<div style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);"><strong>Hinweis:</strong> ${deviationsCount} Abweichung${deviationsCount !== 1 ? 'en' : ''} wurde${deviationsCount !== 1 ? 'n' : ''} erfasst und ${deviationsCount !== 1 ? 'sind' : 'ist'} im Abweichungsmanagement zu bearbeiten.</div>` : ''}
                </div>
            `;
            document.getElementById('evaluationContent').innerHTML = html;
        }

        function handleResize() {
            if (!currentAuditType) return;
            const isMobile = window.innerWidth <= 768;
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            if (isMobile) {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                if (allQuestionElements.length > 0) renderMobileQuestion();
            } else {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
            }
        }

        function updateProgressBarColor() {
            const progressBar = document.getElementById('auditProgressBar');
            if (progressBar) {
                const width = parseInt(progressBar.style.width) || 0;
                if (width === 100) progressBar.style.backgroundColor = 'var(--progress-100)';
                else if (width >= 75) progressBar.style.backgroundColor = 'var(--progress-75)';
                else if (width >= 50) progressBar.style.backgroundColor = 'var(--progress-50)';
                else if (width >= 25) progressBar.style.backgroundColor = 'var(--progress-25)';
                else progressBar.style.backgroundColor = 'var(--progress-0)';
            }
        }

        function setupDesktopEventListeners() {
            // no-op
        }
    </script>
</body>
</html>
