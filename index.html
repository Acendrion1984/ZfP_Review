<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZfP Audit-Checkliste - Schaeffler</title>
    <style>
        /* === DARK MODE VARIABLEN === */
        :root {
            /* Light Mode Variablen */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #7f8c8d;
            --text-tertiary: #2c3e50;
            --border-color: #bdc3c7;
            --border-light: #ecf0f1;
            --shadow-color: rgba(0,0,0,0.1);
            
            /* Header */
            --header-border: #2c3e50;
            --header-bg: #34495e;
            
            /* Buttons */
            --btn-back: #7f8c8d;
            --btn-report: #8e44ad;
            --btn-danger: #e74c3c;
            --btn-info: #17a2b8;
            --btn-desktop: #f39c12;
            --btn-success: #27ae60;
            --btn-warning: #f39c12;
            --btn-export: #3498db;
            --btn-import: #9b59b6;
            --btn-cloud: #1abc9c;
            --btn-audits: #8e44ad;
            --btn-deviations: #e74c3c;
            
            /* Audit Buttons */
            --audit-et: #3498db;
            --audit-mt: #e74c3c;
            --audit-ne: #2ecc71;
            --audit-ut: #9b59b6;
            --audit-cloud: #f39c12;
            --audit-deviations: #e74c3c;
            
            /* Progress */
            --progress-bg: #ecf0f1;
            --progress-100: #27ae60;
            --progress-75: #2ecc71;
            --progress-50: #f39c12;
            --progress-25: #e67e22;
            --progress-0: #e74c3c;
            
            /* Questions */
            --question-border: #3498db;
            --question-bg: #f8f9fa;
            --points-0: #e74c3c;
            --points-4: #f39c12;
            --points-8: #2ecc71;
            --points-10: #27ae60;
            --points-na: #95a5a6;
            
            /* Deviation */
            --deviation-bg: #fff3f3;
            --deviation-border: #e74c3c;
            --deviation-open: #e74c3c;
            --deviation-closed: #27ae60;
            --deviation-completed: #95a5a6;
            
            /* Input Fields */
            --input-bg: #ffffff;
            --input-border: #ddd;
            --input-text: #333;
            
            /* Modal */
            --modal-bg: rgba(0,0,0,0.8);
            --modal-content-bg: #ffffff;
            
            /* Status Indicators */
            --status-ok: #27ae60;
            --status-nok: #e74c3c;
            --status-na: #95a5a6;
            
            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-blur: blur(10px);
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                /* Dark Mode Variablen */
                --bg-primary: #121212;
                --bg-secondary: #1e1e1e;
                --bg-tertiary: #2d2d2d;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --text-tertiary: #3498db;
                --border-color: #444444;
                --border-light: #333333;
                --shadow-color: rgba(0,0,0,0.3);
                
                /* Header */
                --header-border: #3498db;
                --header-bg: #2c3e50;
                
                /* Buttons - Darker versions */
                --btn-back: #5d6d7e;
                --btn-report: #6c3483;
                --btn-danger: #c0392b;
                --btn-info: #117a8b;
                --btn-desktop: #b9770e;
                --btn-success: #229954;
                --btn-warning: #b9770e;
                --btn-export: #2874a6;
                --btn-import: #7d3c98;
                --btn-cloud: #16a085;
                --btn-audits: #6c3483;
                --btn-deviations: #c0392b;
                
                /* Audit Buttons - Darker */
                --audit-et: #2874a6;
                --audit-mt: #c0392b;
                --audit-ne: #239b56;
                --audit-ut: #7d3c98;
                --audit-cloud: #e67e22;
                --audit-deviations: #c0392b;
                
                /* Progress */
                --progress-bg: #34495e;
                --progress-100: #27ae60;
                --progress-75: #2ecc71;
                --progress-50: #f39c12;
                --progress-25: #e67e22;
                --progress-0: #c0392b;
                
                /* Questions */
                --question-border: #3498db;
                --question-bg: #2d2d2d;
                --points-0: #e74c3c;
                --points-4: #f39c12;
                --points-8: #2ecc71;
                --points-10: #27ae60;
                --points-na: #7f8c8d;
                
                /* Deviation */
                --deviation-bg: #3a1f1f;
                --deviation-border: #c0392b;
                --deviation-open: #c0392b;
                --deviation-closed: #229954;
                --deviation-completed: #5d6d7e;
                
                /* Input Fields */
                --input-bg: #2d2d2d;
                --input-border: #444444;
                --input-text: #e0e0e0;
                
                /* Modal */
                --modal-bg: rgba(0,0,0,0.9);
                --modal-content-bg: #1e1e1e;
                
                /* Status Indicators */
                --status-ok: #27ae60;
                --status-nok: #e74c3c;
                --status-na: #7f8c8d;
                
                /* Glass Effect - Dark */
                --glass-bg: rgba(30, 30, 30, 0.3);
                --glass-border: rgba(255, 255, 255, 0.1);
                --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }
        }
        
        /* === GLASS EFFECT STYLES === */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 10px;
        }
        
        /* === ALLE EXISTIERENDEN STYLES === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            padding: 6px;
            font-size: 14px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        header {
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--header-border);
        }
        
        h1 {
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-size: 1.3em;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        /* === KONTROLLELEMENTE === */
        .controls-row {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
            flex-wrap: nowrap;
            justify-content: space-between;
        }
        
        .controls-row button {
            padding: 5px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75em;
            min-height: 30px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.2s ease;
        }
        
        .btn-back { background: var(--btn-back); color: white; }
        .btn-report { background: var(--btn-report); color: white; }
        .btn-danger { background: var(--btn-danger); color: white; }
        .btn-info { background: var(--btn-info); color: white; }
        .btn-desktop { background: var(--btn-desktop); color: white; }
        .btn-success { background: var(--btn-success); color: white; }
        .btn-warning { background: var(--btn-warning); color: white; }
        .btn-export { background: var(--btn-export); color: white; }
        .btn-import { background: var(--btn-import); color: white; }
        .btn-cloud { background: var(--btn-cloud); color: white; }
        .btn-audits { background: var(--btn-audits); color: white; }
        .btn-deviations { background: var(--btn-deviations); color: white; }
        
        button:hover { 
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* === MODAL STYLES === */
        .cloud-modal,
        .deviations-modal,
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .cloud-modal-content,
        .deviations-modal-content,
        .image-modal-content {
            background: var(--modal-content-bg);
            padding: 25px;
            border-radius: 10px;
            max-width: 95%;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            min-width: 300px;
        }
        
        .image-modal-content {
            max-width: 90%;
            width: auto;
            padding: 15px;
        }
        
        .image-modal-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            border: 2px solid var(--border-color);
        }

        /* Tabellen Layout für Cloud Audits und Abweichungen */
        .audits-table,
        .deviations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
            table-layout: fixed;
        }

        .audits-table thead,
        .deviations-table thead {
            background: var(--header-bg);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Alle Header zentrieren */
        .audits-table th,
        .deviations-table th {
            padding: 12px 10px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid var(--header-border);
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Alle Zellen zentrieren */
        .audits-table td,
        .deviations-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
            height: 60px;
            overflow: hidden;
            text-align: center;
        }

        /* Spaltenbreiten für Cloud Audits */
        .audits-table th:nth-child(1),
        .audits-table td:nth-child(1) {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        .audits-table th:nth-child(2),
        .audits-table td:nth-child(2) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            text-align: left;
        }

        .audits-table th:nth-child(3),
        .audits-table td:nth-child(3) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .audits-table th:nth-child(4),
        .audits-table td:nth-child(4) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .audits-table th:nth-child(5),
        .audits-table td:nth-child(5) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .audits-table th:nth-child(6),
        .audits-table td:nth-child(6) {
            width: 180px;
            min-width: 180px;
            max-width: 180px;
        }

        .audits-table th:nth-child(7),
        .audits-table td:nth-child(7) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .audits-table th:nth-child(8),
        .audits-table td:nth-child(8) {
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        /* Spaltenbreiten für Abweichungen */
        .deviations-table th:nth-child(1),
        .deviations-table td:nth-child(1) {
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }

        .deviations-table th:nth-child(2),
        .deviations-table td:nth-child(2) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            text-align: left;
        }

        .deviations-table th:nth-child(3),
        .deviations-table td:nth-child(3) {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            text-align: left;
        }

        .deviations-table th:nth-child(4),
        .deviations-table td:nth-child(4) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            text-align: left;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .deviations-table th:nth-child(5),
        .deviations-table td:nth-child(5) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .deviations-table th:nth-child(6),
        .deviations-table td:nth-child(6) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .deviations-table th:nth-child(7),
        .deviations-table td:nth-child(7) {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .deviations-table th:nth-child(8),
        .deviations-table td:nth-child(8) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        /* Spezifische Zentrierung für verschiedene Elemente */
        .audit-type-cell,
        .deviation-type-cell {
            text-align: center;
            padding: 5px !important;
        }

        .audit-type-icon,
        .deviation-type-icon {
            font-size: 1.8em;
            display: block;
            margin: 0 auto;
            text-align: center;
        }

        .audit-title-cell,
        .deviation-audit-cell {
            text-align: left;
            padding-left: 10px;
        }

        /* Abweichungstext mit Zeilenumbruch */
.deviation-text-cell {
    text-align: left;
    word-wrap: break-word;
    white-space: normal;
    line-height: 1.4;
    max-height: 150px;  /* Maximale Höhe mit Scroll */
    overflow-y: auto;   /* Scroll wenn zu lang */
    padding: 8px;
    font-size: 0.9em;
}


        .department-badge-centered,
        .responsible-badge-centered {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 80px;
            max-width: 110px;
            margin: 0 auto;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .year-badge-centered,
        .date-badge-centered {
            background: #2ecc71;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 700;
            display: inline-block;
            text-align: center;
            min-width: 60px;
            margin: 0 auto;
        }

        .progress-circle-centered {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            margin: 0 auto;
            color: white;
        }

        .progress-high { background: #2ecc71; }
        .progress-medium { background: #f39c12; }
        .progress-low { background: #e74c3c; }

        .standards-centered {
            text-align: center;
            padding: 8px 5px;
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .date-centered {
            text-align: center;
            padding: 5px;
        }

        .date-main {
            font-weight: 600;
            color: var(--text-tertiary);
            font-size: 0.9em;
            display: block;
            text-align: center;
        }

        .date-time {
            font-size: 0.8em;
            color: var(--text-secondary);
            opacity: 0.8;
            display: block;
            text-align: center;
        }

        .actions-centered {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            width: fit-content;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 40px;
            justify-content: center;
        }

        .action-btn.open {
            background: var(--audit-cloud);
            color: white;
        }

        .action-btn.delete {
            background: var(--btn-danger);
            color: white;
        }

        .action-btn.complete {
            background: var(--btn-success);
            color: white;
        }

        .action-btn.image {
            background: #3498db;
            color: white;
        }

        .action-btn.view {
            background: var(--btn-info);
            color: white;
        }

        /* Status Badge für Abweichungen */
        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 90px;
            margin: 0 auto;
        }

        .status-open {
            background: var(--deviation-open);
            color: white;
        }

        .status-closed {
            background: var(--deviation-closed);
            color: white;
        }

        .status-completed {
            background: var(--deviation-completed);
            color: white;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .filter-btn.active {
            background: var(--btn-info);
            color: white;
            border-color: var(--btn-info);
        }

        /* Mobile Anpassungen */
        @media (max-width: 768px) {
            .audits-table,
            .deviations-table {
                display: table;
                width: 100%;
                min-width: 800px;
            }
            
            .audits-table thead,
            .deviations-table thead {
                display: table-header-group;
            }
            
            .audits-table tbody tr,
            .deviations-table tbody tr {
                display: table-row;
                margin-bottom: 0;
                border: none;
                border-radius: 0;
                padding: 0;
                text-align: left;
            }
            
            .audits-table td,
            .deviations-table td {
                display: table-cell;
                width: auto !important;
                border: 1px solid var(--border-light);
                padding: 8px 5px;
                height: auto;
                text-align: center;
            }
            
            /* Entferne die data-label Pseudo-Elemente für Mobil */
            .audits-table td:before,
            .deviations-table td:before {
                display: none;
            }
            
            /* Container für horizontales Scroll hinzufügen */
            .audits-table-container,
            .deviations-table-container {
                overflow-x: auto;
                overflow-y: hidden;
                max-height: 70vh;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Sicherstellen, dass die Tabelle nicht zu breit wird */
            .audits-table,
            .deviations-table {
                table-layout: auto;
            }
            
            /* Mobile-spezifische Anpassungen für kleine Spalten */
            .audits-table th,
            .audits-table td,
            .deviations-table th,
            .deviations-table td {
                padding: 6px 4px;
                font-size: 0.8em;
            }
            
            @media (max-width: 480px) {
                .audits-table th:nth-child(3),
                .audits-table td:nth-child(3),
                .deviations-table th:nth-child(4),
                .deviations-table td:nth-child(4) {
                    min-width: 80px;
                }
                
                .audits-table th:nth-child(5),
                .audits-table td:nth-child(5),
                .deviations-table th:nth-child(6),
                .deviations-table td:nth-child(6) {
                    min-width: 60px;
                }
                
                .audits-table th:nth-child(8),
                .audits-table td:nth-child(8),
                .deviations-table th:nth-child(8),
                .deviations-table td:nth-child(8) {
                    min-width: 100px;
                }
            }
        }
        
        .cloud-modal h3,
        .deviations-modal h3 {
            margin-bottom: 15px;
            color: var(--text-tertiary);
            text-align: center;
        }

        /* Cloud Button Wrapper mit Glass Effect */
        .cloud-button-wrapper,
        .deviations-button-wrapper {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
            text-align: center;
            width: 100%;
        }

        .cloud-button-wrapper .audit-btn,
        .deviations-button-wrapper .audit-btn {
            width: 80%;
            max-width: 500px;
            min-width: 250px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90px;
            transition: all 0.3s ease;
        }

        .cloud-button-wrapper .audit-btn {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.8), rgba(41, 128, 185, 0.8));
        }

        .deviations-button-wrapper .audit-btn {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.8), rgba(192, 57, 43, 0.8));
        }

        /* Glass Effect für Hauptbuttons */
        .cloud-button-wrapper .audit-btn,
        .deviations-button-wrapper .audit-btn,
        .audit-btn.cloud,
        .audit-btn.deviations {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Hover Effect für Glass Buttons */
        .cloud-button-wrapper .audit-btn:hover,
        .deviations-button-wrapper .audit-btn:hover,
        .audit-btn.cloud:hover,
        .audit-btn.deviations:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Etwas größerer Icon für die Buttons */
        .cloud-button-wrapper .audit-btn .btn-icon,
        .deviations-button-wrapper .audit-btn .btn-icon {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        /* Etwas größerer Text für die Buttons */
        .cloud-button-wrapper .audit-btn span,
        .deviations-button-wrapper .audit-btn span {
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* Responsive Anpassungen */
        @media (max-width: 768px) {
            .cloud-button-wrapper,
            .deviations-button-wrapper {
                margin-top: 20px;
                padding-top: 15px;
            }
            
            .cloud-button-wrapper .audit-btn,
            .deviations-button-wrapper .audit-btn {
                width: 90%;
                max-width: 350px;
                min-width: 200px;
                padding: 12px 15px;
                min-height: 80px;
            }
            
            .cloud-button-wrapper .audit-btn .btn-icon,
            .deviations-button-wrapper .audit-btn .btn-icon {
                font-size: 1.6em;
            }
            
            .cloud-button-wrapper .audit-btn span,
            .deviations-button-wrapper .audit-btn span {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .cloud-button-wrapper .audit-btn,
            .deviations-button-wrapper .audit-btn {
                width: 95%;
                max-width: 300px;
                min-width: 180px;
                padding: 10px 12px;
                min-height: 75px;
            }
            
            .cloud-button-wrapper .audit-btn .btn-icon,
            .deviations-button-wrapper .audit-btn .btn-icon {
                font-size: 1.5em;
            }
        }

        /* === DRUCK-STYLES FÜR DEN BERICHT === */
        @media print {
            body * {
                visibility: hidden;
            }
            .report-container, .report-container * {
                visibility: visible;
            }
            .report-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
        }

        /* === REST DER EXISTIERENDEN STYLES === */
        .audit-selection {
            text-align: center;
            margin: 15px 0;
        }
        
        .audit-selection h2 {
            color: var(--text-tertiary);
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        .audit-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .audit-btn {
            padding: 12px 8px;
            background: var(--audit-et);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .audit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .audit-btn.wirbelstrom { background: var(--audit-et); }
        .audit-btn.magnetpulver { background: var(--audit-mt); }
        .audit-btn.nital { background: var(--audit-ne); }
        .audit-btn.ultraschall { background: var(--audit-ut); }
        .audit-btn.cloud { background: linear-gradient(135deg, rgba(243, 156, 18, 0.8), rgba(230, 126, 34, 0.8)); }
        .audit-btn.deviations { background: linear-gradient(135deg, rgba(231, 76, 60, 0.8), rgba(192, 57, 43, 0.8)); }
        
        .audit-btn .btn-icon {
            font-size: 1.6em;
            margin-bottom: 6px;
        }
        
        .audit-btn .btn-progress {
            margin-top: 4px;
            font-size: 0.7em;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 35px;
        }

        .participants-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--btn-export);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .participants-section h3 {
            color: var(--text-tertiary);
            margin-bottom: 8px;
            text-align: center;
            font-size: 0.9em;
        }
        
        .participants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .participant-group {
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            transition: background-color 0.3s ease;
        }
        
        .participant-group h4 {
            color: var(--text-tertiary);
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 3px;
            font-size: 0.8em;
        }
        
        .participant-input-container {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .participant-input {
            flex: 1;
            padding: 4px 5px;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.8em;
            background: var(--input-bg);
            color: var(--input-text);
            transition: all 0.3s ease;
        }
        
        .add-participant {
            background: var(--btn-success);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.65em;
            width: 24px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        
        .participant-list {
            margin-top: 5px;
            max-height: 80px;
            overflow-y: auto;
            font-size: 0.75em;
        }
        
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .remove-participant {
            background: var(--btn-danger);
            color: white;
            border: none;
            padding: 1px 5px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.7em;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .audit-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.8em;
            background: var(--bg-tertiary);
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            flex-wrap: wrap;
        }
        
        .audit-status span {
            flex: 1;
            text-align: center;
            min-width: 100px;
            margin: 2px 0;
        }
        
        .audit-progress-container {
            margin: 10px 0;
            background: var(--progress-bg);
            border-radius: 5px;
            height: 10px;
            overflow: hidden;
        }
        
        .audit-progress-bar {
            height: 100%;
            background: var(--progress-100);
            border-radius: 5px;
            transition: width 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.5em;
            font-weight: bold;
        }

        .section {
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        
        .section-header {
            background: var(--header-bg);
            color: white;
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .section-header:hover {
            background: var(--header-border);
        }
        
        .section-header h2 { 
            margin: 0; 
            font-size: 1em;
        }
        
        .section-header span {
            transition: transform 0.3s;
        }
        
        .section.expanded .section-header span {
            transform: rotate(90deg);
        }
        
        .section-content {
            padding: 8px;
            display: none;
        }
        
        .section.expanded .section-content { 
            display: block; 
        }

        .question {
            margin-bottom: 8px;
            padding: 10px;
            background: var(--question-bg);
            border-radius: 4px;
            border-left: 3px solid var(--question-border);
            transition: background-color 0.3s ease;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .question-text { 
            flex: 1; 
            font-weight: 500;
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        .question-id {
            background: var(--question-border);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 8px;
            white-space: nowrap;
            transition: background-color 0.3s ease;
        }
        
        .points-options {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .points-option {
            flex: 1;
            min-width: 40px;
            padding: 6px 2px;
            border: 2px solid var(--border-color);
            border-radius: 3px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        
        .points-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .points-option.selected {
            border-color: var(--question-border);
            background: var(--question-border);
            color: white;
        }
        
        .points-option[data-points="0"] { 
            border-color: var(--points-0); 
            color: var(--points-0); 
        }
        
        .points-option[data-points="0"].selected { 
            background: var(--points-0); 
            color: white; 
        }
        
        .points-option[data-points="4"] { 
            border-color: var(--points-4); 
            color: var(--points-4); 
        }
        
        .points-option[data-points="4"].selected { 
            background: var(--points-4); 
            color: #333; 
        }
        
        .points-option[data-points="8"] { 
            border-color: var(--points-8); 
            color: var(--points-8); 
        }
        
        .points-option[data-points="8"].selected { 
            background: var(--points-8); 
            color: white; 
        }
        
        .points-option[data-points="10"] { 
            border-color: var(--points-10); 
            color: var(--points-10); 
        }
        
        .points-option[data-points="10"].selected { 
            background: var(--points-10); 
            color: white; 
        }
        
        .points-display {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            padding: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        
        .evidence {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 0.85em;
            background: var(--input-bg);
            color: var(--input-text);
            transition: all 0.3s ease;
        }
        
        .deviation-section {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background-color: var(--deviation-bg);
            border-radius: 3px;
            border-left: 3px solid var(--deviation-border);
            transition: background-color 0.3s ease;
        }
        
        .deviation-section h4 { 
            color: var(--deviation-border); 
            margin-bottom: 5px; 
            font-size: 0.85em;
        }
        
        .deviation-field, .responsible-field {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--deviation-border);
            border-radius: 3px;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 0.85em;
            background: var(--input-bg);
            color: var(--input-text);
            transition: all 0.3s ease;
        }
        
        .responsible-field {
            border-color: var(--input-border);
            min-height: auto;
        }
        
        .image-upload { 
            margin-bottom: 8px; 
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 5px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 5px 8px;
            background: var(--question-border);
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            display: none;
        }
        
        .remove-image {
            background: var(--btn-danger);
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.75em;
            transition: background-color 0.3s ease;
        }

        .mobile-view .participants-section {
            padding: 8px;
            margin-bottom: 8px;
        }
        
        .mobile-participant-type {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .mobile-participant-type-btn {
            flex: 1;
            padding: 4px;
            border: 1px solid var(--question-border);
            border-radius: 3px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
            font-size: 0.7em;
            transition: all 0.3s ease;
        }
        
        .mobile-participant-type-btn.active {
            background: var(--question-border);
            color: white;
        }
        
        .mobile-participant-input-container {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .mobile-participant-input {
            flex: 1;
            padding: 4px 5px;
            border: 1px solid var(--input-border);
            border-radius: 3px;
            font-size: 0.8em;
            background: var(--input-bg);
            color: var(--input-text);
            transition: all 0.3s ease;
        }
        
        .mobile-add-participant {
            background: var(--btn-success);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            transition: background-color 0.3s ease;
        }

        .mobile-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            align-items: center;
        }
        
        .mobile-nav button {
            padding: 6px 10px;
            font-size: 0.8em;
            min-width: 80px;
            border: none;
            border-radius: 4px;
            background: var(--btn-back);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #mobileCounter {
            font-size: 0.85em;
            padding: 0 10px;
            text-align: center;
            font-weight: bold;
        }

        .mobile-section-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-bottom: 8px;
        }
        
        .section-btn { 
            flex: 1; 
            min-width: 60px; 
            font-size: 0.7em;
            padding: 4px 5px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: none;
            border-radius: 3px;
            background: var(--question-border);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .evaluation {
            display: none;
            margin-top: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            background: var(--bg-secondary);
            transition: background-color 0.3s ease;
        }
        
        .evaluation.active { 
            display: block; 
        }
        
        .evaluation h2 {
            font-size: 1em;
            margin-bottom: 8px;
            color: var(--text-tertiary);
        }

        .desktop-view { display: block; }
        .mobile-view { display: none; }
        .audit-content { display: none; }
        .audit-content.active { display: block; }
        .audit-selection { display: none; }
        .audit-selection.active { display: block; }

        footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .creator-info {
            font-weight: bold;
            color: var(--text-tertiary);
            margin-top: 4px;
            font-size: 0.9em;
        }
        
        .version-info {
            margin-top: 2px;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        /* Dark Mode Optimierungen */
        @media (prefers-color-scheme: dark) {
            .points-option[data-points="4"].selected {
                color: #1a1a1a !important;
            }
            
            .file-input-wrapper input[type="file"] {
                color: var(--text-primary);
            }
            
            .image-preview {
                background: #1a1a1a;
            }
            
            .remove-image:hover {
                background: #e74c3c;
            }
            
            .mobile-participant-type-btn {
                border-color: var(--border-color);
            }
            
            .audit-btn.cloud,
            .audit-btn.deviations {
                background: linear-gradient(135deg, rgba(52, 152, 219, 0.3), rgba(41, 128, 185, 0.3));
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            .container { 
                padding: 8px !important; 
            }
            
            .desktop-view { 
                display: none !important; 
            }
            .mobile-view { 
                display: block !important; 
            }
            
            .audit-buttons {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .audit-btn {
                padding: 10px 6px;
                min-height: 70px;
                font-size: 0.85em;
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                padding-left: 12px;
            }
            
            .audit-btn .btn-icon {
                font-size: 1.4em;
                margin-right: 8px;
                margin-bottom: 0;
            }
            
            .audit-btn .btn-progress {
                margin-left: auto;
                margin-top: 0;
            }
            
            .audit-btn.wirbelstrom::before { content: ""; }
            .audit-btn.magnetpulver::before { content: ""; }
            .audit-btn.nital::before { content: ""; }
            .audit-btn.ultraschall::before { content: ""; }
            
            .controls-row {
                gap: 3px;
                margin-bottom: 6px;
            }
            
            .controls-row button {
                padding: 4px 5px;
                font-size: 0.7em;
                min-height: 26px;
            }
            
            .participants-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .question {
                padding: 8px;
            }
            
            .question-text {
                font-size: 0.85em;
            }
            
            .question-id {
                font-size: 0.7em;
                margin-left: 5px;
            }
            
            .points-options {
                gap: 2px;
            }
            
            .points-option {
                min-width: 30px;
                padding: 4px 2px;
                font-size: 0.8em;
            }
            
            .mobile-nav button {
                min-width: 60px;
                padding: 5px 8px;
            }
            
            .mobile-section-selector {
                gap: 2px;
            }
            
            .section-btn {
                min-width: 50px;
                font-size: 0.65em;
                padding: 3px 4px;
            }
            
            .evidence, .deviation-field, .responsible-field {
                font-size: 0.8em;
                padding: 5px 6px;
            }
        }

        @media (max-width: 360px) {
            .container { 
                padding: 6px !important; 
            }
            
            .audit-btn {
                padding: 8px 5px;
                min-height: 60px;
                font-size: 0.8em;
            }
            
            .controls-row button {
                padding: 3px 4px;
                font-size: 0.65em;
                min-height: 24px;
            }
            
            .question-text {
                font-size: 0.8em;
            }
            
            .mobile-nav button {
                min-width: 50px;
                padding: 4px 6px;
            }
            
            #mobileCounter {
                font-size: 0.75em;
            }
        }
        
        @media (min-width: 769px) {
            body {
                font-size: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .controls-row button {
                padding: 8px 10px;
                font-size: 0.85em;
                min-height: 36px;
            }
            
            .participants-section {
                padding: 12px;
            }
            
            .participant-input {
                padding: 6px 8px;
                font-size: 0.9em;
            }
            
            .question {
                padding: 12px;
            }
            
            .question-text {
                font-size: 1em;
            }
            
            .question-id {
                font-size: 0.85em;
                padding: 3px 8px;
            }
            
            .points-option {
                min-width: 45px;
                padding: 8px 2px;
                font-size: 1em;
            }
            
            .evidence, .deviation-field, .responsible-field {
                padding: 8px 10px;
                font-size: 0.9em;
                min-height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ZfP Audit-Checkliste</h1>
            <div class="subtitle">Zerstörungsfreie Prüfverfahren - Schaeffler</div>
        </header>

        <!-- CLOUD MODAL -->
        <div id="cloudModal" class="cloud-modal">
            <div class="cloud-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-light); padding-bottom: 15px;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">☁️</span>
                        <span>Cloud-Audits</span>
                    </h3>
                    <button onclick="closeCloudModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                
                <div id="auditsList" class="audits-list">
                    <!-- Audits werden hier geladen -->
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light);">
                    <button onclick="closeCloudModal()" style="padding: 10px 25px; background: var(--btn-back); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        ← Zurück zur Startseite
                    </button>
                </div>
            </div>
        </div>

        <!-- ABWEICHUNGEN MODAL -->
        <div id="deviationsModal" class="deviations-modal">
            <div class="deviations-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-light); padding-bottom: 15px;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em;">⚠️</span>
                        <span>Abweichungen</span>
                    </h3>
                    <button onclick="closeDeviationsModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                
                <!-- Filter Controls -->
                <div class="filter-controls">
                    <button class="filter-btn active" onclick="filterDeviations('all')">Alle</button>
                    <button class="filter-btn" onclick="filterDeviations('open')">Offen</button>
                    <button class="filter-btn" onclick="filterDeviations('completed')">Abgeschlossen</button>
                </div>
                
                <div id="deviationsList" class="audits-list">
                    <!-- Abweichungen werden hier geladen -->
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light);">
                    <button onclick="closeDeviationsModal()" style="padding: 10px 25px; background: var(--btn-back); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                        ← Zurück zur Startseite
                    </button>
                </div>
            </div>
        </div>

        <!-- BILD MODAL -->
        <div id="imageModal" class="image-modal">
            <div class="image-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Bildansicht</h3>
                    <button onclick="closeImageModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 5px 10px; border-radius: 50%;">
                        ×
                    </button>
                </div>
                <img id="modalImage" src="" alt="Bildansicht">
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="closeImageModal()" style="padding: 8px 20px; background: var(--btn-back); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Schließen
                    </button>
                </div>
            </div>
        </div>

        <!-- AUDIT AUSWAHL -->
        <div id="auditSelection" class="audit-selection active">
            <h2>Audit-Verfahren auswählen:</h2>
            <div class="audit-buttons">
                <button class="audit-btn wirbelstrom" data-audit="wirbelstrom">
                    <div class="btn-icon">⚡</div>
                    <span>Wirbelstromprüfung</span>
                    <div class="btn-progress" id="wirbelstromProgress">0%</div>
                </button>
                <button class="audit-btn magnetpulver" data-audit="magnetpulver">
                    <div class="btn-icon">🧲</div>
                    <span>Magnetpulverprüfung</span>
                    <div class="btn-progress" id="magnetpulverProgress">0%</div>
                </button>
                <button class="audit-btn nital" data-audit="nital">
                    <div class="btn-icon">🧪</div>
                    <span>Nital-Ätzen</span>
                    <div class="btn-progress" id="nitalProgress">0%</div>
                </button>
                <button class="audit-btn ultraschall" data-audit="ultraschall">
                    <div class="btn-icon">📡</div>
                    <span>Ultraschallprüfung</span>
                    <div class="btn-progress" id="ultraschallProgress">0%</div>
                </button>
            </div>
            
            <div class="cloud-button-wrapper">
                <button class="audit-btn cloud" onclick="openCloudModal()">
                    <div class="btn-icon">☁️</div>
                    <span>Cloud-Audits</span>
                    <div class="btn-progress" id="cloudProgress">0 Audits</div>
                </button>
            </div>
            
            <div class="deviations-button-wrapper">
                <button class="audit-btn deviations" onclick="openDeviationsModal()">
                    <div class="btn-icon">⚠️</div>
                    <span>Abweichungen</span>
                    <div class="btn-progress" id="deviationsProgress">0</div>
                </button>
            </div>
        </div>

        <!-- AUDIT CONTENT -->
        <div id="auditContent" class="audit-content">
            <!-- ERSTE ZEILE FÜR BUTTONS -->
            <div class="controls-row">
                <button class="btn-back" id="backBtn">← Zurück</button>
                <button class="btn-report" id="reportBtn">📋 Bericht</button>
                <button class="btn-danger" id="resetBtn">🗑️ Reset</button>
                <button class="btn-info" id="evaluationBtn">📊 Auswertung</button>
            </div>
            
            <!-- ZWEITE ZEILE FÜR BUTTONS -->
            <div class="controls-row">
                <button class="btn-desktop" id="toggleViewBtn">🖥️ Desktop</button>
                <button class="btn-export" onclick="exportSingleFile()" title="Audit als JSON exportieren">📤 Export</button>
                <button class="btn-import" onclick="document.getElementById('fileInput').click()" title="Audit aus JSON importieren">📥 Import</button>
                <button class="btn-cloud" onclick="saveAuditToCloud()" title="In Cloud speichern">💾 Cloud</button>
            </div>
            
            <!-- Hidden File Input für Import -->
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadData(event)">

            <!-- Desktop Teilnehmer -->
            <div class="participants-section desktop-view">
                <h3>📋 Teilnehmer</h3>
                <div class="participants-grid">
                    <div class="participant-group">
                        <h4>👨‍💼 Auditor</h4>
                        <div class="participant-input-container">
                            <input type="text" class="participant-input" id="auditorInput" placeholder="Name">
                            <button class="add-participant" onclick="addParticipant('auditor')">+</button>
                        </div>
                        <div class="participant-list" id="auditorList"></div>
                    </div>
                    <div class="participant-group">
                        <h4>👥 Auditiert</h4>
                        <div class="participant-input-container">
                            <input type="text" class="participant-input" id="auditeeInput" placeholder="Name">
                            <button class="add-participant" onclick="addParticipant('auditee')">+</button>
                        </div>
                        <div class="participant-list" id="auditeeList"></div>
                    </div>
                </div>
            </div>

            <!-- Mobile Teilnehmer -->
            <div class="participants-section mobile-view">
                <h3>📋 Teilnehmer</h3>
                <div class="mobile-participant-type">
                    <button class="mobile-participant-type-btn active" data-type="auditor">👨‍💼 Auditor</button>
                    <button class="mobile-participant-type-btn" data-type="auditee">👥 Auditiert</button>
                </div>
                <div class="mobile-participant-input-container">
                    <input type="text" class="mobile-participant-input" id="mobileParticipantInput" placeholder="Name">
                    <button class="mobile-add-participant" onclick="addMobileParticipant()">+</button>
                </div>
                <div class="participant-list" id="mobileParticipantList"></div>
            </div>

            <!-- Statusanzeige -->
            <div class="audit-status">
                <span class="status-part">Fortschritt: <strong id="progressText">0%</strong></span>
                <span class="separator"> </span>
                <span class="status-part">Frage <strong id="answeredCount">0</strong>/<strong id="totalCount">24</strong></span>
                <span class="separator"> </span>
                <span class="status-part"><strong id="pointsTotal">0</strong>/<strong id="pointsMax">240</strong> Punkte</span>
            </div>
            <div class="audit-progress-container">
                <div class="audit-progress-bar" id="auditProgressBar" style="width: 0%">0%</div>
            </div>

            <!-- Desktop Ansicht -->
            <div class="desktop-view" id="desktopView">
                <div id="auditSections"></div>
            </div>

            <!-- Mobile Ansicht -->
            <div class="mobile-view" id="mobileView">
                <div class="mobile-section-selector" id="sectionSelector"></div>
                <div id="mobileQuestions"></div>
                <div class="mobile-nav">
                    <button class="btn-secondary" id="prevBtn">← Zurück</button>
                    <span id="mobileCounter">Frage 1/1</span>
                    <button class="btn-secondary" id="nextBtn">Weiter →</button>
                </div>
            </div>

            <!-- Evaluation -->
            <div class="evaluation" id="evaluation">
                <h2>Auswertung</h2>
                <div id="evaluationContent"></div>
            </div>
        </div>

        <footer>
            <p>ZfP Audit-Checkliste &copy; 2026 Schaeffler</p>
            <div class="version-info">Version AE, 27.01.2026</div>
            <div class="creator-info">Ersteller: Daniel Häusner, WI/SW2-PQT</div>
        </footer>
    </div>

    <script>
        // === SUPABASE KONFIGURATION ===
        const SUPABASE_URL = 'https://agyktwyeahwrcsmaoibe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_fiPWCIMlRxbt3fy6DXf8iQ_JibUoEUo';
        const AUDIT_PASSWORD = 'ZfPOperatorAudit';

        // === DARK MODE DETECTION AND INITIALIZATION ===
        function initializeDarkMode() {
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            
            function updateColorScheme(e) {
                const isDark = e.matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
                updateProgressBarColor();
            }
            
            updateColorScheme(prefersDarkScheme);
            prefersDarkScheme.addListener(updateColorScheme);
            document.body.classList.add(prefersDarkScheme.matches ? 'dark-mode' : 'light-mode');
        }
        
        function updateProgressBarColor() {
            const progressBar = document.getElementById('auditProgressBar');
            if (!progressBar) return;
            
            const width = parseInt(progressBar.style.width) || 0;
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (width === 100) {
                progressBar.style.backgroundColor = 'var(--progress-100)';
            } else if (width >= 75) {
                progressBar.style.backgroundColor = 'var(--progress-75)';
            } else if (width >= 50) {
                progressBar.style.backgroundColor = 'var(--progress-50)';
            } else if (width >= 25) {
                progressBar.style.backgroundColor = 'var(--progress-25)';
            } else {
                progressBar.style.backgroundColor = 'var(--progress-0)';
            }
        }
        
        function updateCurrentAuditProgress() {
            if (!allQuestions.length) return;
            
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.points !== null).length;
            const points = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('progressText').textContent = `${percent}%`;
            document.getElementById('pointsTotal').textContent = points;
            document.getElementById('pointsMax').textContent = maxPoints;
            
            const progressBar = document.getElementById('auditProgressBar');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
            
            if (percent === 100) {
                progressBar.style.backgroundColor = 'var(--progress-100)';
            } else if (percent >= 75) {
                progressBar.style.backgroundColor = 'var(--progress-75)';
            } else if (percent >= 50) {
                progressBar.style.backgroundColor = 'var(--progress-50)';
            } else if (percent >= 25) {
                progressBar.style.backgroundColor = 'var(--progress-25)';
            } else {
                progressBar.style.backgroundColor = 'var(--progress-0)';
            }
            
            if (currentAuditType) {
                updateAuditProgressDisplays();
            }
        }
        
        function getPointsColor(points) {
            const colors = {
                0: "var(--points-0)",
                4: "var(--points-4)",
                8: "var(--points-8)",
                10: "var(--points-10)"
            };
            return colors[points] || "var(--points-na)";
        }

        // === KONSTANTEN UND DATENSTRUKTUREN ===
        const AUDIT_TYPES = {
            wirbelstrom: {
                id: 'wirbelstrom',
                title: 'Wirbelstromprüfung',
                short: 'ET',
                color: 'var(--audit-et)',
                icon: '⚡',
                standards: 'S245006-1 / S245008-1 / S245007-1 / S245012'
            },
            magnetpulver: {
                id: 'magnetpulver',
                title: 'Magnetpulverprüfung',
                short: 'MT',
                color: 'var(--audit-mt)',
                icon: '🧲',
                standards: 'S245008-2 / S245012'
            },
            nital: {
                id: 'nital',
                title: 'Nital-Ätzen',
                short: 'NE',
                color: 'var(--audit-ne)',
                icon: '🧪',
                standards: 'S245013-1 / S245012-1'
            },
            ultraschall: {
                id: 'ultraschall',
                title: 'Ultraschallprüfung',
                short: 'UT',
                color: 'var(--audit-ut)',
                icon: '📡',
                standards: 'S245009-3 / S245012'
            }
        };

        // VOLLSTÄNDIGE AUDIT-DATEN
        const AUDIT_DATA = {
            wirbelstrom: [
                {
                    title: "1.1 Personal und Qualifikation",
                    short: "1.1 Personal",
                    questions: [
                        { id: "1.1.1", text: "Ist der Level-2-Experte für die Wirbelstromprüfung qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "1.1.2", text: "Sind alle Bediener für die Wirbelstromprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "1.1.3", text: "Ist ein Verantwortlicher (Supervisor) für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                        { id: "1.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "1.2 Ausrüstung und Plausibilitätsprüfung",
                    short: "1.2 Ausrüstung",
                    questions: [
                        { id: "1.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert?" },
                        { id: "1.2.2", text: "Wird die jährliche Überprüfung durchgeführt und dokumentiert?" },
                        { id: "1.2.3", text: "Wird die Maschine einschließlich relevanter Messgeräte in SAP überwacht? (Maschine, Restmagnetfeldmessgerät, Magnetfeldstärkemessgerät)" },
                        { id: "1.2.4", text: "Befindet sich die Maschine in einem guten technischen Zustand? (Software gemäß IATF, Hardware)" }
                    ]
                },
                {
                    title: "1.3 Prüfanweisungen",
                    short: "1.3 Anweisungen",
                    questions: [
                        { id: "1.3.1", text: "Ist die Prüfanweisung vollständig? (Parameter, Gerät, Sonde, Grenzwerte, Maßnahmen, Unterschrift eines Level-2-Prüfers)" },
                        { id: "1.3.2", text: "Ist der Prüfprozess im Control1- oder Prüfplan beschrieben?" },
                        { id: "1.3.3", text: "Existiert eine Prüfdokumentation, die Informationen über Prüfergebnisse und Prozessentscheidungen enthält (siehe 1.3.1)?" },
                        { id: "1.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                        { id: "1.3.5", text: "Sind die Messungen des Restmagnetismus im Prüfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "1.4 Referenzteile S285066",
                    short: "1.4 Referenzteile",
                    questions: [
                        { id: "1.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                        { id: "1.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "1.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "1.4.4", text: "Werden die Referenzteile überwacht?" }
                    ]
                },
                {
                    title: "1.5 Prozess",
                    short: "1.5 Prozess",
                    questions: [
                        { id: "1.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähig?" },
                        { id: "1.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "1.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                        { id: "1.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "1.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "1.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "1.5.7", text: "Ist die Schutzausrüstung funktionsfähig und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                    ]
                }
            ],
            magnetpulver: [
                {
                    title: "2.1 Qualifikation",
                    short: "2.1 Qualifikation",
                    questions: [
                        { id: "2.1.1", text: "Ist der Level-2-Experte für Magnetpulverprüfung (MPI) qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "2.1.2", text: "Sind alle Bediener für die Magnetpulverprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "2.1.3", text: "Ist ein Verantwortlicher für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                        { id: "2.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "2.2 Ausrüstung und Plausibilitätsprüfung",
                    short: "2.2 Ausrüstung",
                    questions: [
                        { id: "2.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert? (ASTM-Röhre, MTU Nr. 3)" },
                        { id: "2.2.2", text: "Wird die monatliche Überprüfung der UV-Lampe durchgeführt und dokumentiert?" },
                        { id: "2.2.3", text: "Wird die jährliche Überprüfung durchgeführt und dokumentiert?" },
                        { id: "2.2.4", text: "Wird die Maschine in SAP überwacht (Software gemäß IATF)?" },
                        { id: "2.2.5", text: "Sind die Magnetisierungswerte stabil?" },
                        { id: "2.2.6", text: "Werden die Messgeräte überwacht und in SAP geführt? (UV-Meter, Lux-Meter, Magnetfeldstärkemessgerät inkl. Referenzmagnet)" },
                        { id: "2.2.7", text: "Wird ein Restmagnetfeldmessgerät (Gaussmeter) verwendet? (Handhabung, Überwachung, SAP, Referenzblock)" },
                        { id: "2.2.8", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gemäß IATF, Hardware)" }
                    ]
                },
                {
                    title: "2.3 Prüfanweisungen",
                    short: "2.3 Anweisungen",
                    questions: [
                        { id: "2.3.1", text: "Ist die Prüfanweisung vollständik? (Parameter, Gerät, Grenzwerte, Maßnahmen, Unterschrift Level 2)" },
                        { id: "2.3.2", text: "Ist der Prüfprozess im Control- oder Prüfplan enthalten?" },
                        { id: "2.3.3", text: "Existiert eine Prüfdokumentation mit Ergebnissen und Prozessentscheidungen (siehe 1.3.1)?" },
                        { id: "2.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der neuesten Version vor?" },
                        { id: "2.3.5", text: "Sind Restmagnetismus-Messungen im Prüfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "2.4 Referenzteile S285066",
                    short: "2.4 Referenzteile",
                    questions: [
                        { id: "2.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                        { id: "2.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "2.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "2.4.4", text: "Werden die Referenzteile überwacht?" }
                    ]
                },
                {
                    title: "2.5 Prozess",
                    short: "2.5 Prozess",
                    questions: [
                        { id: "2.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähig?" },
                        { id: "2.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "2.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                        { id: "2.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "2.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "2.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "2.5.7", text: "Ist die Schutzausrüstung funktionsfähig und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                    ]
                }
            ],
            nital: [
                {
                    title: "3.1 Qualifikation",
                    short: "3.1 Qualifikation",
                    questions: [
                        { id: "3.1.1", text: "Ist der Level-2-Experte für Nital-Ätzprüfung qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "3.1.2", text: "Sind alle Bediener für die Nital-Ätzprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "3.1.3", text: "Ist ein Verantwortlicher für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                        { id: "3.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "3.2 Ausrüstung und Plausibilitätsprüfung",
                    short: "3.2 Ausrüstung",
                    questions: [
                        { id: "3.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert?" },
                        { id: "3.2.2", text: "Entspricht der Reinigungsprozess der Norm? (Parameter, Ultraschall)" },
                        { id: "3.2.3", text: "Entspricht der Ätzprozess der Norm? (Material, chemische Analyse, Überwachung)" },
                        { id: "3.2.4", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gemäß IATF, Hardware)" }
                    ]
                },
                {
                    title: "3.3 Prüfanweisungen",
                    short: "3.3 Anweisungen",
                    questions: [
                        { id: "3.3.1", text: "Ist die Prüfanweisung vollständig? (Parameter, Gerät, Grenzwerte, Maßnahmen, Unterschrift eines Level-2-Prüfers)" },
                        { id: "3.3.2", text: "Ist der Prüfprozess im Control- oder Prüfplan beschrieben?" },
                        { id: "3.3.3", text: "Existiert eine Prüfdokumentation, die Informationen über Prüfergebnisse und Prozessentscheidungen enthält?" },
                        { id: "3.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                        { id: "3.3.5", text: "Sind die Messungen des Restmagnetismus im Prüfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "3.4 Referenzteile S285066",
                    short: "3.4 Referenzteile",
                    questions: [
                        { id: "3.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                        { id: "3.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "3.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "3.4.4", text: "Werden die Referenzteile überwacht?" }
                    ]
                },
                {
                    title: "3.5 Prozess",
                    short: "3.5 Prozess",
                    questions: [
                        { id: "3.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähig?" },
                        { id: "3.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "3.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                        { id: "3.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "3.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "3.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "3.5.7", text: "Ist die Schutzausrüstung funktionsfähik und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                    ]
                }
            ],
            ultraschall: [
                {
                    title: "4.1 Qualifikation",
                    short: "4.1 Qualifikation",
                    questions: [
                        { id: "4.1.1", text: "Ist der Level-2-Experte für Ultraschallprüfung (UT) qualifiziert? (Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "4.1.2", text: "Sind alle Bediener für die Ultraschallprüfung geschult? (Schulungsplan, Zertifikat, gültiger Sehtestnachweis)" },
                        { id: "4.1.3", text: "Ist ein Verantwortlicher für die Methode definiert, und erfüllt dieser die Anforderungen gemäß S245012?" },
                        { id: "4.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "4.2 Ausrüstung und Plausibilitätsprüfung",
                    short: "4.2 Ausrüstung",
                    questions: [
                        { id: "4.2.1", text: "Wird die tägliche Plausibilitätsprüfung durchgeführt und dokumentiert?" },
                        { id: "4.2.2", text: "Wird die jährliche Überprüfung durchgeführt und dokumentiert?" },
                        { id: "4.2.3", text: "Wird die Maschine einschließlich relevanter Messgeräte in SAP überwacht? (Maschine, Restmagnetfeldmessgerät, Magnetfeldstärkemessgerät, Software gemäß IATF)" },
                        { id: "4.2.4", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gemäß IATF, Hardware)" }
                    ]
                },
                {
                    title: "4.3 Prüfanweisungen",
                    short: "4.3 Anweisungen",
                    questions: [
                        { id: "4.3.1", text: "Ist die Prüfanweisung vollständig? (Parameter, Gerät, Grenzwerte, Maßnahmen, Unterschrift eines Level-2-Prüfers)" },
                        { id: "4.3.2", text: "Ist der Prüfprozess im Control- oder Prüfplan beschrieben?" },
                        { id: "4.3.3", text: "Existiert eine Prüfdokumentation, die Informationen über Prüfergebnisse und Prozessentscheidungen enthält?" },
                        { id: "4.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                        { id: "4.3.5", text: "Sind die Messungen des Restmagnetismus im Prüfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "4.4 Referenzteile S285066",
                    short: "4.4 Referenzteile",
                    questions: [
                        { id: "4.4.1", text: "Existieren Referenzteile zur Maschinenüberprüfung gemäß S285066 (Merkmale der Fehler)?" },
                        { id: "4.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "4.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "4.4.4", text: "Werden die Referenzteile überwacht?" }
                    ]
                },
                {
                    title: "4.5 Prozess",
                    short: "4.5 Prozess",
                    questions: [
                        { id: "4.5.1", text: "Entsprechen die Parameter und die Sonde der Prüfanweisung, und ist die Anlage funktionsfähik?" },
                        { id: "4.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "4.5.3", text: "Wird das Zwischenbehälter-Prinzip angewendet?" },
                        { id: "4.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "4.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "4.5.6", text: "Sind die Randbedingungen für die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "4.5.7", text: "Ist die Schutzausrüstung funktionsfähik und wird sie verwendet? (Persönliche Schutzausrüstung / Maschinenschutz)" }
                    ]
                }
            ]
        };

        // === GLOBALE VARIABLEN ===
        let currentAuditType = null;
        let currentAuditData = null;
        let allQuestions = [];
        let allQuestionElements = [];
        let currentMobileQuestion = 0;
        let imageStorage = {};
        let participants = { auditors: [], auditees: [] };
        let currentMobileParticipantType = 'auditor';
        let deviations = []; // Array für alle Abweichungen
        let currentDeviationFilter = 'all'; // Filter für Abweichungen

async function saveAuditToCloud() {
    if (!currentAuditType || !currentAuditData) {
        alert("Bitte zuerst ein Audit auswählen und Daten eingeben!");
        return;
    }
    
    saveCurrentAuditData();
    
    // 1. Abweichungen für lokale Liste extrahieren
    const localDeviations = extractDeviationsForLocal();
    
    // 2. Lokale deviations Liste aktualisieren
    localDeviations.forEach(newDeviation => {
        // Prüfe ob diese Abweichung bereits existiert
        const exists = deviations.some(d => 
            d.auditId === newDeviation.auditId && 
            d.questionId === newDeviation.questionId &&
            d.status === 'offen'
        );
        
        if (!exists) {
            deviations.push(newDeviation);
        }
    });
    
    // 3. Lokale deviations speichern
    saveDeviations();
    
    // 4. Audit in Cloud speichern
    const auditData = {
        meta: {
            ...currentAuditData.meta,
            savedAt: new Date().toISOString(),
            password: AUDIT_PASSWORD,
            department: extractDepartment(),
            auditNumber: generateAuditNumber()
        },
        participants: currentAuditData.participants,
        questions: currentAuditData.questions,
        images: currentAuditData.images
    };
    
    try {
        // Audit in Supabase speichern
        const auditResponse = await fetch(`${SUPABASE_URL}/rest/v1/audits`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Prefer': 'return=representation'
            },
            body: JSON.stringify(auditData)
        });
        
        if (auditResponse.ok) {
            const auditResult = await auditResponse.json();
            const auditId = auditResult[0]?.id;
            
            if (auditId && localDeviations.length > 0) {
                // Abweichungen in Cloud-Tabelle speichern
                const cloudDeviations = localDeviations.map(dev => ({
                    ...dev,
                    audit_id: auditId
                }));
                
                for (const deviation of cloudDeviations) {
                    await fetch(`${SUPABASE_URL}/rest/v1/deviations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify(deviation)
                    });
                }
            }
            
            alert(`✅ Audit gespeichert!\n\n${localDeviations.length} Abweichungen in die Liste übernommen.`);
            updateDeviationsProgressDisplay();
            updateCloudProgressDisplay();
            
        } else {
            throw new Error('Audit speichern fehlgeschlagen');
        }
        
    } catch (error) {
        console.error('Cloud-Fehler:', error);
        alert(`✅ Audit lokal gespeichert!\n\n${localDeviations.length} Abweichungen in die Liste übernommen.\n\nCloud: ${error.message}`);
    }
}

function extractDeviationsForLocal() {
    const newDeviations = [];
    
    allQuestions.forEach(q => {
        if (q.points !== null && q.points <= 8 && q.deviation && q.deviation.text && q.deviation.text.trim() !== '') {
            const deviationId = `${currentAuditType}_${q.id}_${Date.now()}`;
            
            newDeviations.push({
                id: deviationId,
                auditId: currentAuditType,
                auditTitle: AUDIT_TYPES[currentAuditType].title,
                auditNumber: generateAuditNumber(),
                department: extractDepartment(),
                questionId: q.id,
                questionText: q.text,
                deviationText: q.deviation.text,
                responsible: q.deviation.responsible || 'Nicht angegeben',
                date: new Date().toISOString(),
                status: 'offen',
                points: q.points,
                hasImage: q.deviation.hasImage || false,
                imageData: q.deviation.hasImage ? imageStorage[q.id] : null
            });
        }
    });
    
    return newDeviations;
}

// Statt extractDeviationsForCloud() verwenden wir diese Funktion:
function extractDeviationsForCloud(auditId) {
    return deviations
        .filter(d => d.auditId === currentAuditType && d.status === 'offen')
        .map(d => ({
            audit_id: auditId,
            audit_type: d.auditId,
            audit_title: d.auditTitle,
            audit_number: d.auditNumber,
            department: d.department,
            question_id: d.questionId,
            question_text: d.questionText,
            deviation_text: d.deviationText,
            responsible: d.responsible,
            status: d.status,
            points: d.points,
            has_image: d.hasImage,
            image_data: d.imageData,
            deviation_date: new Date(d.date).toISOString().split('T')[0]
        }));
}

// Hilfsfunktionen
function extractDepartment() {
    if (participants?.auditees?.length > 0) {
        const firstAuditee = participants.auditees[0];
        const match = firstAuditee.match(/(WI\/[A-Z0-9-]+)/);
        return match ? match[1] : 'Nicht angegeben';
    }
    return 'Nicht angegeben';
}

function generateAuditNumber() {
    const date = new Date();
    const year = date.getFullYear().toString().substr(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `AUD-${year}${month}${day}-${random}`;
}
        
        async function loadAuditsFromCloud() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const audits = await response.json();
                    displayAuditsList(audits);
                    
                    // Aktualisiere die Anzahl auf dem Button
                    const cloudProgressElement = document.getElementById('cloudProgress');
                    if (cloudProgressElement && audits) {
                        cloudProgressElement.textContent = `${audits.length} Audit${audits.length !== 1 ? 's' : ''}`;
                    }
                } else {
                    throw new Error('Laden fehlgeschlagen');
                }
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                // Bei Fehler trotzdem versuchen, die Liste zu zeigen
                const container = document.getElementById('auditsList');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        <p><strong>Fehler beim Laden:</strong></p>
                        <p>${error.message}</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            Bitte prüfe die Internetverbindung<br>
                            oder speichere ein neues Audit.
                        </p>
                    </div>
                `;
            }
        }
        
        function displayAuditsList(audits) {
            const container = document.getElementById('auditsList');
            container.innerHTML = '';
            
            if (!audits || audits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">Keine Audits gefunden</div>
                        <div style="font-size: 0.9em;">Speichere dein erstes Audit in der Cloud</div>
                    </div>
                `;
                return;
            }
            
            // Container für die Tabelle mit festen Abmessungen
            const tableContainer = document.createElement('div');
            tableContainer.className = 'audits-table-container';
            
            // Tabellen-Header
            let tableHTML = `
                <table class="audits-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Typ</th>
                            <th style="text-align: left;">Audit</th>
                            <th style="text-align: center;">Abteilung</th>
                            <th style="text-align: center;">Audit-Nr.</th>
                            <th style="text-align: center;">Progress</th>
                            <th style="text-align: center;">Standards</th>
                            <th style="text-align: center;">Datum</th>
                            <th style="text-align: center;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            audits.forEach(audit => {
                // Extrahiere Datum
                const auditDate = new Date(audit.meta?.saved_at || audit.created_at);
                const formattedDate = auditDate.toLocaleDateString('de-DE');
                const formattedTime = auditDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                // Extrahiere Abteilung
                let department = audit.meta?.department || '-';
                if (department.length > 12) {
                    department = department.substring(0, 12) + '...';
                }
                
                // Audit-Nummer
                const auditNumber = audit.meta?.auditNumber || '-';
                
                // Progress berechnen
                const answeredQuestions = audit.questions?.filter(q => q.points !== null).length || 0;
                const totalQuestions = audit.questions?.length || 0;
                const progressPercent = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
                
                // Progress-Klasse
                let progressClass = 'progress-low';
                if (progressPercent >= 75) progressClass = 'progress-high';
                else if (progressPercent >= 50) progressClass = 'progress-medium';
                
                // Audit-Typ
                const auditType = audit.meta?.auditType || 'unknown';
                const auditIcons = {
                    wirbelstrom: '⚡',
                    magnetpulver: '🧲',
                    nital: '🧪',
                    ultraschall: '📡',
                    unknown: '📋'
                };
                
                // Standards kürzen
                let standards = audit.meta?.standards || '-';
                if (standards.length > 20) {
                    standards = standards.substring(0, 20) + '...';
                }
                
                // Titel kürzen
                let title = audit.meta?.title || 'Unbenannt';
                if (title.length > 25) {
                    title = title.substring(0, 25) + '...';
                }
                
                // Tabellen-Zeile
                tableHTML += `
                    <tr>
                        <!-- Typ (zentriert) -->
                        <td class="audit-type-cell" data-label="Typ">
                            <div class="audit-type-icon" title="${auditType}">
                                ${auditIcons[auditType] || '📋'}
                            </div>
                        </td>
                        
                        <!-- Audit Titel (linksbündig) -->
                        <td class="audit-title-cell" data-label="Audit" title="${audit.meta?.title || 'Unbenannt'}">
                            <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;">
                                ${title}
                            </div>
                        </td>
                        
                        <!-- Abteilung (zentriert) -->
                        <td data-label="Abteilung" title="${audit.meta?.department || ''}">
                            <div class="department-badge-centered">
                                ${department}
                            </div>
                        </td>
                        
                        <!-- Audit-Nummer (zentriert) -->
                        <td data-label="Audit-Nr." title="${auditNumber}">
                            <div style="font-size: 0.8em; font-weight: 600; color: var(--text-tertiary);">
                                ${auditNumber}
                            </div>
                        </td>
                        
                        <!-- Progress (zentriert) -->
                        <td data-label="Progress" title="${answeredQuestions}/${totalQuestions} Fragen">
                            <div class="progress-circle-centered ${progressClass}">
                                ${progressPercent}%
                            </div>
                        </td>
                        
                        <!-- Standards (zentriert) -->
                        <td data-label="Standards" title="${audit.meta?.standards || '-'}">
                            <div class="standards-centered">
                                ${standards}
                            </div>
                        </td>
                        
                        <!-- Datum (zentriert) -->
                        <td class="date-centered" data-label="Datum">
                            <div>
                                <span class="date-main">${formattedDate}</span>
                                <span class="date-time">${formattedTime}</span>
                            </div>
                        </td>
                        
                        <!-- Aktionen (zentriert) -->
                        <td data-label="Aktionen">
                            <div class="actions-centered">
                                <button onclick="loadAuditFromCloud('${audit.id}')" class="action-btn open" title="Audit öffnen">
                                    👁️
                                </button>
                                <button onclick="viewAuditReport('${audit.id}')" class="action-btn view" title="Bericht ansehen">
                                    📋
                                </button>
                                <button onclick="deleteAuditFromCloud('${audit.id}')" class="action-btn delete" title="Audit löschen">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.9em; color: var(--text-secondary);">
                    ${audits.length} Audit${audits.length !== 1 ? 's' : ''} gespeichert
                </div>
            `;
            
            tableContainer.innerHTML = tableHTML;
            container.appendChild(tableContainer);
        }
        
        function viewAuditReport(auditId) {
            // Hier könnte die Funktion zum Anzeigen des Berichts implementiert werden
            alert('Bericht-Funktion für Audit-ID: ' + auditId + '\n\nDiese Funktion zeigt den gespeicherten Bericht aus der Cloud an.');
            // In einer echten Implementierung würde hier der Bericht generiert/angezeigt werden
        }
        
        async function loadAuditFromCloud(auditId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?id=eq.${auditId}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const audits = await response.json();
                    if (audits.length > 0) {
                        const audit = audits[0];
                        
                        // Passwort prüfen
                        if (audit.meta?.password !== AUDIT_PASSWORD) {
                            alert('❌ Ungültiges Passwort für dieses Audit');
                            return;
                        }
                        
                        const auditType = audit.meta?.auditType;
                        
                        if (!auditType || !AUDIT_TYPES[auditType]) {
                            alert('❌ Ungültiger Audit-Typ');
                            return;
                        }
                        
                        // Cloud-Modal schließen (zurück zur Startseite)
                        closeCloudModal();
                        
                        // Kurze Pause, dann Audit laden
                        setTimeout(() => {
                            // Audit laden
                            currentAuditData = {
                                meta: audit.meta,
                                participants: audit.participants || { auditors: [], auditees: [] },
                                questions: audit.questions || [],
                                images: audit.images || {}
                            };
                            
                            allQuestions = currentAuditData.questions || [];
                            participants = currentAuditData.participants || { auditors: [], auditees: [] };
                            imageStorage = currentAuditData.images || {};
                            
                            localStorage.setItem(`zfpAuditReview_${auditType}`, JSON.stringify(currentAuditData));
                            
                            // Zum Audit wechseln
                            startAudit(auditType);
                            
                            alert(`✅ Audit wurde geladen:\n\n${audit.meta?.title || 'Unbenannt'}\nAudit-Nr.: ${audit.meta?.auditNumber || 'N/A'}`);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert(`❌ Fehler: ${error.message}`);
            }
        }
        
        async function deleteAuditFromCloud(auditId) {
            if (!confirm('Sind Sie sicher, dass Sie dieses Audit aus der Cloud löschen möchten?')) {
                return;
            }
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?id=eq.${auditId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    alert('✅ Audit erfolgreich gelöscht!');
                    
                    // Aktualisiere die Anzahl auf dem Button SOFORT
                    await loadActualAuditCountFromCloud();
                    
                    // Liste aktualisieren
                    await loadAuditsFromCloud();
                } else {
                    throw new Error('Löschen fehlgeschlagen');
                }
            } catch (error) {
                console.error('Fehler beim Löschen:', error);
                alert('❌ Fehler beim Löschen des Audits');
            }
        }

        // === ABWEICHUNGEN FUNKTIONEN ===
        function loadDeviations() {
            const savedDeviations = localStorage.getItem('zfpAuditDeviations');
            if (savedDeviations) {
                deviations = JSON.parse(savedDeviations);
            } else {
                deviations = [];
            }
            updateDeviationsProgressDisplay();
        }
        
        function saveDeviations() {
            localStorage.setItem('zfpAuditDeviations', JSON.stringify(deviations));
            updateDeviationsProgressDisplay();
            
            // Versuche auch in der Cloud zu speichern
            saveDeviationsToCloud();
        }
        
        async function saveDeviationsToCloud() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/deviations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        deviations: deviations,
                        savedAt: new Date().toISOString(),
                        password: AUDIT_PASSWORD
                    })
                });
                
                if (!response.ok) {
                    console.log('Abweichungen konnten nicht in der Cloud gespeichert werden');
                }
            } catch (error) {
                console.log('Cloud-Speicherung für Abweichungen nicht verfügbar');
            }
        }
        
        function updateDeviationsProgressDisplay() {
            const openDeviationsCount = deviations.filter(d => d.status === 'offen').length;
            const totalDeviationsCount = deviations.length;
            const deviationsProgressElement = document.getElementById('deviationsProgress');
            if (deviationsProgressElement) {
                deviationsProgressElement.textContent = `${openDeviationsCount}/${totalDeviationsCount}`;
            }
        }
        
        function displayDeviationsList() {
            const container = document.getElementById('deviationsList');
            container.innerHTML = '';
            
            let filteredDeviations = deviations;
            
            // Filter anwenden
            if (currentDeviationFilter === 'open') {
                filteredDeviations = deviations.filter(d => d.status === 'offen');
            } else if (currentDeviationFilter === 'completed') {
                filteredDeviations = deviations.filter(d => d.status === 'abgeschlossen');
            }
            
            if (filteredDeviations.length === 0) {
                let message = '';
                if (currentDeviationFilter === 'all') {
                    message = 'Keine Abweichungen vorhanden';
                } else if (currentDeviationFilter === 'open') {
                    message = 'Keine offenen Abweichungen';
                } else if (currentDeviationFilter === 'completed') {
                    message = 'Keine abgeschlossenen Abweichungen';
                }
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 2em; margin-bottom: 10px;">📭</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${message}</div>
                        <div style="font-size: 0.9em;">${
                            currentDeviationFilter === 'open' ? 
                            'Alle Maßnahmen sind abgeschlossen' : 
                            'Erfassen Sie Abweichungen in den Audits'
                        }</div>
                    </div>
                `;
                return;
            }
            
            // Container für die Tabelle mit festen Abmessungen
            const tableContainer = document.createElement('div');
            tableContainer.className = 'deviations-table-container';
            
            // Tabellen-Header
            let tableHTML = `
                <table class="deviations-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">Typ</th>
                            <th style="text-align: left;">Audit</th>
                            <th style="text-align: center;">Abteilung</th>
                            <th style="text-align: left;">Abweichung</th>
                            <th style="text-align: center;">Verantwortlich</th>
                            <th style="text-align: center;">Datum</th>
                            <th style="text-align: center;">Status</th>
                            <th style="text-align: center;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredDeviations.forEach((deviation, index) => {
                const deviationDate = new Date(deviation.date);
                const formattedDate = deviationDate.toLocaleDateString('de-DE');
                
                // Audit-Typ Icon
                const auditIcons = {
                    wirbelstrom: '⚡',
                    magnetpulver: '🧲',
                    nital: '🧪',
                    ultraschall: '📡',
                    unknown: '📋'
                };
                
                // Audit-Titel kürzen
                let auditTitle = deviation.auditTitle || 'Unbekannt';
                if (auditTitle.length > 20) {
                    auditTitle = auditTitle.substring(0, 20) + '...';
                }
                
                // Abweichungstext kürzen und Zeilenumbrüche ermöglichen
                let deviationText = deviation.deviationText || '';
                const shortText = deviationText.length > 25 ? deviationText.substring(0, 25) + '...' : deviationText;
                
                // Abteilung
                let department = deviation.department || 'N/A';
                if (department.length > 15) {
                    department = department.substring(0, 15) + '...';
                }
                
                // Verantwortlichen kürzen
                let responsible = deviation.responsible || 'Nicht angegeben';
                if (responsible.length > 20) {
                    responsible = responsible.substring(0, 20) + '...';
                }
                
                // Status-Klasse
                let statusClass = 'status-open';
                let statusText = 'Offen';
                
                if (deviation.status === 'abgeschlossen') {
                    statusClass = 'status-completed';
                    statusText = 'Abgeschlossen';
                }
                
                // Tabellen-Zeile
                tableHTML += `
                    <tr style="${deviation.status === 'abgeschlossen' ? 'background-color: var(--bg-tertiary); opacity: 0.8;' : ''}">
                        <!-- Typ (zentriert) -->
                        <td class="deviation-type-cell" data-label="Typ">
                            <div class="deviation-type-icon" title="${deviation.auditId}">
                                ${auditIcons[deviation.auditId] || '📋'}
                            </div>
                        </td>
                        
                        <!-- Audit (linksbündig) -->
                        <td class="deviation-audit-cell" data-label="Audit" title="${deviation.auditTitle || 'Unbekannt'}">
                            <div style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left;">
                                ${auditTitle}
                            </div>
                            <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 2px;">
                                ${deviation.questionId}
                            </div>
                            <div style="font-size: 0.7em; color: var(--text-secondary);">
                                ${deviation.auditNumber || ''}
                            </div>
                        </td>
                        
                        <!-- Abteilung (zentriert) -->
                        <td data-label="Abteilung" title="${deviation.department || ''}">
                            <div class="department-badge-centered">
                                ${department}
                            </div>
                        </td>
                        
        <!-- Abweichung (linksbündig mit ZEILENUMBRÜCHEN) -->
        <td class="deviation-text-cell" data-label="Abweichung">
            <div style="
                max-height: 100px;
                overflow-y: auto;
                padding-right: 5px;
            ">
                ${deviationText.replace(/\n/g, '<br>')}  <!-- Zeilenumbrüche erhalten -->
            </div>
        </td>
                        
                        <!-- Verantwortlicher (zentriert) -->
                        <td data-label="Verantwortlich" title="${deviation.responsible || 'Nicht angegeben'}">
                            <div class="responsible-badge-centered">
                                ${responsible}
                            </div>
                        </td>
                        
                        <!-- Datum (zentriert) -->
                        <td data-label="Datum">
                            <div class="date-badge-centered">
                                ${formattedDate}
                            </div>
                        </td>
                        
                        <!-- Status (zentriert) -->
                        <td data-label="Status">
                            <div class="status-badge ${statusClass}">
                                ${statusText}
                            </div>
                        </td>
                        
                        <!-- Aktionen (zentriert) -->
                        <td data-label="Aktionen">
                            <div class="actions-centered">
                                ${deviation.hasImage ? `
                                    <button onclick="viewDeviationImage(${index})" class="action-btn image" title="Bild ansehen">
                                        📷
                                    </button>
                                ` : ''}
                                ${deviation.status === 'offen' ? `
                                    <button onclick="completeDeviation(${index})" class="action-btn complete" title="Als abgeschlossen markieren">
                                        ✅
                                    </button>
                                ` : `
                                    <button onclick="reopenDeviation(${index})" class="action-btn open" title="Wieder öffnen">
                                        🔄
                                    </button>
                                `}
                                <button onclick="deleteDeviation(${index})" class="action-btn delete" title="Abweichung löschen">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.9em; color: var(--text-secondary);">
                    ${filteredDeviations.length} Abweichung${filteredDeviations.length !== 1 ? 'en' : ''} 
                    (${deviations.filter(d => d.status === 'offen').length} offen, 
                    ${deviations.filter(d => d.status === 'abgeschlossen').length} abgeschlossen)
                </div>
            `;
            
            tableContainer.innerHTML = tableHTML;
            container.appendChild(tableContainer);
        }
        
        function filterDeviations(filter) {
            currentDeviationFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(filter)) {
                    btn.classList.add('active');
                }
            });
            
            displayDeviationsList();
        }
        
        function viewDeviationImage(index) {
            if (index >= 0 && index < deviations.length) {
                const deviation = deviations[index];
                if (deviation.imageData) {
                    document.getElementById('modalImage').src = deviation.imageData;
                    document.getElementById('imageModal').style.display = 'flex';
                } else {
                    alert('Kein Bild für diese Abweichung vorhanden');
                }
            }
        }
        
        function completeDeviation(index) {
            if (index >= 0 && index < deviations.length) {
                deviations[index].status = 'abgeschlossen';
                deviations[index].completedAt = new Date().toISOString();
                deviations[index].completedBy = participants.auditors[0] || 'Unbekannt';
                saveDeviations();
                displayDeviationsList();
                alert('✅ Abweichung wurde als abgeschlossen markiert!');
            }
        }
        
        function reopenDeviation(index) {
            if (index >= 0 && index < deviations.length) {
                deviations[index].status = 'offen';
                deviations[index].reopenedAt = new Date().toISOString();
                saveDeviations();
                displayDeviationsList();
                alert('🔄 Abweichung wurde wieder geöffnet!');
            }
        }
        
        function deleteDeviation(index) {
            if (confirm('Sind Sie sicher, dass Sie diese Abweichung löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden.')) {
                if (index >= 0 && index < deviations.length) {
                    deviations.splice(index, 1);
                    saveDeviations();
                    displayDeviationsList();
                    alert('✅ Abweichung wurde gelöscht!');
                }
            }
        }
        
        function openCloudModal() {
            document.getElementById('cloudModal').style.display = 'flex';
            loadAuditsFromCloud();
        }
        
        function closeCloudModal() {
            document.getElementById('cloudModal').style.display = 'none';
            
            // WICHTIG: Zurück zur Startseite
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            
            // Header zurücksetzen
            document.querySelector('h1').textContent = 'ZfP Audit-Checkliste';
            document.querySelector('.subtitle').textContent = 'Zerstörungsfreie Prüfverfahren - Schaeffler';
            
            // Progress-Anzeigen aktualisieren
            updateAuditProgressDisplays();
            updateCloudProgressDisplay();
        }
        
        function openDeviationsModal() {
            document.getElementById('deviationsModal').style.display = 'flex';
            displayDeviationsList();
        }
        
        function closeDeviationsModal() {
            document.getElementById('deviationsModal').style.display = 'none';
            
            // WICHTIG: Zurück zur Startseite
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            
            // Header zurücksetzen
            document.querySelector('h1').textContent = 'ZfP Audit-Checkliste';
            document.querySelector('.subtitle').textContent = 'Zerstörungsfreie Prüfverfahren - Schaeffler';
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.getElementById('modalImage').src = '';
        }

        // === INITIALISIERUNG ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode();
            initializeApp();
            setupEventListeners();
            loadDeviations(); // Lade gespeicherte Abweichungen
        });

        function initializeApp() {
            loadAllAuditData();
            updateAuditProgressDisplays();
            
            // Lade die tatsächliche Anzahl aus der Cloud
            loadActualAuditCountFromCloud();
        }

        // 1. Definiere die einfachen Funktionen
        function generateReport() {
            if (!currentAuditType || !currentAuditData) {
                alert("Bitte zuerst ein Audit auswählen und ausfüllen!");
                return;
            }
            
            saveCurrentAuditData();
            
            const reportHtml = createReportHTML();
            
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(reportHtml);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 500);
        }

        // UPDATED: Bericht mit integrierter Auswertung in der Zusammenfassung
        function createReportHTML() {
            const auditInfo = AUDIT_TYPES[currentAuditType];
            const totalPoints = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = allQuestions.length * 10;
            const okCount = allQuestions.filter(q => 
                !q.deviation || !q.deviation.text || q.deviation.text.trim() === ''
            ).length;
            const nokCount = allQuestions.filter(q => 
                q.deviation && q.deviation.text && q.deviation.text.trim() !== ''
            ).length;
            const imageCount = allQuestions.filter(q => 
                q.deviation && q.deviation.hasImage === true
            ).length;
            
            const percentage = maxPoints > 0 ? (totalPoints / maxPoints * 100) : 0;
            
            let grade = '';
            let gradeColor = '';
            let gradeText = '';
            
            if (percentage >= 95) {
                grade = 'A';
                gradeColor = '#27ae60';
                gradeText = 'Exzellent';
            } else if (percentage >= 85) {
                grade = 'B';
                gradeColor = '#2ecc71';
                gradeText = 'Sehr gut';
            } else if (percentage >= 75) {
                grade = 'C';
                gradeColor = '#f39c12';
                gradeText = 'Gut';
            } else if (percentage >= 65) {
                grade = 'D';
                gradeColor = '#e67e22';
                gradeText = 'Befriedigend';
            } else if (percentage >= 50) {
                grade = 'E';
                gradeColor = '#e74c3c';
                gradeText = 'Ausreichend';
            } else {
                grade = 'F';
                gradeColor = '#c0392b';
                gradeText = 'Nicht bestanden';
            }
            
            const criticalQuestions = allQuestions
                .filter(q => q.points !== null && q.points <= 4)
                .map(q => ({
                    id: q.id,
                    text: q.text.substring(0, 80) + (q.text.length > 80 ? '...' : ''),
                    points: q.points,
                    deviation: q.deviation?.text || 'Keine Angabe'
                }));
            
            const pointsDistribution = {
                0: allQuestions.filter(q => q.points === 0).length,
                4: allQuestions.filter(q => q.points === 4).length,
                8: allQuestions.filter(q => q.points === 8).length,
                10: allQuestions.filter(q => q.points === 10).length,
                null: allQuestions.filter(q => q.points === null).length
            };
            
            const answeredQuestions = allQuestions.filter(q => q.points !== null).length;
            const totalQuestions = allQuestions.length;
            
            const schaefflerLogoURL = "https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg";
            
            const imageData = {};
            Object.keys(imageStorage).forEach(questionId => {
                if (imageStorage[questionId]) {
                    imageData[questionId] = imageStorage[questionId];
                }
            });
            
            const sections = {};
            allQuestions.forEach(question => {
                const sectionKey = question.sectionTitle || 'Allgemein';
                if (!sections[sectionKey]) {
                    sections[sectionKey] = [];
                }
                sections[sectionKey].push({
                    ...question,
                    imageData: imageData[question.id]
                });
            });
            
            const totalTableWidth = 180;
            const colWidths = {
                id: 10,
                question: 52,
                evidence: 30,
                deviation: 32,
                responsible: 25,
                points: 6
            };
            
            let questionsHTML = '';
            Object.keys(sections).forEach(sectionTitle => {
                questionsHTML += `
                <div class="section">
                    <div class="section-header">${sectionTitle}</div>
                    <table class="questions-table" style="width: ${totalTableWidth}mm;">
                        <thead>
                            <tr>
                                <th class="col-id" style="width: ${colWidths.id}mm;">ID</th>
                                <th class="col-question" style="width: ${colWidths.question}mm;">Frage / Prüfpunkt</th>
                                <th class="col-evidence" style="width: ${colWidths.evidence}mm;">Evidenz / Nachweis</th>
                                <th class="col-deviation" style="width: ${colWidths.deviation}mm;">Abweichung / Maßnahme</th>
                                <th class="col-responsible" style="width: ${colWidths.responsible}mm;">Verantwortlich</th>
                                <th class="col-points" style="width: ${colWidths.points}mm;">Pkt.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sections[sectionTitle].map(question => {
                                const hasDeviation = question.deviation && question.deviation.text && question.deviation.text.trim() !== '';
                                const hasImage = question.imageData;
                                const statusClass = hasDeviation ? 'status-nok' : (question.points !== null ? 'status-ok' : 'status-na');
                                
                                return `
                                    <tr>
                                        <td class="col-id" style="width: ${colWidths.id}mm;">
                                            <div class="question-id">
                                                <span class="status-indicator ${statusClass}"></span>
                                                ${question.id}
                                            </div>
                                        </td>
                                        <td class="col-question" style="width: ${colWidths.question}mm;">${question.text}</td>
                                        <td class="col-evidence" style="width: ${colWidths.evidence}mm;">${question.evidence || ''}</td>
                                        <td class="col-deviation" style="width: ${colWidths.deviation}mm;">${question.deviation?.text || ''}</td>
                                        <td class="col-responsible" style="width: ${colWidths.responsible}mm;">${question.deviation?.responsible || ''}</td>
                                        <td class="col-points" style="width: ${colWidths.points}mm; text-align: center; font-weight: bold;">${question.points || 0}</td>
                                    </tr>
                                    ${hasImage ? `
                                    <tr class="image-row">
                                        <td colspan="6" style="padding: 2mm 0;">
                                            <div class="report-image-container">
                                                <img src="${question.imageData}" class="report-image" alt="Beweisbild">
                                            </div>
                                        </td>
                                    </tr>
                                    ` : ''}
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                `;
            });
            
            return `
            <!DOCTYPE html>
            <html lang="de">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Auditbericht - ${auditInfo.title} | Schaeffler</title>
                <style>
                    @page {
                        size: A4 portrait;
                        margin: 15mm 10mm 15mm 15mm;
                        @bottom-right {
                            content: "Seite " counter(page) " von " counter(pages);
                            font-size: 8pt;
                            color: #666;
                        }
                    }
                    
                    body {
                        font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 10pt;
                        line-height: 1.3;
                        color: #000;
                        margin: 0;
                        padding: 0;
                        width: 100%;
                    }
                    
                    .report-element {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto !important;
                        box-sizing: border-box;
                    }
                    
                    /* ===== KOPFZEILE ===== */
                    .header-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 6mm auto !important;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        border-bottom: 1.5pt solid #003865;
                        padding-bottom: 4mm;
                        box-sizing: border-box;
                    }
                    
                    .title-section {
                        flex: 1;
                        text-align: left;
                        padding-right: 10mm;
                    }
                    
                    .report-title {
                        font-size: 16pt;
                        font-weight: bold;
                        color: #003865;
                        margin-bottom: 1mm;
                        text-transform: uppercase;
                    }
                    
                    .report-subtitle {
                        font-size: 12pt;
                        color: #333;
                        font-weight: 600;
                        margin-bottom: 1mm;
                    }
                    
                    .report-standards {
                        font-size: 10pt;
                        color: #666;
                        font-style: italic;
                    }
                    
                    .logo-section {
                        flex-shrink: 0;
                        text-align: right;
                    }
                    
                    .schaeffler-logo {
                        width: 45mm;
                        height: auto;
                    }
                    
                    /* ===== METADATEN ===== */
                    .meta-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 8mm auto !important;
                        background: #f8f9fa;
                        border: 1pt solid #ddd;
                        border-radius: 4px;
                        padding: 4mm;
                        box-sizing: border-box;
                    }
                    
                    .meta-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 6mm;
                        font-size: 9pt;
                    }
                    
                    .meta-column {
                        display: flex;
                        flex-direction: column;
                        gap: 2mm;
                    }
                    
                    .meta-row {
                        display: flex;
                        justify-content: space-between;
                        padding-bottom: 1.5mm;
                        border-bottom: 0.5pt dotted #ccc;
                    }
                    
                    .meta-row:last-child {
                        border-bottom: none;
                        padding-bottom: 0;
                    }
                    
                    .meta-label {
                        font-weight: bold;
                        color: #003865;
                        min-width: 35mm;
                    }
                    
                    .meta-value {
                        text-align: right;
                        flex: 1;
                    }
                    
                    /* ===== TEILNEHMER ===== */
                    .participants-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 8mm auto !important;
                        background: #f0f7ff;
                        border: 1pt solid #003865;
                        border-radius: 4px;
                        padding: 4mm;
                        box-sizing: border-box;
                    }
                    
                    .container-title {
                        font-weight: bold;
                        color: #003865;
                        font-size: 11pt;
                        text-align: center;
                        margin-bottom: 3mm;
                    }
                    
                    .participants-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 8mm;
                    }
                    
                    .participant-group {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #ddd;
                    }
                    
                    .group-label {
                        font-weight: bold;
                        color: #003865;
                        font-size: 10pt;
                        margin-bottom: 1mm;
                        border-bottom: 1pt solid #ddd;
                        padding-bottom: 1mm;
                    }
                    
                    .group-content {
                        min-height: 8mm;
                        font-size: 10pt;
                        line-height: 1.4;
                    }
                    
                    /* ===== ZUSAMMENFASSUNG MIT AUSWERTUNG ===== */
                    .summary-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 10mm auto !important;
                        background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
                        border: 1.5pt solid #003865;
                        border-radius: 5px;
                        padding: 5mm;
                        box-sizing: border-box;
                    }
                    
                    .summary-title {
                        font-weight: bold;
                        color: #003865;
                        font-size: 12pt;
                        text-align: center;
                        margin-bottom: 5mm;
                        text-transform: uppercase;
                    }
                    
                    /* ERGEBNIS-ÜBERSICHT */
                    .results-overview {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 4mm;
                        margin-bottom: 6mm;
                    }
                    
                    .result-item {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #003865;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        min-height: 20mm;
                    }
                    
                    .result-value {
                        font-size: 14pt;
                        font-weight: bold;
                        color: #003865;
                        margin-bottom: 1mm;
                    }
                    
                    .result-label {
                        font-size: 8pt;
                        color: #666;
                        line-height: 1.3;
                    }
                    
                    /* AUSWERTUNGS-DETAILS */
                    .evaluation-details {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 6mm;
                        margin-top: 6mm;
                        padding-top: 4mm;
                        border-top: 1pt dashed #003865;
                    }
                    
                    .evaluation-column {
                        display: flex;
                        flex-direction: column;
                        gap: 3mm;
                    }
                    
                    .grade-box {
                        background: white;
                        padding: 4mm;
                        border-radius: 4px;
                        border: 2pt solid ${gradeColor};
                        text-align: center;
                    }
                    
                    .grade-value {
                        font-size: 24pt;
                        font-weight: bold;
                        color: ${gradeColor};
                        margin-bottom: 1mm;
                    }
                    
                    .grade-text {
                        font-size: 10pt;
                        font-weight: bold;
                        color: ${gradeColor};
                        margin-bottom: 1mm;
                    }
                    
                    .grade-percentage {
                        font-size: 12pt;
                        font-weight: bold;
                        color: #003865;
                    }
                    
                    .points-distribution {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #ddd;
                    }
                    
                    .distribution-title {
                        font-weight: bold;
                        color: #003865;
                        font-size: 10pt;
                        margin-bottom: 2mm;
                        text-align: center;
                    }
                    
                    .distribution-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 2mm;
                    }
                    
                    .distribution-item {
                        text-align: center;
                        padding: 1mm;
                        border-radius: 2px;
                        background: #f8f9fa;
                    }
                    
                    .distribution-points {
                        font-weight: bold;
                        font-size: 10pt;
                        color: #003865;
                    }
                    
                    .distribution-count {
                        font-size: 9pt;
                        color: #666;
                    }
                    
                    .critical-issues {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #e74c3c;
                        background-color: #fff5f5;
                    }
                    
                    .critical-title {
                        font-weight: bold;
                        color: #e74c3c;
                        font-size: 10pt;
                        margin-bottom: 2mm;
                        text-align: center;
                    }
                    
                    .critical-list {
                        font-size: 8pt;
                        line-height: 1.4;
                        max-height: 25mm;
                        overflow-y: auto;
                    }
                    
                    .critical-item {
                        margin-bottom: 1mm;
                        padding-bottom: 1mm;
                        border-bottom: 0.5pt dotted #ffcccc;
                    }
                    
                    .recommendations {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #f39c12;
                        background-color: #fff9e6;
                    }
                    
                    .recommendations-title {
                        font-weight: bold;
                        color: #f39c12;
                        font-size: 10pt;
                        margin-bottom: 2mm;
                        text-align: center;
                    }
                    
                    .recommendations-list {
                        font-size: 8pt;
                        line-height: 1.4;
                    }
                    
                    /* ===== FRAGEN TABELLE ===== */
                    .questions-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto !important;
                        box-sizing: border-box;
                    }
                    
                    .section {
                        margin: 6mm 0;
                        width: 100%;
                    }
                    
                    .section-header {
                        background-color: #003865;
                        color: white;
                        padding: 2.5mm 4mm;
                        font-weight: bold;
                        font-size: 11pt;
                        margin: 5mm 0 3mm 0;
                        border-radius: 3px;
                        width: 96%;
                    }
                    
                    .questions-table {
                        width: 180mm !important;
                        border-collapse: collapse;
                        margin: 0;
                        font-size: 9pt;
                        table-layout: fixed;
                    }
                    
                    .questions-table th {
                        background-color: #e6f0ff;
                        padding: 2.5mm 2mm;
                        text-align: left;
                        font-weight: bold;
                        border-bottom: 1.5pt solid #003865;
                        border-right: 1pt solid #ddd;
                        color: #003865;
                        height: 8mm;
                    }
                    
                    /* SPEZIFISCHE KORREKTUR FÜR MOBILE TABELLEN-HEADER */
                    @media screen and (max-width: 768px), (max-device-width: 768px) {
                        .questions-table th {
                            font-size: 9pt !important;
                            line-height: 1.1 !important;
                            -webkit-text-size-adjust: none !important;
                            text-size-adjust: none !important;
                            font-weight: 600 !important; /* Statt bold für bessere Kontrolle */
                        }
                    }

                    /* Für iOS Safari spezifisch */
                    @supports (-webkit-touch-callout: none) {
                        .questions-table th {
                            font-size: 9pt !important;
                            -webkit-text-size-adjust: none !important;
                        }
                    }
                    
                    .questions-table td {
                        padding: 2.5mm 2mm;
                        border-bottom: 0.5pt solid #eee;
                        border-right: 1pt solid #eee;
                        vertical-align: top;
                        line-height: 1.4;
                        word-wrap: break-word;
                    }
                    
                    .status-indicator {
                        display: inline-block;
                        width: 6pt;
                        height: 6pt;
                        border-radius: 50%;
                        margin-right: 1.5mm;
                    }
                    
                    .status-ok { background-color: #38a169; }
                    .status-nok { background-color: #e53e3e; }
                    .status-na { background-color: #a0aec0; }
                    
                    .question-id {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                    }
                    
                    .image-row {
                        background-color: #f9f9f9;
                    }
                    
                    .report-image-container {
                        padding: 2mm;
                        text-align: center;
                        border: 1pt dashed #ccc;
                        border-radius: 3px;
                        margin: 2mm 0;
                        background-color: white;
                        page-break-inside: avoid;
                    }
                    
                    .report-image {
                        max-width: 150mm;
                        max-height: 100mm;
                        height: auto;
                        border: 1pt solid #ddd;
                        border-radius: 2px;
                    }
                    
                    /* ===== LEGENDE ===== */
                    .legend-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 8mm auto 5mm auto !important;
                        font-size: 8pt;
                        color: #666;
                        text-align: center;
                        border-top: 1pt dashed #ccc;
                        padding-top: 3mm;
                        box-sizing: border-box;
                    }
                    
                    /* ===== UNTERSCHRIFTEN ===== */
                    .signature-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 10mm auto 0 auto !important;
                        padding-top: 6mm;
                        border-top: 1.5pt solid #003865;
                        font-size: 9pt;
                        box-sizing: border-box;
                    }
                    
                    .signature-grid {
                        display: flex;
                        justify-content: space-between;
                        margin-top: 8mm;
                        width: 100%;
                    }
                    
                    .signature-item {
                        text-align: center;
                        width: 85mm;
                    }
                    
                    .signature-line {
                        border-top: 1pt solid #000;
                        padding-top: 2mm;
                        margin-top: 12mm;
                        min-height: 15mm;
                    }
                    
                    /* ===== DRUCK-STEUERUNG ===== */
                    .print-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 12mm auto 8mm auto !important;
                        padding: 4mm;
                        background: #f8f9fa;
                        border-radius: 6px;
                        border: 1pt solid #ddd;
                        text-align: center;
                        box-sizing: border-box;
                    }
                    
                    .print-btn {
                        padding: 6mm 12mm;
                        background: #003865;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        font-size: 11pt;
                        font-weight: bold;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        gap: 4mm;
                        min-width: 50mm;
                    }
                    
                    .print-btn:hover {
                        background: #00274d;
                    }
                    
                    /* ===== FOOTER ===== */
                    .footer-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 5mm auto 0 auto !important;
                        font-size: 7pt;
                        color: #666;
                        text-align: center;
                        padding-top: 2mm;
                        border-top: 1pt solid #eee;
                        box-sizing: border-box;
                    }
                    
                    /* ===== DRUCK-STYLES ===== */
                    @media print {
                        body {
                            margin: 0;
                            padding: 0;
                            width: 210mm;
                            height: 297mm;
                            font-size: 10pt;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        
                        .print-container {
                            display: none !important;
                        }
                        
                        .header-container,
                        .meta-container,
                        .participants-container,
                        .summary-container,
                        .questions-container,
                        .legend-container,
                        .signature-container,
                        .footer-container {
                            width: 180mm !important;
                            max-width: 180mm !important;
                            margin-left: auto !important;
                            margin-right: auto !important;
                        }
                        
                        .questions-table {
                            width: 180mm !important;
                        }
                        
                        .section, tr {
                            page-break-inside: avoid;
                        }
                    }
                    
                    @media screen {
                        body {
                            background: #f5f5f5;
                            padding: 20px;
                        }
                        
                        .main-container {
                            background: white;
                            padding: 20px;
                            box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            width: calc(180mm + 40px);
                            margin: 0 auto;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="main-container">
                    <!-- KOPFZEILE -->
                    <div class="header-container report-element">
                        <div class="title-section">
                            <div class="report-title">Auditbericht: ${auditInfo.title}</div>
                            <div class="report-subtitle">Zerstörungsfreie Prüfverfahren</div>
                            <div class="report-standards">Standards: ${auditInfo.standards}</div>
                            <div style="font-size: 9pt; color: #666; margin-top: 2mm;">
                                Audit-Nr.: ${currentAuditData.meta.auditNumber || generateAuditNumber()}
                            </div>
                        </div>
                        <div class="logo-section">
                            <img src="${schaefflerLogoURL}" 
                                 class="schaeffler-logo" 
                                 alt="Schaeffler Logo">
                        </div>
                    </div>
                    
                    <!-- METADATEN -->
                    <div class="meta-container report-element">
                        <div class="meta-grid">
                            <div class="meta-column">
                                <div class="meta-row">
                                    <span class="meta-label">Audit-Verfahren:</span>
                                    <span class="meta-value">${auditInfo.title}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Standards:</span>
                                    <span class="meta-value">${auditInfo.standards}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Abteilung:</span>
                                    <span class="meta-value">${extractDepartment()}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Audit-Nr.:</span>
                                    <span class="meta-value">${currentAuditData.meta.auditNumber || generateAuditNumber()}</span>
                                </div>
                            </div>
                            <div class="meta-column">
                                <div class="meta-row">
                                    <span class="meta-label">Erstellt am:</span>
                                    <span class="meta-value">${new Date().toLocaleDateString('de-DE')}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Geändert am:</span>
                                    <span class="meta-value">${new Date(currentAuditData.meta.lastModified).toLocaleDateString('de-DE')}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Dokument-ID:</span>
                                    <span class="meta-value">AUD-${currentAuditType.toUpperCase()}-${Date.now().toString(36).toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TEILNEHMER -->
                    <div class="participants-container report-element">
                        <div class="container-title">Teilnehmer</div>
                        <div class="participants-grid">
                            <div class="participant-group">
                                <div class="group-label">Auditoren:</div>
                                <div class="group-content">${participants.auditors.join(', ') || 'Nicht angegeben'}</div>
                            </div>
                            <div class="participant-group">
                                <div class="group-label">Auditierte Personen:</div>
                                <div class="group-content">${participants.auditees.join(', ') || 'Nicht angegeben'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ZUSAMMENFASSUNG MIT AUSWERTUNG -->
                    <div class="summary-container report-element">
                        <div class="summary-title">Zusammenfassung & Auswertung</div>
                        
                        <!-- ERGEBNIS-ÜBERSICHT -->
                        <div class="results-overview">
                            <div class="result-item">
                                <div class="result-value">${totalPoints}/${maxPoints}</div>
                                <div class="result-label">Gesamtpunkte<br>erreicht/maximal</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${okCount}</div>
                                <div class="result-label">
                                    <span class="status-indicator status-ok"></span>
                                    I.O.<br>(10 Punkte)
                                </div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${nokCount}</div>
                                <div class="result-label">
                                    <span class="status-indicator status-nok"></span>
                                    N.I.O.<br>(&lt; 10 Punkte)
                                </div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${imageCount}</div>
                                <div class="result-label">📷<br>Dokumentierte Bilder</div>
                            </div>
                        </div>
                        
                        <!-- AUSWERTUNGS-DETAILS -->
                        <div class="evaluation-details">
                            <!-- LINKE SPALTE: Bewertung & Punkteverteilung -->
                            <div class="evaluation-column">
                                <!-- BEWERTUNG -->
                                <div class="grade-box">
                                    <div class="grade-value">${grade}</div>
                                    <div class="grade-text">${gradeText}</div>
                                    <div class="grade-percentage">${percentage.toFixed(1)}% erreicht</div>
                                </div>
                                
                                <!-- PUNKTEVERTEILUNG -->
                                <div class="points-distribution">
                                    <div class="distribution-title">Punkteverteilung</div>
                                    <div class="distribution-grid">
                                        <div class="distribution-item">
                                            <div class="distribution-points">10 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[10]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">8 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[8]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">4 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[4]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">0 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[0]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">Nicht bew.</div>
                                            <div class="distribution-count">${pointsDistribution.null} Fragen</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RECHTE SPALTE: Kritische Punkte & Empfehlungen -->
                            <div class="evaluation-column">
                                <!-- KRITISCHE FRAGEN -->
                                <div class="critical-issues">
                                    <div class="critical-title">Kritische Fragen (≤ 4 Punkte)</div>
                                    <div class="critical-list">
                                        ${criticalQuestions.length > 0 ? 
                                            criticalQuestions.map(q => `
                                                <div class="critical-item">
                                                    <strong>${q.id} (${q.points} Pkte):</strong><br>
                                                    ${q.text}<br>
                                                    <em>${q.deviation}</em>
                                                </div>
                                            `).join('') 
                                            : '<div style="text-align: center; color: #666; font-style: italic;">Keine kritischen Fragen</div>'
                                        }
                                    </div>
                                </div>
                                
                                <!-- EMPFEHLUNGEN -->
                                <div class="recommendations">
                                    <div class="recommendations-title">Empfehlungen</div>
                                    <div class="recommendations-list">
                                        ${percentage >= 90 ? 
                                            '<div>✅ Exzellentes Ergebnis. Der Prozess ist effektiv und gut dokumentiert.</div>' : 
                                        percentage >= 80 ? 
                                            '<div>⚠️ Gutes Ergebnis. Einige Verbesserungspotentiale vorhanden.</div>' : 
                                        percentage >= 70 ? 
                                            '<div>⚠️ Akzeptables Ergebnis. Es sollten Maßnahmen zur Verbesserung geplant werden.</div>' : 
                                            '<div>❌ Kritisch. Dringende Maßnahmen erforderlich.</div>'
                                        }
                                        ${answeredQuestions < totalQuestions ? 
                                            '<div>⚠️ Nicht alle Fragen wurden bewertet. Bitte vervollständigen Sie das Audit.</div>' : ''}
                                        ${criticalQuestions.length > 0 ? 
                                            `<div>⚠️ ${criticalQuestions.length} kritische Fragen sollten priorisiert angegangen werden.</div>` : ''}
                                        ${imageCount > 0 ? 
                                            '<div>✅ Bilder dokumentieren Abweichungen effektiv.</div>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FRAGEN TABELLE -->
                    <div class="questions-container report-element">
                        ${questionsHTML}
                    </div>
                    
                    <!-- LEGENDE -->
                    <div class="legend-container report-element">
                        <span class="status-indicator status-ok"></span> = I.O. (10 Punkte) &nbsp;&nbsp; | &nbsp;&nbsp;
                        <span class="status-indicator status-nok"></span> = N.I.O. (&lt; 10 Punkte) &nbsp;&nbsp; | &nbsp;&nbsp;
                        <span class="status-indicator status-na"></span> = Nicht bewertet
                    </div>
                    
                    <!-- UNTERSCHRIFTEN -->
                    <div class="signature-container report-element">
                        <div style="text-align: center; margin-bottom: 6mm; font-weight: bold; color: #003865;">
                            Unterschriften zur Bestätigung der Audit-Ergebnisse
                        </div>
                        <div class="signature-grid">
                            <div class="signature-item">
                                Auditor / Prüfer<br>
                                <div class="signature-line"></div>
                                <div style="font-size: 8pt; margin-top: 1mm; color: #666;">
                                    Name, Datum, Unterschrift
                                </div>
                            </div>
                            <div class="signature-item">
                                Auditierter / Bereichsverantwortlicher<br>
                                <div class="signature-line"></div>
                                <div style="font-size: 8pt; margin-top: 1mm; color: #666;">
                                    Name, Datum, Unterschrift
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRUCK-STEUERUNG -->
                    <div class="print-container report-element">
                        <button class="print-btn" onclick="window.print();">🖨️ BERICHTSDRUCK STARTEN</button>
                    </div>
                    
                    <!-- FOOTER -->
                    <div class="footer-container report-element">
                        Häusner Daniel | WI/SW2-PQT | ZfP Audit-Checkliste AE - 27.01.2026<br>
                        Erstellt mit ZfP Audit-Checkliste | Generiert am: ${new Date().toLocaleString('de-DE')}
                    </div>
                </div>
            </body>
            </html>
            `;
        }

        // === URSPRÜNGLICHE FUNKTIONEN ===
        function loadAllAuditData() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const saved = localStorage.getItem(`zfpAuditReview_${auditType}`);
                if (!saved) {
                    const sections = AUDIT_DATA[auditType];
                    const allQuestionsForAudit = sections.flatMap(section => 
                        section.questions.map(q => ({
                            ...q,
                            sectionTitle: section.title,
                            sectionShort: section.short,
                            points: null,
                            evidence: "",
                            deviation: { text: "", responsible: "", hasImage: false }
                        }))
                    );
                    
                    const initialData = {
                        meta: {
                            created: new Date().toISOString(),
                            lastModified: new Date().toISOString(),
                            auditType: auditType,
                            title: AUDIT_TYPES[auditType].title,
                            standards: AUDIT_TYPES[auditType].standards,
                            auditNumber: generateAuditNumber()
                        },
                        participants: { auditors: [], auditees: [] },
                        questions: allQuestionsForAudit,
                        images: {}
                    };
                    localStorage.setItem(`zfpAuditReview_${auditType}`, JSON.stringify(initialData));
                }
            });
        }

        function startAudit(auditType) {
            currentAuditType = auditType;
            
            document.getElementById('auditSelection').classList.remove('active');
            document.getElementById('auditContent').classList.add('active');
            
            loadCurrentAuditData();
            
            const auditInfo = AUDIT_TYPES[auditType];
            document.querySelector('h1').textContent = `ZfP Audit - ${auditInfo.title}`;
            document.querySelector('.subtitle').textContent = auditInfo.standards;
            
            renderAuditSections();
            setupDesktopEventListeners();
            updateCurrentAuditProgress();
            renderParticipants();
            setupMobileParticipants();
            
            const isMobile = window.innerWidth <= 768;
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (isMobile) {
                document.getElementById('desktopView').style.display = 'none';
                document.getElementById('mobileView').style.display = 'block';
                toggleBtn.textContent = '🖥️ Desktop';
                renderMobileQuestion();
            } else {
                document.getElementById('desktopView').style.display = 'block';
                document.getElementById('mobileView').style.display = 'none';
                toggleBtn.textContent = '📱 Mobile';
            }
            
            document.getElementById('evaluation').style.display = 'none';
        }

        function loadCurrentAuditData() {
            const saved = localStorage.getItem(`zfpAuditReview_${currentAuditType}`);
            if (saved) {
                currentAuditData = JSON.parse(saved);
                allQuestions = currentAuditData.questions || [];
                participants = currentAuditData.participants || { auditors: [], auditees: [] };
                imageStorage = currentAuditData.images || {};
                
                // Stelle sicher, dass eine Audit-Nummer existiert
                if (!currentAuditData.meta.auditNumber) {
                    currentAuditData.meta.auditNumber = generateAuditNumber();
                }
            } else {
                const sections = AUDIT_DATA[currentAuditType];
                allQuestions = sections.flatMap(section => 
                    section.questions.map(q => ({
                        ...q,
                        sectionTitle: section.title,
                        sectionShort: section.short,
                        points: null,
                        evidence: "",
                        deviation: { text: "", responsible: "", hasImage: false }
                    }))
                );
                
                currentAuditData = {
                    meta: {
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        auditType: currentAuditType,
                        title: AUDIT_TYPES[currentAuditType].title,
                        standards: AUDIT_TYPES[currentAuditType].standards,
                        auditNumber: generateAuditNumber()
                    },
                    participants: { auditors: [], auditees: [] },
                    questions: allQuestions,
                    images: {}
                };
            }
            
            allQuestionElements = allQuestions;
        }

        function saveCurrentAuditData() {
            if (!currentAuditType || !currentAuditData) return;
            
            currentAuditData.questions = allQuestions;
            currentAuditData.participants = participants;
            currentAuditData.images = imageStorage;
            currentAuditData.meta.lastModified = new Date().toISOString();
            
            // Stelle sicher, dass eine Audit-Nummer existiert
            if (!currentAuditData.meta.auditNumber) {
                currentAuditData.meta.auditNumber = generateAuditNumber();
            }
            
            localStorage.setItem(`zfpAuditReview_${currentAuditType}`, JSON.stringify(currentAuditData));
            updateAuditProgressDisplays();
            updateCurrentAuditProgress();
            updateCloudProgressDisplay();
        }

        function goBackToSelection() {
            saveCurrentAuditData();
            
            currentAuditType = null;
            currentAuditData = null;
            allQuestions = [];
            allQuestionElements = [];
            
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            
            document.querySelector('h1').textContent = 'ZfP Audit-Checkliste';
            document.querySelector('.subtitle').textContent = 'Zerstörungsfreie Prüfverfahren - Schaeffler';
        }

        function updateAuditProgressDisplays() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const progress = calculateAuditProgress(auditType);
                const progressElement = document.getElementById(`${auditType}Progress`);
                if (progressElement) {
                    progressElement.textContent = `${progress.percent}%`;
                }
            });
            
            // Füge diese Zeile hinzu:
            updateCloudProgressDisplay();
        }

        // Füge diese neue Funktion hinzu:
        function updateCloudProgressDisplay() {
            // Zähle alle gespeicherten Audits in der Cloud
            const cloudProgressElement = document.getElementById('cloudProgress');
            if (cloudProgressElement) {
                // Standardwert setzen
                cloudProgressElement.textContent = 'Lädt...';
                
                // Wenn keine Verbindung, versuche aus localStorage zu zählen
                const savedAudits = countAuditsFromLocalStorage();
                if (savedAudits > 0) {
                    cloudProgressElement.textContent = `${savedAudits} Audits`;
                }
                
                // Versuche die echte Anzahl aus der Cloud zu laden
                loadActualAuditCountFromCloud();
            }
        }

        // Zähle Audits aus localStorage (Fallback)
        function countAuditsFromLocalStorage() {
            let count = 0;
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const saved = localStorage.getItem(`zfpAuditReview_${auditType}`);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        // Nur zählen wenn Fragen bewertet wurden
                        const hasAnswers = data.questions?.some(q => q.points !== null);
                        if (hasAnswers) {
                            count++;
                        }
                    } catch (e) {
                        // Ignoriere Fehler
                    }
                }
            });
            return count;
        }

        // Lade die tatsächliche Anzahl aus der Cloud
        async function loadActualAuditCountFromCloud() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/audits?select=id&order=id`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const audits = await response.json();
                    const cloudProgressElement = document.getElementById('cloudProgress');
                    if (cloudProgressElement) {
                        const count = audits?.length || 0;
                        cloudProgressElement.textContent = `${count} Audit${count !== 1 ? 's' : ''}`;
                        
                        // Speichere die Anzahl für späteren Gebrauch
                        localStorage.setItem('cloudAuditCount', count.toString());
                    }
                }
            } catch (error) {
                console.log('Cloud-Zählung nicht verfügbar, verwende lokale Zählung');
                // Bei Fehler verwenden wir die localStorage Zählung
            }
        }

        function calculateAuditProgress(auditType) {
            const saved = localStorage.getItem(`zfpAuditReview_${auditType}`);
            if (!saved) {
                const sections = AUDIT_DATA[auditType];
                const total = sections.reduce((sum, section) => sum + section.questions.length, 0);
                return { answered: 0, total: total, percent: 0, points: 0, maxPoints: total * 10 };
            }
            
            const data = JSON.parse(saved);
            const questions = data.questions || [];
            const total = questions.length;
            const answered = questions.filter(q => q.points !== null).length;
            const points = questions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            
            return { answered, total, percent, points, maxPoints };
        }

        function renderAuditSections() {
            const container = document.getElementById('auditSections');
            container.innerHTML = '';
            
            if (!currentAuditType || !AUDIT_DATA[currentAuditType]) return;
            
            const sections = AUDIT_DATA[currentAuditType];
            
            sections.forEach((section, sectionIndex) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section';
                sectionElement.innerHTML = `
                    <div class="section-header">
                        <h2>${section.title}</h2>
                        <span>▶</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        ${renderQuestions(section.questions)}
                    </div>
                `;
                container.appendChild(sectionElement);
            });
            
            setupSectionHeaders();
        }

        function renderQuestions(questions) {
            return questions.map(question => {
                const questionData = getQuestionData(question.id);
                const hasImage = imageStorage[question.id];
                const points = questionData.points;
                const pointsText = points !== null ? `${points} Punkte` : "Nicht bewertet";
                const pointsColor = getPointsColor(points);
                
                return `
                <div class="question" data-id="${question.id}">
                    <div class="question-header">
                        <div class="question-text">${question.text}</div>
                        <div class="question-id">${question.id}</div>
                    </div>
                    
                    <div class="points-display" style="background-color: ${pointsColor}20; color: ${pointsColor}; border-color: ${pointsColor};">
                        ${pointsText}
                    </div>

                    <div class="points-options">
                        <div class="points-option ${points === 0 ? 'selected' : ''}" data-points="0">0</div>
                        <div class="points-option ${points === 4 ? 'selected' : ''}" data-points="4">4</div>
                        <div class="points-option ${points === 8 ? 'selected' : ''}" data-points="8">8</div>
                        <div class="points-option ${points === 10 ? 'selected' : ''}" data-points="10">10</div>
                    </div>

                    <textarea class="evidence" placeholder="Nachweis / Kommentar / Referenz">${questionData.evidence}</textarea>
                    
                    <div class="deviation-section" style="display: ${points !== null && points <= 8 ? 'block' : 'none'};">
                        <h4>Abweichungsinformationen (nur bei weniger als 10 Punkten)</h4>
                        <textarea class="deviation-field" placeholder="Beschreibung der Abweichung / Maßnahmen">${questionData.deviation.text || ''}</textarea>
                        <input type="text" class="responsible-field" placeholder="Verantwortlicher" value="${questionData.deviation.responsible || ''}">
                        <div class="image-upload">
                            <div class="file-input-wrapper">
                                <input type="file" accept="image/*" class="image-input" id="desktop_image-${question.id}" onchange="handleImageUploadDesktop(event, '${question.id}')">
                                <span class="file-input-label">Bild hochladen</span>
                            </div>
                            ${hasImage ? `
                                <img class="image-preview" id="desktop_preview-${question.id}" src="${hasImage}" style="display: block;">
                                <button type="button" class="remove-image" data-question="${question.id}" onclick="removeImageForQuestion('${question.id}')">Bild entfernen</button>
                            ` : `
                                <img class="image-preview" id="desktop_preview-${question.id}" style="display: none;">
                            `}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderMobileQuestion() {
            if (allQuestionElements.length === 0) return;
            
            const container = document.getElementById('mobileQuestions');
            const question = allQuestionElements[currentMobileQuestion];
            if (!question) return;
            
            const questionData = getQuestionData(question.id);
            const hasImage = imageStorage[question.id];
            const points = questionData.points;
            const pointsColor = getPointsColor(points);
            
            container.innerHTML = `
                <div class="question" data-id="${question.id}">
                    <div class="question-header">
                        <div class="question-text">${question.text}</div>
                        <div class="question-id">${question.id}</div>
                    </div>
                    
                    <div class="points-display" style="background-color: ${pointsColor}20; color: ${pointsColor}; border-color: ${pointsColor};">
                        ${points !== null ? `${points} Punkte` : "Nicht bewertet"}
                    </div>

                    <div class="points-options">
                        <div class="points-option ${points === 0 ? 'selected' : ''}" data-points="0">0</div>
                        <div class="points-option ${points === 4 ? 'selected' : ''}" data-points="4">4</div>
                        <div class="points-option ${points === 8 ? 'selected' : ''}" data-points="8">8</div>
                        <div class="points-option ${points === 10 ? 'selected' : ''}" data-points="10">10</div>
                    </div>

                    <textarea class="evidence" placeholder="Nachweis / Kommentar / Referenz">${questionData.evidence}</textarea>
                    
                    <div class="deviation-section" style="display: ${points !== null && points <= 8 ? 'block' : 'none'};">
                        <h4>Abweichungsinformationen</h4>
                        <textarea class="deviation-field" placeholder="Beschreibung der Abweichung / Maßnahmen">${questionData.deviation.text || ''}</textarea>
                        <input type="text" class="responsible-field" placeholder="Verantwortlicher" value="${questionData.deviation.responsible || ''}">
                        <div class="image-upload">
                            <div class="file-input-wrapper">
                                <input type="file" accept="image/*" class="image-input" id="mobile_image-${question.id}" onchange="handleImageUploadMobile(event, '${question.id}')">
                                <span class="file-input-label">Bild hochladen</span>
                            </div>
                            ${hasImage ? `
                                <img class="image-preview" id="mobile_preview-${question.id}" src="${hasImage}" style="display: block;">
                                <button type="button" class="remove-image" data-question="${question.id}" onclick="removeImageForQuestion('${question.id}')">Bild entfernen</button>
                            ` : `
                                <img class="image-preview" id="mobile_preview-${question.id}" style="display: none;">
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mobileCounter').textContent = `Frage ${currentMobileQuestion + 1}/${allQuestionElements.length}`;
            renderMobileSectionSelector();
            
            setTimeout(() => {
                setupMobileQuestionListeners(question.id);
            }, 10);
        }

        function renderMobileSectionSelector() {
            const container = document.getElementById('sectionSelector');
            container.innerHTML = '';
            
            if (!currentAuditType || !AUDIT_DATA[currentAuditType]) return;
            
            const sections = AUDIT_DATA[currentAuditType];
            const sectionsData = [];
            
            let questionIndex = 0;
            sections.forEach((section, sectionIndex) => {
                sectionsData.push({
                    title: section.title,
                    short: section.short,
                    startIndex: questionIndex,
                    count: section.questions.length
                });
                questionIndex += section.questions.length;
            });
            
            sectionsData.forEach((section, index) => {
                const button = document.createElement('button');
                button.className = 'section-btn';
                button.textContent = section.short;
                button.title = section.title;
                button.addEventListener('click', function() {
                    currentMobileQuestion = section.startIndex;
                    renderMobileQuestion();
                    container.scrollIntoView({ behavior: 'smooth' });
                });
                container.appendChild(button);
            });
        }

        function getQuestionData(questionId) {
            return allQuestions.find(q => q.id === questionId) || {
                points: null,
                evidence: "",
                deviation: { text: "", responsible: "", hasImage: false }
            };
        }

        function updateQuestionData(questionId, field, value) {
            const question = allQuestions.find(q => q.id === questionId);
            if (question) {
                if (field === 'deviation') {
                    question.deviation = { ...question.deviation, ...value };
                } else if (field === 'evidence') {
                    question.evidence = value;
                } else if (field === 'points') {
                    question.points = value;
                    
                    const questionElement = document.querySelector(`.question[data-id="${questionId}"]`);
                    if (questionElement) {
                        const deviationSection = questionElement.querySelector('.deviation-section');
                        if (deviationSection) {
                            if (value !== null && value <= 8) {
                                deviationSection.style.display = 'block';
                            } else {
                                deviationSection.style.display = 'none';
                            }
                        }
                    }
                }
                saveCurrentAuditData();
                updateCurrentAuditProgress();
            }
        }

        async function processAndLimitImage(file, maxWidth = 1200, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    reject(new Error(`Bild ist zu groß (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximale Größe: 10MB`));
                    return;
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    try {
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve({
                            dataUrl: compressedDataUrl,
                            originalSize: file.size,
                            compressedSize: Math.floor((compressedDataUrl.length - 'data:image/jpeg;base64,'.length) * 0.75),
                            dimensions: { width, height }
                        });
                    } catch (error) {
                        reject(new Error('Bild konnte nicht verarbeitet werden'));
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Bild konnte nicht geladen werden'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        async function handleImageUploadDesktop(event, questionId) {
            const file = event.target.files[0];
            if (!file) return;
            
            event.target.value = '';
            
            if (!file.type.startsWith('image/')) {
                alert('❌ Bitte wählen Sie eine Bilddatei aus');
                return;
            }
            
            try {
                const preview = document.getElementById(`desktop_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'block';
                    preview.src = '';
                }
                
                const result = await processAndLimitImage(file);
                
                if (preview) {
                    preview.src = result.dataUrl;
                }
                
                imageStorage[questionId] = result.dataUrl;
                saveCurrentAuditData();
                
                const question = allQuestions.find(q => q.id === questionId);
                if (question) {
                    question.deviation.hasImage = true;
                }
                
            } catch (error) {
                alert(`❌ ${error.message}`);
                const preview = document.getElementById(`desktop_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'none';
                }
            }
        }

        async function handleImageUploadMobile(event, questionId) {
            const file = event.target.files[0];
            if (!file) return;
            
            event.target.value = '';
            
            if (!file.type.startsWith('image/')) {
                alert('❌ Bitte wählen Sie eine Bilddatei aus');
                return;
            }
            
            try {
                const preview = document.getElementById(`mobile_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'block';
                    preview.src = '';
                }
                
                const result = await processAndLimitImage(file);
                
                if (preview) {
                    preview.src = result.dataUrl;
                }
                
                imageStorage[questionId] = result.dataUrl;
                saveCurrentAuditData();
                
                const question = allQuestions.find(q => q.id === questionId);
                if (question) {
                    question.deviation.hasImage = true;
                }
                
            } catch (error) {
                alert(`❌ ${error.message}`);
                const preview = document.getElementById(`mobile_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'none';
                }
            }
        }

        function removeImageForQuestion(questionId) {
            delete imageStorage[questionId];
            
            const question = allQuestions.find(q => q.id === questionId);
            if (question) {
                question.deviation.hasImage = false;
            }
            
            saveCurrentAuditData();
            
            const desktopPreview = document.getElementById(`desktop_preview-${questionId}`);
            if (desktopPreview) {
                desktopPreview.style.display = 'none';
                desktopPreview.src = '';
            }
            
            const mobilePreview = document.getElementById(`mobile_preview-${questionId}`);
            if (mobilePreview) {
                mobilePreview.style.display = 'none';
                mobilePreview.src = '';
            }
            
            if (document.getElementById('mobileView').style.display === 'block') {
                renderMobileQuestion();
            }
        }

        function renderParticipants() {
            renderParticipantList('auditor', 'auditorList');
            renderParticipantList('auditee', 'auditeeList');
            renderMobileParticipantList();
        }

        function renderParticipantList(type, containerId) {
            const container = document.getElementById(containerId);
            const items = participants[type + 's'] || [];
            
            container.innerHTML = '';
            items.forEach((participant, index) => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <span>${participant}</span>
                    <button class="remove-participant" onclick="removeParticipant('${type}', ${index})">×</button>
                `;
                container.appendChild(item);
            });
        }

        function renderMobileParticipantList() {
            const container = document.getElementById('mobileParticipantList');
            const items = participants[currentMobileParticipantType + 's'] || [];
            
            container.innerHTML = '';
            items.forEach((participant, index) => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <span>${participant}</span>
                    <button class="remove-participant" onclick="removeMobileParticipant(${index})">×</button>
                `;
                container.appendChild(item);
            });
        }

        function addParticipant(type) {
            const input = document.getElementById(`${type}Input`);
            const name = input.value.trim();
            
            if (name) {
                participants[type + 's'].push(name);
                input.value = '';
                renderParticipants();
                saveCurrentAuditData();
            }
        }

        function addMobileParticipant() {
            const input = document.getElementById('mobileParticipantInput');
            const name = input.value.trim();
            
            if (name) {
                participants[currentMobileParticipantType + 's'].push(name);
                input.value = '';
                renderMobileParticipantList();
                saveCurrentAuditData();
            }
        }

        function removeParticipant(type, index) {
            participants[type + 's'].splice(index, 1);
            renderParticipants();
            saveCurrentAuditData();
        }

        function removeMobileParticipant(index) {
            participants[currentMobileParticipantType + 's'].splice(index, 1);
            renderMobileParticipantList();
            saveCurrentAuditData();
        }

        function setupMobileParticipants() {
            const typeButtons = document.querySelectorAll('.mobile-participant-type-btn');
            typeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMobileParticipantType = this.dataset.type;
                    renderMobileParticipantList();
                });
            });
        }

        function setupEventListeners() {
            // Audit-Auswahl Buttons
            document.querySelectorAll('.audit-btn').forEach(btn => {
                if (btn.dataset.audit) {
                    btn.addEventListener('click', function() {
                        startAudit(this.dataset.audit);
                    });
                }
            });

            // Zurück-Button
            document.getElementById('backBtn').addEventListener('click', goBackToSelection);

            // BERICHT-BUTTON
            document.getElementById('reportBtn').addEventListener('click', generateReport);

            // Ansicht umschalten
            document.getElementById('toggleViewBtn').addEventListener('click', toggleView);

            // Reset Button
            document.getElementById('resetBtn').addEventListener('click', function(e) {
                e.preventDefault();
                showResetConfirmation();
            });

            // Evaluation Button
            document.getElementById('evaluationBtn').addEventListener('click', showEvaluation);

            // Mobile Navigation
            document.getElementById('prevBtn').addEventListener('click', function() {
                if (currentMobileQuestion > 0) {
                    currentMobileQuestion--;
                    renderMobileQuestion();
                }
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                if (currentMobileQuestion < allQuestionElements.length - 1) {
                    currentMobileQuestion++;
                    renderMobileQuestion();
                }
            });

            // Responsive Anpassungen
            window.addEventListener('resize', handleResize);
        }

        function setupDesktopEventListeners() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('points-option')) {
                    const questionElement = e.target.closest('.question');
                    if (!questionElement) return;
                    
                    const questionId = questionElement.dataset.id;
                    const points = parseInt(e.target.dataset.points);
                    
                    updateQuestionData(questionId, 'points', points);
                    
                    questionElement.querySelectorAll('.points-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    
                    const pointsDisplay = questionElement.querySelector('.points-display');
                    if (pointsDisplay) {
                        pointsDisplay.textContent = `${points} Punkte`;
                        pointsDisplay.style.backgroundColor = `${getPointsColor(points)}20`;
                        pointsDisplay.style.color = getPointsColor(points);
                        pointsDisplay.style.borderColor = getPointsColor(points);
                    }
                    
                    const deviationSection = questionElement.querySelector('.deviation-section');
                    if (deviationSection) {
                        if (points !== null && points <= 8) {
                            deviationSection.style.display = 'block';
                        } else {
                            deviationSection.style.display = 'none';
                        }
                    }
                    
                    if (document.getElementById('mobileView').style.display === 'block') {
                        renderMobileQuestion();
                    }
                }
            });

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('evidence')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'evidence', e.target.value);
                }
            });

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('deviation-field')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'deviation', { text: e.target.value });
                }
            });

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('responsible-field')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'deviation', { responsible: e.target.value });
                }
            });
        }

        function setupSectionHeaders() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
                
                newHeader.addEventListener('click', handleSectionClick);
            });
        }

        function handleSectionClick() {
            const section = this.parentElement;
            const isExpanded = section.classList.contains('expanded');
            
            section.classList.toggle('expanded');
            const span = this.querySelector('span');
            span.textContent = section.classList.contains('expanded') ? '▼' : '▶';
            
            const content = section.querySelector('.section-content');
            if (content) {
                content.style.display = section.classList.contains('expanded') ? 'block' : 'none';
            }
        }

        function setupMobileQuestionListeners(questionId) {
            const pointsOptions = document.querySelectorAll('.points-option');
            pointsOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const points = parseInt(this.dataset.points);
                    updateQuestionData(questionId, 'points', points);
                    
                    pointsOptions.forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    const pointsDisplay = document.querySelector('.points-display');
                    if (pointsDisplay) {
                        pointsDisplay.textContent = `${points} Punkte`;
                        pointsDisplay.style.backgroundColor = `${getPointsColor(points)}20`;
                        pointsDisplay.style.color = getPointsColor(points);
                        pointsDisplay.style.borderColor = getPointsColor(points);
                    }
                    
                    const deviationSection = document.querySelector('.deviation-section');
                    if (deviationSection) {
                        if (points !== null && points <= 8) {
                            deviationSection.style.display = 'block';
                        } else {
                            deviationSection.style.display = 'none';
                        }
                    }
                    
                    renderAuditSections();
                    setupSectionHeaders();
                });
            });

            const evidenceTextarea = document.querySelector('.evidence');
            if (evidenceTextarea) {
                evidenceTextarea.addEventListener('input', function() {
                    updateQuestionData(questionId, 'evidence', this.value);
                });
            }

            const deviationTextarea = document.querySelector('.deviation-field');
            if (deviationTextarea) {
                deviationTextarea.addEventListener('input', function() {
                    updateQuestionData(questionId, 'deviation', { text: this.value });
                });
            }

            const responsibleInput = document.querySelector('.responsible-field');
            if (responsibleInput) {
                responsibleInput.addEventListener('input', function() {
                    updateQuestionData(questionId, 'deviation', { responsible: this.value });
                });
            }
        }

        function toggleView() {
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (desktopView.style.display === 'block') {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                toggleBtn.textContent = '🖥️ Desktop';
                renderMobileQuestion();
            } else {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                toggleBtn.textContent = '📱 Mobile';
                renderAuditSections();
                setupSectionHeaders();
            }
        }

        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (isMobile && desktopView.style.display === 'block') {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                toggleBtn.textContent = '🖥️ Desktop';
                renderMobileQuestion();
            } else if (!isMobile && mobileView.style.display === 'block') {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                toggleBtn.textContent = '📱 Mobile';
                renderAuditSections();
                setupSectionHeaders();
            }
        }

        function showResetConfirmation() {
            const dialogHtml = `
                <div id="resetConfirmDialog" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                ">
                    <div style="
                        background: white;
                        padding: 20px;
                        border-radius: 10px;
                        max-width: 90%;
                        width: 300px;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    ">
                        <h3 style="margin-bottom: 15px; color: #e74c3c; font-size: 1.1em;">⚠️ Audit zurücksetzen</h3>
                        <p style="margin-bottom: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                            Sind Sie sicher?<br>
                            Alle Daten für dieses Audit werden gelöscht.
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="resetCancelBtn" style="
                                padding: 10px 16px;
                                background: #95a5a6;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 0.9em;
                                min-width: 80px;
                            ">Abbrechen</button>
                            <button id="resetConfirmBtn" style="
                                padding: 10px 16px;
                                background: #e74c3c;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 0.9em;
                                min-width: 80px;
                            ">Löschen</button>
                        </div>
                    </div>
                </div>
            `;
            
            const dialogContainer = document.createElement('div');
            dialogContainer.innerHTML = dialogHtml;
            document.body.appendChild(dialogContainer.firstElementChild);
            
            document.getElementById('resetCancelBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const dialog = document.getElementById('resetConfirmDialog');
                if (dialog) {
                    dialog.remove();
                }
            });
            
            document.getElementById('resetConfirmBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const dialog = document.getElementById('resetConfirmDialog');
                if (dialog) {
                    dialog.remove();
                }
                resetAudit();
            });
            
            document.getElementById('resetConfirmDialog').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        }

        // === EXPORT FUNKTIONEN ===
        async function exportSingleFile() {
            if (!currentAuditType || !currentAuditData) return;
            
            saveCurrentAuditData();
            
            const exportData = { ...currentAuditData };
            exportData.images = imageStorage;
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            a.download = `ZfP-Audit_${AUDIT_TYPES[currentAuditType].title}_${timestamp}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const imageCount = Object.keys(imageStorage).length;
            const answeredQuestions = allQuestions.filter(q => q.points !== null).length;
            const totalQuestions = allQuestions.length;
            
            alert(`✅ Audit wurde exportiert\n\n📁 Dateiname: ${a.download}\n📊 Enthaltene Daten:\n• ${answeredQuestions}/${totalQuestions} Fragen bewertet\n• ${participants.auditors.length} Auditor(en)\n• ${participants.auditees.length} auditierte Person(en)\n• ${imageCount} Bild(er) als Base64 kodiert`);
        }

        async function exportWithImagesSeparate() {
            if (!currentAuditType || !currentAuditData) return;
            
            saveCurrentAuditData();
            
            const exportData = { ...currentAuditData };
            exportData.images = {};
            exportData.meta.exportMode = 'separate';
            exportData.meta.imageReferences = {};
            
            Object.keys(imageStorage).forEach(questionId => {
                const imageData = imageStorage[questionId];
                const matches = imageData.match(/^data:(image\/[a-zA-Z]*);base64,(.*)$/);
                if (matches) {
                    const mimeType = matches[1];
                    const extension = mimeType.split('/')[1] || 'jpg';
                    exportData.meta.imageReferences[questionId] = `${questionId}.${extension}`;
                }
            });
            
            const jsonStr = JSON.stringify(exportData, null, 2);
            const jsonBlob = new Blob([jsonStr], { type: 'application/json' });
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const jsonFilename = `ZfP-Audit_${AUDIT_TYPES[currentAuditType].title}_${timestamp}.json`;
            
            downloadFile(jsonBlob, jsonFilename);
            
            let imageCount = 0;
            const imagePromises = [];
            
            for (const [questionId, imageData] of Object.entries(imageStorage)) {
                const matches = imageData.match(/^data:(image\/[a-zA-Z]*);base64,(.*)$/);
                if (matches) {
                    imagePromises.push(
                        new Promise((resolve) => {
                            setTimeout(() => {
                                const mimeType = matches[1];
                                const base64Data = matches[2];
                                const extension = mimeType.split('/')[1] || 'jpg';
                                
                                const byteCharacters = atob(base64Data);
                                const byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                const byteArray = new Uint8Array(byteNumbers);
                                const blob = new Blob([byteArray], { type: mimeType });
                                
                                downloadFile(blob, `${questionId}.${extension}`);
                                imageCount++;
                                resolve();
                            }, 300 * imageCount);
                        })
                    );
                }
            }
            
            await Promise.all(imagePromises);
            
            setTimeout(() => {
                alert(`✅ Export erfolgreich!\n\n📁 Exportierte Dateien:\n• ${jsonFilename} (Audit-Daten)\n• ${imageCount} Bilddatei(en)\n\n⚠️ Wichtig: JSON-Datei und Bilder müssen im gleichen Ordner bleiben!`);
            }, 500);
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (!loadedData.meta || !loadedData.meta.auditType) {
                        throw new Error('Ungültiges Audit-Datenformat');
                    }
                    
                    const auditType = loadedData.meta.auditType;
                    
                    if (currentAuditType !== auditType) {
                        if (confirm(`Sie haben ein ${AUDIT_TYPES[auditType].title}-Audit geladen.\nMöchten Sie zu diesem Audit wechseln?`)) {
                            startAudit(auditType);
                        }
                    }
                    
                    currentAuditData = loadedData;
                    allQuestions = currentAuditData.questions || [];
                    participants = currentAuditData.participants || { auditors: [], auditees: [] };
                    imageStorage = currentAuditData.images || {};
                    
                    localStorage.setItem(`zfpAuditReview_${auditType}`, JSON.stringify(currentAuditData));
                    
                    renderAuditSections();
                    setupSectionHeaders();
                    renderParticipants();
                    renderMobileQuestion();
                    updateCurrentAuditProgress();
                    
                    alert(`✅ Audit wurde geladen:\n\n${loadedData.meta.title}\nStandards: ${loadedData.meta.standards}\nLetzte Änderung: ${new Date(loadedData.meta.lastModified).toLocaleDateString()}`);
                    
                } catch (error) {
                    alert(`❌ Fehler beim Laden: ${error.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetAudit() {
            if (!currentAuditType) return;
            
            const sections = AUDIT_DATA[currentAuditType];
            allQuestions = sections.flatMap(section => 
                section.questions.map(q => ({
                    ...q,
                    sectionTitle: section.title,
                    sectionShort: section.short,
                    points: null,
                    evidence: "",
                    deviation: { text: "", responsible: "", hasImage: false }
                }))
            );
            
            participants = { auditors: [], auditees: [] };
            imageStorage = {};
            
            currentAuditData = {
                meta: {
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    auditType: currentAuditType,
                    title: AUDIT_TYPES[currentAuditType].title,
                    standards: AUDIT_TYPES[currentAuditType].standards,
                    auditNumber: generateAuditNumber()
                },
                participants: participants,
                questions: allQuestions,
                images: imageStorage
            };
            
            localStorage.setItem(`zfpAuditReview_${currentAuditType}`, JSON.stringify(currentAuditData));
            
            renderAuditSections();
            setupSectionHeaders();
            renderParticipants();
            renderMobileQuestion();
            updateCurrentAuditProgress();
            
            alert('✅ Audit wurde zurückgesetzt');
        }

        function printAudit() {
            saveCurrentAuditData();
            window.print();
        }

        function showEvaluation() {
            const evaluation = document.getElementById('evaluation');
            evaluation.style.display = evaluation.style.display === 'block' ? 'none' : 'block';
            
            if (evaluation.style.display === 'block') {
                renderEvaluation();
            }
        }

        function renderEvaluation() {
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.points !== null).length;
            const points = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? (points / maxPoints) * 100 : 0;
            
            let grade = 'A';
            let color = '#27ae60';
            
            if (percent >= 90) {
                grade = 'A';
                color = '#27ae60';
            } else if (percent >= 80) {
                grade = 'B';
                color = '#2ecc71';
            } else if (percent >= 70) {
                grade = 'C';
                color = '#f39c12';
            } else if (percent >= 60) {
                grade = 'D';
                color = '#e67e22';
            } else {
                grade = 'F';
                color = '#e74c3c';
            }
            
            const lowScoreQuestions = allQuestions
                .filter(q => q.points !== null && q.points <= 4)
                .map(q => ({
                    id: q.id,
                    text: q.text,
                    points: q.points,
                    deviation: q.deviation?.text || 'Keine Abweichung'
                }));
            
            const evaluationContent = document.getElementById('evaluationContent');
            evaluationContent.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <h3 style="margin-bottom: 10px; color: #2c3e50;">Zusammenfassung</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Gesamtpunkte</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${points}/${maxPoints}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Prozent</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: ${color};">${percent.toFixed(1)}%</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Note</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: ${color};">${grade}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Beantwortet</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${answered}/${total}</div>
                        </div>
                    </div>
                </div>
                
                ${lowScoreQuestions.length > 0 ? `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3f3; border-radius: 5px; border-left: 4px solid #e74c3c;">
                        <h3 style="margin-bottom: 10px; color: #c0392b;">Kritische Fragen (≤ 4 Punkte)</h3>
                        <div style="font-size: 0.9em;">
                            ${lowScoreQuestions.map(q => `
                                <div style="margin-bottom: 8px; padding: 8px; background-color: white; border-radius: 4px;">
                                    <strong style="color: #e74c3c;">${q.id} (${q.points} Punkte)</strong><br>
                                    ${q.text}<br>
                                    <em style="color: #7f8c8d; font-size: 0.9em;">Abweichung: ${q.deviation}</em>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 15px; padding: 10px; background-color: #e8f4fc; border-radius: 5px;">
                    <h3 style="margin-bottom: 10px; color: #2c3e50;">Empfehlungen</h3>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        ${percent >= 90 ? 
                            '<li>✅ Sehr gutes Ergebnis. Der Prozess ist effektiv und gut dokumentiert.</li>' : 
                        percent >= 80 ? 
                            '<li>⚠️ Gutes Ergebnis. Einige Verbesserungspotentiale vorhanden.</li>' : 
                        percent >= 70 ? 
                            '<li>⚠️ Akzeptables Ergebnis. Es sollten Maßnahmen zur Verbesserung geplant werden.</li>' : 
                            '<li>❌ Kritisches Ergebnis. Es sind dringende Maßnahmen erforderlich.</li>'}
                        ${answered < total ? 
                            '<li>⚠️ Nicht alle Fragen wurden bewertet. Bitte vervollständigen Sie das Audit.</li>' : ''}
                        ${lowScoreQuestions.length > 0 ? 
                            `<li>⚠️ ${lowScoreQuestions.length} Fragen haben kritisch niedrige Punktzahlen. Diese sollten priorisiert angegangen werden.</li>` : ''}
                    </ul>
                </div>
            `;
        }
    </script>
</body>
</html>