<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZfP Audit-Checkliste - Schaeffler</title>
    <style>
        /* === ALLE EXISTIERENDEN STYLES BEIBEHALTEN === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background-color: #f5f5f5;
            padding: 6px;
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        header {
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2c3e50;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 1.3em;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        /* === KONTROLLELEMENTE === */
        .controls-single-row {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            flex-wrap: nowrap;
            justify-content: space-between;
        }
        .controls-single-row button {
            padding: 5px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75em;
            min-height: 30px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-back { background: #7f8c8d; color: white; }
        .btn-report { background: #8e44ad; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-desktop { background: #95a5a6; color: white; }
        button:hover { opacity: 0.9; }

        /* === BERICHT-MODAL (Neu) === */
        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            overflow: auto;
        }
        
        .report-modal-content {
            background: white;
            margin: 20px auto;
            width: 210mm;  /* Feste A4 Breite */
            min-height: 297mm;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .report-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .report-modal-print {
            position: absolute;
            top: 10px;
            right: 50px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            z-index: 10001;
        }
        
        .report-modal iframe {
            width: 100%;
            height: calc(100vh - 1px);
            border: none;
            border-radius: 5px;
        }

        /* === DRUCK-STYLES F√úR DEN BERICHT === */
        @media print {
            body * {
                visibility: hidden;
            }
            .report-container, .report-container * {
                visibility: visible;
            }
            .report-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
        }

        /* === REST DER EXISTIERENDEN STYLES (unver√§ndert) === */
        .audit-selection {
            text-align: center;
            margin: 15px 0;
        }
        .audit-selection h2 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        .audit-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        .audit-btn {
            padding: 12px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        .audit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .audit-btn.wirbelstrom { background: #3498db; }
        .audit-btn.magnetpulver { background: #e74c3c; }
        .audit-btn.nital { background: #2ecc71; }
        .audit-btn.ultraschall { background: #9b59b6; }
        .audit-btn .btn-icon {
            font-size: 1.6em;
            margin-bottom: 6px;
        }
        .audit-btn .btn-progress {
            margin-top: 4px;
            font-size: 0.7em;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 35px;
        }

        .participants-section {
            background: #f8f9fa;
            border: 1px solid #3498db;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .participants-section h3 {
            color: #2c3e50;
            margin-bottom: 8px;
            text-align: center;
            font-size: 0.9em;
        }
        .participants-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        .participant-group {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .participant-group h4 {
            color: #2c3e50;
            margin-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 3px;
            font-size: 0.8em;
        }
        .participant-input-container {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        .participant-input {
            flex: 1;
            padding: 4px 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.8em;
        }
        .add-participant {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.65em;
            width: 24px;
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .participant-list {
            margin-top: 5px;
            max-height: 80px;
            overflow-y: auto;
            font-size: 0.75em;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .remove-participant {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 1px 5px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.7em;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audit-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.8em;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .audit-status span {
            flex: 1;
            text-align: center;
            min-width: 100px;
            margin: 2px 0;
        }
        .audit-progress-container {
            margin: 10px 0;
            background: #ecf0f1;
            border-radius: 5px;
            height: 10px;
            overflow: hidden;
        }
        .audit-progress-bar {
            height: 100%;
            background: #27ae60;
            border-radius: 5px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.5em;
            font-weight: bold;
        }

        .section {
            margin-bottom: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            overflow: hidden;
        }
        .section-header {
            background: #34495e;
            color: white;
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header:hover {
            background: #2c3e50;
        }
        .section-header h2 { 
            margin: 0; 
            font-size: 1em;
        }
        .section-header span {
            transition: transform 0.3s;
        }
        .section.expanded .section-header span {
            transform: rotate(90deg);
        }
        .section-content {
            padding: 8px;
            display: none;
        }
        .section.expanded .section-content { 
            display: block; 
        }

        .question {
            margin-bottom: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .question-text { 
            flex: 1; 
            font-weight: 500;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .question-id {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 8px;
            white-space: nowrap;
        }
        .points-options {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .points-option {
            flex: 1;
            min-width: 40px;
            padding: 6px 2px;
            border: 2px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        .points-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .points-option.selected {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }
        .points-option[data-points="0"] { border-color: #e74c3c; color: #e74c3c; }
        .points-option[data-points="0"].selected { background: #e74c3c; color: white; }
        .points-option[data-points="2"] { border-color: #e67e22; color: #e67e22; }
        .points-option[data-points="2"].selected { background: #e67e22; color: white; }
        .points-option[data-points="4"] { border-color: #f1c40f; color: #f1c40f; }
        .points-option[data-points="4"].selected { background: #f1c40f; color: #333; }
        .points-option[data-points="8"] { border-color: #2ecc71; color: #2ecc71; }
        .points-option[data-points="8"].selected { background: #2ecc71; color: white; }
        .points-option[data-points="10"] { border-color: #27ae60; color: #27ae60; }
        .points-option[data-points="10"].selected { background: #27ae60; color: white; }
        .points-display {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            padding: 6px;
            border-radius: 3px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        .evidence {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .deviation-section {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background-color: #fff3f3;
            border-radius: 3px;
            border-left: 3px solid #e74c3c;
        }
        .deviation-section h4 { 
            color: #c0392b; 
            margin-bottom: 5px; 
            font-size: 0.85em;
        }
        .deviation-field, .responsible-field {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e74c3c;
            border-radius: 3px;
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .responsible-field {
            border-color: #ddd;
            min-height: auto;
        }
        .image-upload { margin-bottom: 8px; }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 5px;
        }
        .file-input-label {
            display: inline-block;
            padding: 5px 8px;
            background: #3498db;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            display: none;
        }
        .remove-image {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.75em;
        }

        .mobile-view .participants-section {
            padding: 8px;
            margin-bottom: 8px;
        }
        .mobile-participant-type {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        .mobile-participant-type-btn {
            flex: 1;
            padding: 4px;
            border: 1px solid #3498db;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 0.7em;
        }
        .mobile-participant-type-btn.active {
            background: #3498db;
            color: white;
        }
        .mobile-participant-input-container {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }
        .mobile-participant-input {
            flex: 1;
            padding: 4px 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.8em;
        }
        .mobile-add-participant {
            background: #27ae60;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
        }

        .mobile-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            align-items: center;
        }
        .mobile-nav button {
            padding: 6px 10px;
            font-size: 0.8em;
            min-width: 80px;
            border: none;
            border-radius: 4px;
            background: #95a5a6;
            color: white;
            cursor: pointer;
        }
        #mobileCounter {
            font-size: 0.85em;
            padding: 0 10px;
            text-align: center;
            font-weight: bold;
        }

        .mobile-section-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-bottom: 8px;
        }
        .section-btn { 
            flex: 1; 
            min-width: 60px; 
            font-size: 0.7em;
            padding: 4px 5px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: none;
            border-radius: 3px;
            background: #3498db;
            color: white;
            cursor: pointer;
        }

        .evaluation {
            display: none;
            margin-top: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            padding: 10px;
        }
        .evaluation.active { display: block; }
        .evaluation h2 {
            font-size: 1em;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .desktop-view { display: block; }
        .mobile-view { display: none; }
        .audit-content { display: none; }
        .audit-content.active { display: block; }
        .audit-selection { display: none; }
        .audit-selection.active { display: block; }

        footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 0.85em;
        }
        .creator-info {
            font-weight: bold;
            color: #2c3e50;
            margin-top: 4px;
            font-size: 0.9em;
        }
        .version-info {
            margin-top: 2px;
            font-size: 0.8em;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            .container { 
                padding: 8px !important; 
            }
            
            .desktop-view { 
                display: none !important; 
            }
            .mobile-view { 
                display: block !important; 
            }
            
            .audit-buttons {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .audit-btn {
                padding: 10px 6px;
                min-height: 70px;
                font-size: 0.85em;
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                padding-left: 12px;
            }
            
            .audit-btn .btn-icon {
                font-size: 1.4em;
                margin-right: 8px;
                margin-bottom: 0;
            }
            
            .audit-btn .btn-progress {
                margin-left: auto;
                margin-top: 0;
            }
            
            .audit-btn.wirbelstrom::before { content: "ET - "; }
            .audit-btn.magnetpulver::before { content: "MT - "; }
            .audit-btn.nital::before { content: "NE - "; }
            .audit-btn.ultraschall::before { content: "UT - "; }
            
            .controls-top {
                gap: 3px;
                margin-bottom: 8px;
            }
            
            .controls-top button {
                padding: 4px 5px;
                font-size: 0.7em;
                min-height: 26px;
            }
            
            .controls-bottom {
                gap: 3px;
                margin-bottom: 8px;
            }
            
            .controls-bottom button {
                padding: 4px 5px;
                font-size: 0.7em;
                min-height: 28px;
                min-width: 60px;
            }
            
            .participants-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .question {
                padding: 8px;
            }
            
            .question-text {
                font-size: 0.85em;
            }
            
            .question-id {
                font-size: 0.7em;
                margin-left: 5px;
            }
            
            .points-options {
                gap: 2px;
            }
            
            .points-option {
                min-width: 30px;
                padding: 4px 2px;
                font-size: 0.8em;
            }
            
            .mobile-nav button {
                min-width: 60px;
                padding: 5px 8px;
            }
            
            .mobile-section-selector {
                gap: 2px;
            }
            
            .section-btn {
                min-width: 50px;
                font-size: 0.65em;
                padding: 3px 4px;
            }
            
            .evidence, .deviation-field, .responsible-field {
                font-size: 0.8em;
                padding: 5px 6px;
            }
        }

        @media (max-width: 360px) {
            .container { 
                padding: 6px !important; 
            }
            
            .audit-btn {
                padding: 8px 5px;
                min-height: 60px;
                font-size: 0.8em;
            }
            
            .controls-top button {
                padding: 3px 4px;
                font-size: 0.65em;
                min-height: 24px;
            }
            
            .controls-bottom button {
                padding: 3px 4px;
                font-size: 0.65em;
                min-height: 26px;
                min-width: 55px;
            }
            
            .question-text {
                font-size: 0.8em;
            }
            
            .mobile-nav button {
                min-width: 50px;
                padding: 4px 6px;
            }
            
            #mobileCounter {
                font-size: 0.75em;
            }
        }
        
        @media (min-width: 769px) {
            body {
                font-size: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .controls-top button {
                padding: 8px 10px;
                font-size: 0.85em;
                min-height: 36px;
            }
            
            .controls-bottom button {
                padding: 8px 10px;
                font-size: 0.85em;
                min-height: 38px;
                min-width: 80px;
            }
            
            .participants-section {
                padding: 12px;
            }
            
            .participant-input {
                padding: 6px 8px;
                font-size: 0.9em;
            }
            
            .question {
                padding: 12px;
            }
            
            .question-text {
                font-size: 1em;
            }
            
            .question-id {
                font-size: 0.85em;
                padding: 3px 8px;
            }
            
            .points-option {
                min-width: 45px;
                padding: 8px 2px;
                font-size: 1em;
            }
            
            .evidence, .deviation-field, .responsible-field {
                padding: 8px 10px;
                font-size: 0.9em;
                min-height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ZfP Audit-Checkliste</h1>
            <div class="subtitle">Zerst√∂rungsfreie Pr√ºfverfahren - Schaeffler</div>
        </header>

        <!-- AUDIT AUSWAHL -->
        <div id="auditSelection" class="audit-selection active">
            <h2>Audit-Verfahren ausw√§hlen:</h2>
            <div class="audit-buttons">
                <button class="audit-btn wirbelstrom" data-audit="wirbelstrom">
                    <div class="btn-icon">‚ö°</div>
                    <span>Wirbelstrompr√ºfung</span>
                    <div class="btn-progress" id="wirbelstromProgress">0%</div>
                </button>
                <button class="audit-btn magnetpulver" data-audit="magnetpulver">
                    <div class="btn-icon">üß≤</div>
                    <span>Magnetpulverpr√ºfung</span>
                    <div class="btn-progress" id="magnetpulverProgress">0%</div>
                </button>
                <button class="audit-btn nital" data-audit="nital">
                    <div class="btn-icon">üß™</div>
                    <span>Nital-√Ñtzen</span>
                    <div class="btn-progress" id="nitalProgress">0%</div>
                </button>
                <button class="audit-btn ultraschall" data-audit="ultraschall">
                    <div class="btn-icon">üì°</div>
                    <span>Ultraschallpr√ºfung</span>
                    <div class="btn-progress" id="ultraschallProgress">0%</div>
                </button>
            </div>
        </div>

        <!-- AUDIT CONTENT -->
        <div id="auditContent" class="audit-content">
            <!-- EINE ZEILE F√úR ALLE BUTTONS -->
            <div class="controls-single-row">
                <button class="btn-back" id="backBtn">‚Üê Zur√ºck</button>
                <button class="btn-report" id="reportBtn">üìã Bericht</button>
                <button class="btn-danger" id="resetBtn">üóëÔ∏è Reset</button>
                <button class="btn-info" id="evaluationBtn">üìä Auswertung</button>
                <button class="btn-desktop" id="toggleViewBtn">üñ•Ô∏è Desktop</button>
            </div>

            <!-- Desktop Teilnehmer -->
            <div class="participants-section desktop-view">
                <h3>üìã Teilnehmer</h3>
                <div class="participants-grid">
                    <div class="participant-group">
                        <h4>üë®‚Äçüíº Auditor</h4>
                        <div class="participant-input-container">
                            <input type="text" class="participant-input" id="auditorInput" placeholder="Name">
                            <button class="add-participant" onclick="addParticipant('auditor')">+</button>
                        </div>
                        <div class="participant-list" id="auditorList"></div>
                    </div>
                    <div class="participant-group">
                        <h4>üë• Auditiert</h4>
                        <div class="participant-input-container">
                            <input type="text" class="participant-input" id="auditeeInput" placeholder="Name">
                            <button class="add-participant" onclick="addParticipant('auditee')">+</button>
                        </div>
                        <div class="participant-list" id="auditeeList"></div>
                    </div>
                </div>
            </div>

            <!-- Mobile Teilnehmer -->
            <div class="participants-section mobile-view">
                <h3>üìã Teilnehmer</h3>
                <div class="mobile-participant-type">
                    <button class="mobile-participant-type-btn active" data-type="auditor">üë®‚Äçüíº Auditor</button>
                    <button class="mobile-participant-type-btn" data-type="auditee">üë• Auditiert</button>
                </div>
                <div class="mobile-participant-input-container">
                    <input type="text" class="mobile-participant-input" id="mobileParticipantInput" placeholder="Name">
                    <button class="mobile-add-participant" onclick="addMobileParticipant()">+</button>
                </div>
                <div class="participant-list" id="mobileParticipantList"></div>
            </div>

            <!-- Statusanzeige -->
            <div class="audit-status">
                <span class="status-part">Fortschritt: <strong id="progressText">0%</strong></span>
                <span class="separator"> </span>
                <span class="status-part">Frage <strong id="answeredCount">0</strong>/<strong id="totalCount">24</strong></span>
                <span class="separator"> </span>
                <span class="status-part"><strong id="pointsTotal">0</strong>/<strong id="pointsMax">240</strong> Punkte</span>
            </div>
            <div class="audit-progress-container">
                <div class="audit-progress-bar" id="auditProgressBar" style="width: 0%">0%</div>
            </div>

            <!-- Desktop Ansicht -->
            <div class="desktop-view" id="desktopView">
                <div id="auditSections"></div>
            </div>

            <!-- Mobile Ansicht -->
            <div class="mobile-view" id="mobileView">
                <div class="mobile-section-selector" id="sectionSelector"></div>
                <div id="mobileQuestions"></div>
                <div class="mobile-nav">
                    <button class="btn-secondary" id="prevBtn">‚Üê Zur√ºck</button>
                    <span id="mobileCounter">Frage 1/1</span>
                    <button class="btn-secondary" id="nextBtn">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Evaluation -->
            <div class="evaluation" id="evaluation">
                <h2>Auswertung</h2>
                <div id="evaluationContent"></div>
            </div>
        </div>

        <footer>
            <p>ZfP Audit-Checkliste &copy; 2025 Schaeffler</p>
            <div class="version-info">Version AC - 01.12.2025</div>
            <div class="creator-info">Ersteller: Daniel H√§usner, WI/SW2-PQT</div>
        </footer>
    </div>

    <!-- === BERICHT-MODAL === -->
    <div id="reportModal" class="report-modal">
        <div class="report-modal-content">
            <button class="report-modal-close" onclick="closeReport()">√ó</button>
            <button class="report-modal-print" onclick="printReport()">üñ®Ô∏è Drucken</button>
            <iframe id="reportFrame" title="Auditbericht"></iframe>
        </div>
    </div>


    <script>
        // === KONSTANTEN UND DATENSTRUKTUREN ===
        const AUDIT_TYPES = {
            wirbelstrom: {
                id: 'wirbelstrom',
                title: 'Wirbelstrompr√ºfung',
                short: 'ET',
                color: '#3498db',
                icon: '‚ö°',
                standards: 'S245006-1 / S245008-1 / S245007-1 / S245012'
            },
            magnetpulver: {
                id: 'magnetpulver',
                title: 'Magnetpulverpr√ºfung',
                short: 'MT',
                color: '#e74c3c',
                icon: 'üß≤',
                standards: 'S245008-2 / S245012'
            },
            nital: {
                id: 'nital',
                title: 'Nital-√Ñtzen',
                short: 'NE',
                color: '#2ecc71',
                icon: 'üß™',
                standards: 'S245013-1 / S245012-1'
            },
            ultraschall: {
                id: 'ultraschall',
                title: 'Ultraschallpr√ºfung',
                short: 'UT',
                color: '#9b59b6',
                icon: 'üì°',
                standards: 'S245009-3 / S245012'
            }
        };

        // VOLLST√ÑNDIGE AUDIT-DATEN
        const AUDIT_DATA = {
            wirbelstrom: [
                {
                    title: "1.1 Personal und Qualifikation",
                    short: "1.1 Personal",
                    questions: [
                        { id: "1.1.1", text: "Ist der Level-2-Experte f√ºr die Wirbelstrompr√ºfung qualifiziert? (Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "1.1.2", text: "Sind alle Bediener f√ºr die Wirbelstrompr√ºfung geschult? (Schulungsplan, Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "1.1.3", text: "Ist ein Verantwortlicher (Supervisor) f√ºr die Methode definiert, und erf√ºllt dieser die Anforderungen gem√§√ü S245012?" },
                        { id: "1.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "1.2 Ausr√ºstung und Plausibilit√§tspr√ºfung",
                    short: "1.2 Ausr√ºstung",
                    questions: [
                        { id: "1.2.1", text: "Wird die t√§gliche Plausibilit√§tspr√ºfung durchgef√ºhrt und dokumentiert?" },
                        { id: "1.2.2", text: "Wird die j√§hrliche √úberpr√ºfung durchgef√ºhrt und dokumentiert?" },
                        { id: "1.2.3", text: "Wird die Maschine einschlie√ülich relevanter Messger√§te in SAP √ºberwacht? (Maschine, Restmagnetfeldmessger√§t, Magnetfeldst√§rkemessger√§t)" },
                        { id: "1.2.4", text: "Befindet sich die Maschine in einem guten technischen Zustand? (Software gem√§√ü IATF, Hardware)" }
                    ]
                },
                {
                    title: "1.3 Pr√ºfanweisungen",
                    short: "1.3 Anweisungen",
                    questions: [
                        { id: "1.3.1", text: "Ist die Pr√ºfanweisung vollst√§ndig? (Parameter, Ger√§t, Sonde, Grenzwerte, Ma√ünahmen, Unterschrift eines Level-2-Pr√ºfers)" },
                        { id: "1.3.2", text: "Ist der Pr√ºfprozess im Control1- oder Pr√ºfplan beschrieben?" },
                        { id: "1.3.3", text: "Existiert eine Pr√ºfdokumentation, die Informationen √ºber Pr√ºfergebnisse und Prozessentscheidungen enth√§lt (siehe 1.3.1)?" },
                        { id: "1.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                        { id: "1.3.5", text: "Sind die Messungen des Restmagnetismus im Pr√ºfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "1.4 Referenzteile S285066",
                    short: "1.4 Referenzteile",
                    questions: [
                        { id: "1.4.1", text: "Existieren Referenzteile zur Maschinen√ºberpr√ºfung gem√§√ü S285066 (Merkmale der Fehler)?" },
                        { id: "1.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "1.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "1.4.4", text: "Werden die Referenzteile √ºberwacht?" }
                    ]
                },
                {
                    title: "1.5 Prozess",
                    short: "1.5 Prozess",
                    questions: [
                        { id: "1.5.1", text: "Entsprechen die Parameter und die Sonde der Pr√ºfanweisung, und ist die Anlage funktionsf√§hig?" },
                        { id: "1.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "1.5.3", text: "Wird das Zwischenbeh√§lter-Prinzip angewendet?" },
                        { id: "1.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "1.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "1.5.6", text: "Sind die Randbedingungen f√ºr die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "1.5.7", text: "Ist die Schutzausr√ºstung funktionsf√§hig und wird sie verwendet? (Pers√∂nliche Schutzausr√ºstung / Maschinenschutz)" }
                    ]
                }
            ],
            magnetpulver: [
                {
                    title: "2.1 Qualifikation",
                    short: "2.1 Qualifikation",
                    questions: [
                        { id: "2.1.1", text: "Ist der Level-2-Experte f√ºr Magnetpulverpr√ºfung (MPI) qualifiziert? (Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "2.1.2", text: "Sind alle Bediener f√ºr die Magnetpulverpr√ºfung geschult? (Schulungsplan, Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "2.1.3", text: "Ist ein Verantwortlicher f√ºr die Methode definiert, und erf√ºllt dieser die Anforderungen gem√§√ü S245012?" },
                        { id: "2.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "2.2 Ausr√ºstung und Plausibilit√§tspr√ºfung",
                    short: "2.2 Ausr√ºstung",
                    questions: [
                        { id: "2.2.1", text: "Wird die t√§gliche Plausibilit√§tspr√ºfung durchgef√ºhrt und dokumentiert? (ASTM-R√∂hre, MTU Nr. 3)" },
                        { id: "2.2.2", text: "Wird die monatliche √úberpr√ºfung der UV-Lampe durchgef√ºhrt und dokumentiert?" },
                        { id: "2.2.3", text: "Wird die j√§hrliche √úberpr√ºfung durchgef√ºhrt und dokumentiert?" },
                        { id: "2.2.4", text: "Wird die Maschine in SAP √ºberwacht (Software gem√§√ü IATF)?" },
                        { id: "2.2.5", text: "Sind die Magnetisierungswerte stabil?" },
                        { id: "2.2.6", text: "Werden die Messger√§te √ºberwacht und in SAP gef√ºhrt? (UV-Meter, Lux-Meter, Magnetfeldst√§rkemessger√§t inkl. Referenzmagnet)" },
                        { id: "2.2.7", text: "Wird ein Restmagnetfeldmessger√§t (Gaussmeter) verwendet? (Handhabung, √úberwachung, SAP, Referenzblock)" },
                        { id: "2.2.8", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gem√§√ü IATF, Hardware)" }
                    ]
                },
                {
                    title: "2.3 Pr√ºfanweisungen",
                    short: "2.3 Anweisungen",
                    questions: [
                        { id: "2.3.1", text: "Ist die Pr√ºfanweisung vollst√§ndik? (Parameter, Ger√§t, Grenzwerte, Ma√ünahmen, Unterschrift Level 2)" },
                        { id: "2.3.2", text: "Ist der Pr√ºfprozess im Control- oder Pr√ºfplan enthalten?" },
                        { id: "2.3.3", text: "Existiert eine Pr√ºfdokumentation mit Ergebnissen und Prozessentscheidungen (siehe 1.3.1)?" },
                        { id: "2.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der neuesten Version vor?" },
                        { id: "2.3.5", text: "Sind Restmagnetismus-Messungen im Pr√ºfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "2.4 Referenzteile S285066",
                    short: "2.4 Referenzteile",
                    questions: [
                        { id: "2.4.1", text: "Existieren Referenzteile zur Maschinen√ºberpr√ºfung gem√§√ü S285066 (Merkmale der Fehler)?" },
                        { id: "2.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "2.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "2.4.4", text: "Werden die Referenzteile √ºberwacht?" }
                    ]
                },
                {
                    title: "2.5 Prozess",
                    short: "2.5 Prozess",
                    questions: [
                        { id: "2.5.1", text: "Entsprechen die Parameter und die Sonde der Pr√ºfanweisung, und ist die Anlage funktionsf√§hig?" },
                        { id: "2.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "2.5.3", text: "Wird das Zwischenbeh√§lter-Prinzip angewendet?" },
                        { id: "2.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "2.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "2.5.6", text: "Sind die Randbedingungen f√ºr die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "2.5.7", text: "Ist die Schutzausr√ºstung funktionsf√§hig und wird sie verwendet? (Pers√∂nliche Schutzausr√ºstung / Maschinenschutz)" }
                    ]
                }
            ],
            nital: [
                {
                    title: "3.1 Qualifikation",
                    short: "3.1 Qualifikation",
                    questions: [
                        { id: "3.1.1", text: "Ist der Level-2-Experte f√ºr Nital-√Ñtzpr√ºfung qualifiziert? (Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "3.1.2", text: "Sind alle Bediener f√ºr die Nital-√Ñtzpr√ºfung geschult? (Schulungsplan, Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "3.1.3", text: "Ist ein Verantwortlicher f√ºr die Methode definiert, und erf√ºllt dieser die Anforderungen gem√§√ü S245012?" },
                        { id: "3.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "3.2 Ausr√ºstung und Plausibilit√§tspr√ºfung",
                    short: "3.2 Ausr√ºstung",
                    questions: [
                        { id: "3.2.1", text: "Wird die t√§gliche Plausibilit√§tspr√ºfung durchgef√ºhrt und dokumentiert?" },
                        { id: "3.2.2", text: "Entspricht der Reinigungsprozess der Norm? (Parameter, Ultraschall)" },
                        { id: "3.2.3", text: "Entspricht der √Ñtzprozess der Norm? (Material, chemische Analyse, √úberwachung)" },
                        { id: "3.2.4", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gem√§√ü IATF, Hardware)" }
                    ]
                },
                {
                    title: "3.3 Pr√ºfanweisungen",
                    short: "3.3 Anweisungen",
                    questions: [
                        { id: "3.3.1", text: "Ist die Pr√ºfanweisung vollst√§ndig? (Parameter, Ger√§t, Grenzwerte, Ma√ünahmen, Unterschrift eines Level-2-Pr√ºfers)" },
                        { id: "3.3.2", text: "Ist der Pr√ºfprozess im Control- oder Pr√ºfplan beschrieben?" },
                        { id: "3.3.3", text: "Existiert eine Pr√ºfdokumentation, die Informationen √ºber Pr√ºfergebnisse und Prozessentscheidungen enth√§lt?" },
                        { id: "3.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                        { id: "3.3.5", text: "Sind die Messungen des Restmagnetismus im Pr√ºfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "3.4 Referenzteile S285066",
                    short: "3.4 Referenzteile",
                    questions: [
                        { id: "3.4.1", text: "Existieren Referenzteile zur Maschinen√ºberpr√ºfung gem√§√ü S285066 (Merkmale der Fehler)?" },
                        { id: "3.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "3.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "3.4.4", text: "Werden die Referenzteile √ºberwacht?" }
                    ]
                },
                {
                    title: "3.5 Prozess",
                    short: "3.5 Prozess",
                    questions: [
                        { id: "3.5.1", text: "Entsprechen die Parameter und die Sonde der Pr√ºfanweisung, und ist die Anlage funktionsf√§hig?" },
                        { id: "3.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "3.5.3", text: "Wird das Zwischenbeh√§lter-Prinzip angewendet?" },
                        { id: "3.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "3.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "3.5.6", text: "Sind die Randbedingungen f√ºr die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "3.5.7", text: "Ist die Schutzausr√ºstung funktionsf√§hik und wird sie verwendet? (Pers√∂nliche Schutzausr√ºstung / Maschinenschutz)" }
                    ]
                }
            ],
            ultraschall: [
                {
                    title: "4.1 Qualifikation",
                    short: "4.1 Qualifikation",
                    questions: [
                        { id: "4.1.1", text: "Ist der Level-2-Experte f√ºr Ultraschallpr√ºfung (UT) qualifiziert? (Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "4.1.2", text: "Sind alle Bediener f√ºr die Ultraschallpr√ºfung geschult? (Schulungsplan, Zertifikat, g√ºltiger Sehtestnachweis)" },
                        { id: "4.1.3", text: "Ist ein Verantwortlicher f√ºr die Methode definiert, und erf√ºllt dieser die Anforderungen gem√§√ü S245012?" },
                        { id: "4.1.4", text: "Ist der Bediener mit der Basisanweisung vertraut?" }
                    ]
                },
                {
                    title: "4.2 Ausr√ºstung und Plausibilit√§tspr√ºfung",
                    short: "4.2 Ausr√ºstung",
                    questions: [
                        { id: "4.2.1", text: "Wird die t√§gliche Plausibilit√§tspr√ºfung durchgef√ºhrt und dokumentiert?" },
                        { id: "4.2.2", text: "Wird die j√§hrliche √úberpr√ºfung durchgef√ºhrt und dokumentiert?" },
                        { id: "4.2.3", text: "Wird die Maschine einschlie√ülich relevanter Messger√§te in SAP √ºberwacht? (Maschine, Restmagnetfeldmessger√§t, Magnetfeldst√§rkemessger√§t, Software gem√§√ü IATF)" },
                        { id: "4.2.4", text: "Befindet sich die Maschine in gutem technischen Zustand? (Software gem√§√ü IATF, Hardware)" }
                    ]
                },
                {
                    title: "4.3 Pr√ºfanweisungen",
                    short: "4.3 Anweisungen",
                    questions: [
                        { id: "4.3.1", text: "Ist die Pr√ºfanweisung vollst√§ndig? (Parameter, Ger√§t, Grenzwerte, Ma√ünahmen, Unterschrift eines Level-2-Pr√ºfers)" },
                        { id: "4.3.2", text: "Ist der Pr√ºfprozess im Control- oder Pr√ºfplan beschrieben?" },
                        { id: "4.3.3", text: "Existiert eine Pr√ºfdokumentation, die Informationen √ºber Pr√ºfergebnisse und Prozessentscheidungen enth√§lt?" },
                        { id: "4.3.4", text: "Liegen die erforderlichen Anweisungen am Arbeitsplatz in der aktuellsten Version vor?" },
                        { id: "4.3.5", text: "Sind die Messungen des Restmagnetismus im Pr√ºfplan enthalten (falls erforderlich)?" }
                    ]
                },
                {
                    title: "4.4 Referenzteile S285066",
                    short: "4.4 Referenzteile",
                    questions: [
                        { id: "4.4.1", text: "Existieren Referenzteile zur Maschinen√ºberpr√ºfung gem√§√ü S285066 (Merkmale der Fehler)?" },
                        { id: "4.4.2", text: "Sind diese Referenzteile gekennzeichnet und korrekt gelagert?" },
                        { id: "4.4.3", text: "Sind die Referenzteile in SAP angelegt?" },
                        { id: "4.4.4", text: "Werden die Referenzteile √ºberwacht?" }
                    ]
                },
                {
                    title: "4.5 Prozess",
                    short: "4.5 Prozess",
                    questions: [
                        { id: "4.5.1", text: "Entsprechen die Parameter und die Sonde der Pr√ºfanweisung, und ist die Anlage funktionsf√§hik?" },
                        { id: "4.5.2", text: "Gibt es einen wirksamen Prozess zur Aussortierung fehlerhafter Teile?" },
                        { id: "4.5.3", text: "Wird das Zwischenbeh√§lter-Prinzip angewendet?" },
                        { id: "4.5.4", text: "Werden fehlerhafte Teile analysiert und kommuniziert?" },
                        { id: "4.5.5", text: "Ist der Produktionsstatus der Teile bekannt, und besteht keine Vermischungsgefahr am Arbeitsplatz (fehlerhafte Teile sind gekennzeichnet)?" },
                        { id: "4.5.6", text: "Sind die Randbedingungen f√ºr die Anlage gegeben (Sauberkeit, Wartung)?" },
                        { id: "4.5.7", text: "Ist die Schutzausr√ºstung funktionsf√§hik und wird sie verwendet? (Pers√∂nliche Schutzausr√ºstung / Maschinenschutz)" }
                    ]
                }
            ]
        };

        // === GLOBALE VARIABLEN ===
        let currentAuditType = null;
        let currentAuditData = null;
        let allQuestions = [];
        let allQuestionElements = [];
        let currentMobileQuestion = 0;
        let imageStorage = {};
        let participants = { auditors: [], auditees: [] };
        let currentMobileParticipantType = 'auditor';

        // === INITIALISIERUNG ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            loadAllAuditData();
            updateAuditProgressDisplays();
        }
        // F√úGE DIESEN CODE AN DEN ANFANG DEINES BEREITS EXISTIERENDEN SKRIPTS (nach Zeile ~1300):
        // (Suche nach: "=== NEUE BERICHT-FUNKTIONEN ===" und f√ºge DAVOR ein)

        // 1. Definiere die einfachen Funktionen
        function closeReport() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function printReport() {
            const reportFrame = document.getElementById('reportFrame');
            if (reportFrame && reportFrame.contentWindow) {
                reportFrame.contentWindow.print();
            }
        }

        // 2. Setze Event-Listener f√ºr die Buttons - DAS IST DAS WICHTIGSTE!
        document.addEventListener('DOMContentLoaded', function() {
            // Diese Funktion wird ausgef√ºhrt, wenn auf die Buttons geklickt wird
            document.addEventListener('click', function(event) {
                // Schlie√üen-Button
                if (event.target.classList.contains('report-modal-close')) {
                    closeReport();
                    event.stopPropagation();
                }
                
                // Drucken-Button
                if (event.target.classList.contains('report-modal-print')) {
                    printReport();
                    event.stopPropagation();
                }
            });
        });

        // 3. √Ñndere die generateReport() Funktion nicht - sie bleibt wie sie ist

        // === NEUE BERICHT-FUNKTIONEN ===
        function generateReport() {
            if (!currentAuditType || !currentAuditData) {
                alert("Bitte zuerst ein Audit ausw√§hlen und ausf√ºllen!");
                return;
            }
            
            saveCurrentAuditData();
            
            const reportHtml = createReportHTML();
            const reportFrame = document.getElementById('reportFrame');
            const reportModal = document.getElementById('reportModal');
            
            reportFrame.srcdoc = reportHtml;
            reportModal.style.display = 'block';
            
            reportFrame.onload = function() {
                reportFrame.style.height = 'calc(100vh - 40px)';
            };
        }

        // UPDATED: Bericht mit integrierter Auswertung in der Zusammenfassung
        function createReportHTML() {
            const auditInfo = AUDIT_TYPES[currentAuditType];
            const totalPoints = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = allQuestions.length * 10;
            const okCount = allQuestions.filter(q => 
                !q.deviation || !q.deviation.text || q.deviation.text.trim() === ''
            ).length;
            const nokCount = allQuestions.filter(q => 
                q.deviation && q.deviation.text && q.deviation.text.trim() !== ''
            ).length;
            const imageCount = allQuestions.filter(q => 
                q.deviation && q.deviation.hasImage === true
            ).length;
            
            // Berechnung der Auswertung
            const percentage = maxPoints > 0 ? (totalPoints / maxPoints * 100) : 0;
            
            // Bestimmung der Note basierend auf Prozentsatz
            let grade = '';
            let gradeColor = '';
            let gradeText = '';
            
            if (percentage >= 95) {
                grade = 'A';
                gradeColor = '#27ae60';
                gradeText = 'Exzellent';
            } else if (percentage >= 85) {
                grade = 'B';
                gradeColor = '#2ecc71';
                gradeText = 'Sehr gut';
            } else if (percentage >= 75) {
                grade = 'C';
                gradeColor = '#f39c12';
                gradeText = 'Gut';
            } else if (percentage >= 65) {
                grade = 'D';
                gradeColor = '#e67e22';
                gradeText = 'Befriedigend';
            } else if (percentage >= 50) {
                grade = 'E';
                gradeColor = '#e74c3c';
                gradeText = 'Ausreichend';
            } else {
                grade = 'F';
                gradeColor = '#c0392b';
                gradeText = 'Nicht bestanden';
            }
            
            // Kritische Fragen (‚â§ 4 Punkte) f√ºr die Auswertung
            const criticalQuestions = allQuestions
                .filter(q => q.points !== null && q.points <= 4)
                .map(q => ({
                    id: q.id,
                    text: q.text.substring(0, 80) + (q.text.length > 80 ? '...' : ''),
                    points: q.points,
                    deviation: q.deviation?.text || 'Keine Angabe'
                }));
            
            // Fragen nach Punktzahl gruppieren f√ºr Statistik
            const pointsDistribution = {
                0: allQuestions.filter(q => q.points === 0).length,
                2: allQuestions.filter(q => q.points === 2).length,
                4: allQuestions.filter(q => q.points === 4).length,
                8: allQuestions.filter(q => q.points === 8).length,
                10: allQuestions.filter(q => q.points === 10).length,
                null: allQuestions.filter(q => q.points === null).length
            };
            
            // Bewertete Fragen
            const answeredQuestions = allQuestions.filter(q => q.points !== null).length;
            const totalQuestions = allQuestions.length;
            
            // Schaeffler Logo URL
            const schaefflerLogoURL = "https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg";
            
            // Bilder f√ºr den Bericht
            const imageData = {};
            Object.keys(imageStorage).forEach(questionId => {
                if (imageStorage[questionId]) {
                    imageData[questionId] = imageStorage[questionId];
                }
            });
            
            const sections = {};
            allQuestions.forEach(question => {
                const sectionKey = question.sectionTitle || 'Allgemein';
                if (!sections[sectionKey]) {
                    sections[sectionKey] = [];
                }
                sections[sectionKey].push({
                    ...question,
                    imageData: imageData[question.id]
                });
            });
            
            // EXAKTE Breiten f√ºr die Tabelle
            const totalTableWidth = 180;
            const colWidths = {
                id: 10,
                question: 55,
                evidence: 30,
                deviation: 35,
                responsible: 20,
                points: 5
            };
            
            let questionsHTML = '';
            Object.keys(sections).forEach(sectionTitle => {
                questionsHTML += `
                <div class="section">
                    <div class="section-header">${sectionTitle}</div>
                    <table class="questions-table" style="width: ${totalTableWidth}mm;">
                        <thead>
                            <tr>
                                <th class="col-id" style="width: ${colWidths.id}mm;">ID</th>
                                <th class="col-question" style="width: ${colWidths.question}mm;">Frage / Pr√ºfpunkt</th>
                                <th class="col-evidence" style="width: ${colWidths.evidence}mm;">Evidenz / Nachweis</th>
                                <th class="col-deviation" style="width: ${colWidths.deviation}mm;">Abweichung / Ma√ünahme</th>
                                <th class="col-responsible" style="width: ${colWidths.responsible}mm;">Verantwortlich</th>
                                <th class="col-points" style="width: ${colWidths.points}mm;">Pkte</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sections[sectionTitle].map(question => {
                                const hasDeviation = question.deviation && question.deviation.text && question.deviation.text.trim() !== '';
                                const hasImage = question.imageData;
                                const statusClass = hasDeviation ? 'status-nok' : (question.points !== null ? 'status-ok' : 'status-na');
                                
                                return `
                                    <tr>
                                        <td class="col-id" style="width: ${colWidths.id}mm;">
                                            <div class="question-id">
                                                <span class="status-indicator ${statusClass}"></span>
                                                ${question.id}
                                            </div>
                                        </td>
                                        <td class="col-question" style="width: ${colWidths.question}mm;">${question.text}</td>
                                        <td class="col-evidence" style="width: ${colWidths.evidence}mm;">${question.evidence || ''}</td>
                                        <td class="col-deviation" style="width: ${colWidths.deviation}mm;">${question.deviation?.text || ''}</td>
                                        <td class="col-responsible" style="width: ${colWidths.responsible}mm;">${question.deviation?.responsible || ''}</td>
                                        <td class="col-points" style="width: ${colWidths.points}mm; text-align: center; font-weight: bold;">${question.points || 0}</td>
                                    </tr>
                                    ${hasImage ? `
                                    <tr class="image-row">
                                        <td colspan="6" style="padding: 2mm 0;">
                                            <div class="report-image-container">
                                                <img src="${question.imageData}" class="report-image" alt="Beweisbild">
                                            </div>
                                        </td>
                                    </tr>
                                    ` : ''}
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                `;
            });
            
            return `
            <!DOCTYPE html>
            <html lang="de">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Auditbericht - ${auditInfo.title} | Schaeffler</title>
                <style>
                    @page {
                        size: A4 portrait;
                        margin: 15mm 10mm 15mm 15mm;
                        @bottom-right {
                            content: "Seite " counter(page) " von " counter(pages);
                            font-size: 8pt;
                            color: #666;
                        }
                    }
                    
                    body {
                        font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        font-size: 10pt;
                        line-height: 1.3;
                        color: #000;
                        margin: 0;
                        padding: 0;
                        width: 100%;
                    }
                    
                    .report-element {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto !important;
                        box-sizing: border-box;
                    }
                    
                    /* ===== KOPFZEILE ===== */
                    .header-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 6mm auto !important;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        border-bottom: 1.5pt solid #003865;
                        padding-bottom: 4mm;
                        box-sizing: border-box;
                    }
                    
                    .title-section {
                        flex: 1;
                        text-align: left;
                        padding-right: 10mm;
                    }
                    
                    .report-title {
                        font-size: 16pt;
                        font-weight: bold;
                        color: #003865;
                        margin-bottom: 1mm;
                        text-transform: uppercase;
                    }
                    
                    .report-subtitle {
                        font-size: 12pt;
                        color: #333;
                        font-weight: 600;
                        margin-bottom: 1mm;
                    }
                    
                    .report-standards {
                        font-size: 10pt;
                        color: #666;
                        font-style: italic;
                    }
                    
                    .logo-section {
                        flex-shrink: 0;
                        text-align: right;
                    }
                    
                    .schaeffler-logo {
                        width: 45mm;
                        height: auto;
                    }
                    
                    /* ===== METADATEN ===== */
                    .meta-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 8mm auto !important;
                        background: #f8f9fa;
                        border: 1pt solid #ddd;
                        border-radius: 4px;
                        padding: 4mm;
                        box-sizing: border-box;
                    }
                    
                    .meta-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 6mm;
                        font-size: 9pt;
                    }
                    
                    .meta-column {
                        display: flex;
                        flex-direction: column;
                        gap: 2mm;
                    }
                    
                    .meta-row {
                        display: flex;
                        justify-content: space-between;
                        padding-bottom: 1.5mm;
                        border-bottom: 0.5pt dotted #ccc;
                    }
                    
                    .meta-row:last-child {
                        border-bottom: none;
                        padding-bottom: 0;
                    }
                    
                    .meta-label {
                        font-weight: bold;
                        color: #003865;
                        min-width: 35mm;
                    }
                    
                    .meta-value {
                        text-align: right;
                        flex: 1;
                    }
                    
                    /* ===== TEILNEHMER ===== */
                    .participants-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 8mm auto !important;
                        background: #f0f7ff;
                        border: 1pt solid #003865;
                        border-radius: 4px;
                        padding: 4mm;
                        box-sizing: border-box;
                    }
                    
                    .container-title {
                        font-weight: bold;
                        color: #003865;
                        font-size: 11pt;
                        text-align: center;
                        margin-bottom: 3mm;
                    }
                    
                    .participants-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 8mm;
                    }
                    
                    .participant-group {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #ddd;
                    }
                    
                    .group-label {
                        font-weight: bold;
                        color: #003865;
                        font-size: 10pt;
                        margin-bottom: 1mm;
                        border-bottom: 1pt solid #ddd;
                        padding-bottom: 1mm;
                    }
                    
                    .group-content {
                        min-height: 8mm;
                        font-size: 10pt;
                        line-height: 1.4;
                    }
                    
                    /* ===== ZUSAMMENFASSUNG MIT AUSWERTUNG ===== */
                    .summary-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto 10mm auto !important;
                        background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
                        border: 1.5pt solid #003865;
                        border-radius: 5px;
                        padding: 5mm;
                        box-sizing: border-box;
                    }
                    
                    .summary-title {
                        font-weight: bold;
                        color: #003865;
                        font-size: 12pt;
                        text-align: center;
                        margin-bottom: 5mm;
                        text-transform: uppercase;
                    }
                    
                    /* ERGEBNIS-√úBERSICHT */
                    .results-overview {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 4mm;
                        margin-bottom: 6mm;
                    }
                    
                    .result-item {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #003865;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        min-height: 20mm;
                    }
                    
                    .result-value {
                        font-size: 14pt;
                        font-weight: bold;
                        color: #003865;
                        margin-bottom: 1mm;
                    }
                    
                    .result-label {
                        font-size: 8pt;
                        color: #666;
                        line-height: 1.3;
                    }
                    
                    /* AUSWERTUNGS-DETAILS */
                    .evaluation-details {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 6mm;
                        margin-top: 6mm;
                        padding-top: 4mm;
                        border-top: 1pt dashed #003865;
                    }
                    
                    .evaluation-column {
                        display: flex;
                        flex-direction: column;
                        gap: 3mm;
                    }
                    
                    .grade-box {
                        background: white;
                        padding: 4mm;
                        border-radius: 4px;
                        border: 2pt solid ${gradeColor};
                        text-align: center;
                    }
                    
                    .grade-value {
                        font-size: 24pt;
                        font-weight: bold;
                        color: ${gradeColor};
                        margin-bottom: 1mm;
                    }
                    
                    .grade-text {
                        font-size: 10pt;
                        font-weight: bold;
                        color: ${gradeColor};
                        margin-bottom: 1mm;
                    }
                    
                    .grade-percentage {
                        font-size: 12pt;
                        font-weight: bold;
                        color: #003865;
                    }
                    
                    .points-distribution {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #ddd;
                    }
                    
                    .distribution-title {
                        font-weight: bold;
                        color: #003865;
                        font-size: 10pt;
                        margin-bottom: 2mm;
                        text-align: center;
                    }
                    
                    .distribution-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 2mm;
                    }
                    
                    .distribution-item {
                        text-align: center;
                        padding: 1mm;
                        border-radius: 2px;
                        background: #f8f9fa;
                    }
                    
                    .distribution-points {
                        font-weight: bold;
                        font-size: 10pt;
                        color: #003865;
                    }
                    
                    .distribution-count {
                        font-size: 9pt;
                        color: #666;
                    }
                    
                    .critical-issues {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #e74c3c;
                        background-color: #fff5f5;
                    }
                    
                    .critical-title {
                        font-weight: bold;
                        color: #e74c3c;
                        font-size: 10pt;
                        margin-bottom: 2mm;
                        text-align: center;
                    }
                    
                    .critical-list {
                        font-size: 8pt;
                        line-height: 1.4;
                        max-height: 25mm;
                        overflow-y: auto;
                    }
                    
                    .critical-item {
                        margin-bottom: 1mm;
                        padding-bottom: 1mm;
                        border-bottom: 0.5pt dotted #ffcccc;
                    }
                    
                    .recommendations {
                        background: white;
                        padding: 3mm;
                        border-radius: 3px;
                        border: 1pt solid #f39c12;
                        background-color: #fff9e6;
                    }
                    
                    .recommendations-title {
                        font-weight: bold;
                        color: #f39c12;
                        font-size: 10pt;
                        margin-bottom: 2mm;
                        text-align: center;
                    }
                    
                    .recommendations-list {
                        font-size: 8pt;
                        line-height: 1.4;
                    }
                    
                    /* ===== FRAGEN TABELLE ===== */
                    .questions-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 0 auto !important;
                        box-sizing: border-box;
                    }
                    
                    .section {
                        margin: 6mm 0;
                        width: 100%;
                    }
                    
                    .section-header {
                        background-color: #003865;
                        color: white;
                        padding: 2.5mm 4mm;
                        font-weight: bold;
                        font-size: 11pt;
                        margin: 5mm 0 3mm 0;
                        border-radius: 3px;
                        width: 96%;
                    }
                    
                    .questions-table {
                        width: 180mm !important;
                        border-collapse: collapse;
                        margin: 0;
                        font-size: 9pt;
                        table-layout: fixed;
                    }
                    
                    .questions-table th {
                        background-color: #e6f0ff;
                        padding: 2.5mm 2mm;
                        text-align: left;
                        font-weight: bold;
                        border-bottom: 1.5pt solid #003865;
                        border-right: 1pt solid #ddd;
                        color: #003865;
                        height: 8mm;
                    }
                    
                    .questions-table td {
                        padding: 2.5mm 2mm;
                        border-bottom: 0.5pt solid #eee;
                        border-right: 1pt solid #eee;
                        vertical-align: top;
                        line-height: 1.4;
                        word-wrap: break-word;
                    }
                    
                    .status-indicator {
                        display: inline-block;
                        width: 6pt;
                        height: 6pt;
                        border-radius: 50%;
                        margin-right: 1.5mm;
                    }
                    
                    .status-ok { background-color: #38a169; }
                    .status-nok { background-color: #e53e3e; }
                    .status-na { background-color: #a0aec0; }
                    
                    .question-id {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                    }
                    
                    .image-row {
                        background-color: #f9f9f9;
                    }
                    
                    .report-image-container {
                        padding: 2mm;
                        text-align: center;
                        border: 1pt dashed #ccc;
                        border-radius: 3px;
                        margin: 2mm 0;
                        background-color: white;
                        page-break-inside: avoid;
                    }
                    
                    .report-image {
                        max-width: 150mm;
                        max-height: 100mm;
                        height: auto;
                        border: 1pt solid #ddd;
                        border-radius: 2px;
                    }
                    
                    /* ===== LEGENDE ===== */
                    .legend-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 8mm auto 5mm auto !important;
                        font-size: 8pt;
                        color: #666;
                        text-align: center;
                        border-top: 1pt dashed #ccc;
                        padding-top: 3mm;
                        box-sizing: border-box;
                    }
                    
                    /* ===== UNTERSCHRIFTEN ===== */
                    .signature-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 10mm auto 0 auto !important;
                        padding-top: 6mm;
                        border-top: 1.5pt solid #003865;
                        font-size: 9pt;
                        box-sizing: border-box;
                    }
                    
                    .signature-grid {
                        display: flex;
                        justify-content: space-between;
                        margin-top: 8mm;
                        width: 100%;
                    }
                    
                    .signature-item {
                        text-align: center;
                        width: 85mm;
                    }
                    
                    .signature-line {
                        border-top: 1pt solid #000;
                        padding-top: 2mm;
                        margin-top: 12mm;
                        min-height: 15mm;
                    }
                    
                    /* ===== DRUCK-STEUERUNG ===== */
                    .print-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 12mm auto 8mm auto !important;
                        padding: 4mm;
                        background: #f8f9fa;
                        border-radius: 6px;
                        border: 1pt solid #ddd;
                        text-align: center;
                        box-sizing: border-box;
                    }
                    
                    .print-btn {
                        padding: 6mm 12mm;
                        background: #003865;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        font-size: 11pt;
                        font-weight: bold;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        gap: 4mm;
                        min-width: 50mm;
                    }
                    
                    .print-btn:hover {
                        background: #00274d;
                    }
                    
                    /* ===== FOOTER ===== */
                    .footer-container {
                        width: 180mm !important;
                        max-width: 180mm !important;
                        margin: 5mm auto 0 auto !important;
                        font-size: 7pt;
                        color: #666;
                        text-align: center;
                        padding-top: 2mm;
                        border-top: 1pt solid #eee;
                        box-sizing: border-box;
                    }
                    
                    /* ===== DRUCK-STYLES ===== */
                    @media print {
                        body {
                            margin: 0;
                            padding: 0;
                            width: 210mm;
                            height: 297mm;
                            font-size: 10pt;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        
                        .print-container {
                            display: none !important;
                        }
                        
                        .header-container,
                        .meta-container,
                        .participants-container,
                        .summary-container,
                        .questions-container,
                        .legend-container,
                        .signature-container,
                        .footer-container {
                            width: 180mm !important;
                            max-width: 180mm !important;
                            margin-left: auto !important;
                            margin-right: auto !important;
                        }
                        
                        .questions-table {
                            width: 180mm !important;
                        }
                        
                        .section, tr {
                            page-break-inside: avoid;
                        }
                    }
                    
                    @media screen {
                        body {
                            background: #f5f5f5;
                            padding: 20px;
                        }
                        
                        .main-container {
                            background: white;
                            padding: 20px;
                            box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            width: calc(180mm + 40px);
                            margin: 0 auto;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="main-container">
                    <!-- KOPFZEILE -->
                    <div class="header-container report-element">
                        <div class="title-section">
                            <div class="report-title">Auditbericht: ${auditInfo.title}</div>
                            <div class="report-subtitle">Zerst√∂rungsfreie Pr√ºfverfahren</div>
                            <div class="report-standards">Standards: ${auditInfo.standards}</div>
                        </div>
                        <div class="logo-section">
                            <img src="${schaefflerLogoURL}" 
                                 class="schaeffler-logo" 
                                 alt="Schaeffler Logo">
                        </div>
                    </div>
                    
                    <!-- METADATEN -->
                    <div class="meta-container report-element">
                        <div class="meta-grid">
                            <div class="meta-column">
                                <div class="meta-row">
                                    <span class="meta-label">Audit-Verfahren:</span>
                                    <span class="meta-value">${auditInfo.title}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Standards:</span>
                                    <span class="meta-value">${auditInfo.standards}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Abteilung:</span>
                                    <span class="meta-value">WI/SW2-PQT</span>
                                </div>
                            </div>
                            <div class="meta-column">
                                <div class="meta-row">
                                    <span class="meta-label">Erstellt am:</span>
                                    <span class="meta-value">${new Date().toLocaleDateString('de-DE')}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Ge√§ndert am:</span>
                                    <span class="meta-value">${new Date(currentAuditData.meta.lastModified).toLocaleDateString('de-DE')}</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">Dokument-ID:</span>
                                    <span class="meta-value">AUD-${currentAuditType.toUpperCase()}-${Date.now().toString(36).toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TEILNEHMER -->
                    <div class="participants-container report-element">
                        <div class="container-title">Teilnehmer</div>
                        <div class="participants-grid">
                            <div class="participant-group">
                                <div class="group-label">Auditoren:</div>
                                <div class="group-content">${participants.auditors.join(', ') || 'Nicht angegeben'}</div>
                            </div>
                            <div class="participant-group">
                                <div class="group-label">Auditierte Personen:</div>
                                <div class="group-content">${participants.auditees.join(', ') || 'Nicht angegeben'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ZUSAMMENFASSUNG MIT AUSWERTUNG -->
                    <div class="summary-container report-element">
                        <div class="summary-title">Zusammenfassung & Auswertung</div>
                        
                        <!-- ERGEBNIS-√úBERSICHT -->
                        <div class="results-overview">
                            <div class="result-item">
                                <div class="result-value">${totalPoints}/${maxPoints}</div>
                                <div class="result-label">Gesamtpunkte<br>erreicht/maximal</div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${okCount}</div>
                                <div class="result-label">
                                    <span class="status-indicator status-ok"></span>
                                    I.O.<br>(10 Punkte)
                                </div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${nokCount}</div>
                                <div class="result-label">
                                    <span class="status-indicator status-nok"></span>
                                    N.I.O.<br>(&lt; 10 Punkte)
                                </div>
                            </div>
                            <div class="result-item">
                                <div class="result-value">${imageCount}</div>
                                <div class="result-label">üì∑<br>Dokumentierte Bilder</div>
                            </div>
                        </div>
                        
                        <!-- AUSWERTUNGS-DETAILS -->
                        <div class="evaluation-details">
                            <!-- LINKE SPALTE: Bewertung & Punkteverteilung -->
                            <div class="evaluation-column">
                                <!-- BEWERTUNG -->
                                <div class="grade-box">
                                    <div class="grade-value">${grade}</div>
                                    <div class="grade-text">${gradeText}</div>
                                    <div class="grade-percentage">${percentage.toFixed(1)}% erreicht</div>
                                </div>
                                
                                <!-- PUNKTEVERTEILUNG -->
                                <div class="points-distribution">
                                    <div class="distribution-title">Punkteverteilung</div>
                                    <div class="distribution-grid">
                                        <div class="distribution-item">
                                            <div class="distribution-points">10 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[10]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">8 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[8]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">4 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[4]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">2 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[2]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">0 Pkte</div>
                                            <div class="distribution-count">${pointsDistribution[0]} Fragen</div>
                                        </div>
                                        <div class="distribution-item">
                                            <div class="distribution-points">Nicht bew.</div>
                                            <div class="distribution-count">${pointsDistribution.null} Fragen</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RECHTE SPALTE: Kritische Punkte & Empfehlungen -->
                            <div class="evaluation-column">
                                <!-- KRITISCHE FRAGEN -->
                                <div class="critical-issues">
                                    <div class="critical-title">Kritische Fragen (‚â§ 4 Punkte)</div>
                                    <div class="critical-list">
                                        ${criticalQuestions.length > 0 ? 
                                            criticalQuestions.map(q => `
                                                <div class="critical-item">
                                                    <strong>${q.id} (${q.points} Pkte):</strong><br>
                                                    ${q.text}<br>
                                                    <em>${q.deviation}</em>
                                                </div>
                                            `).join('') 
                                            : '<div style="text-align: center; color: #666; font-style: italic;">Keine kritischen Fragen</div>'
                                        }
                                    </div>
                                </div>
                                
                                <!-- EMPFEHLUNGEN -->
                                <div class="recommendations">
                                    <div class="recommendations-title">Empfehlungen</div>
                                    <div class="recommendations-list">
                                        ${percentage >= 90 ? 
                                            '<div>‚úÖ Exzellentes Ergebnis. Der Prozess ist effektiv und gut dokumentiert.</div>' : 
                                        percentage >= 80 ? 
                                            '<div>‚ö†Ô∏è Gutes Ergebnis. Einige Verbesserungspotentiale vorhanden.</div>' : 
                                        percentage >= 70 ? 
                                            '<div>‚ö†Ô∏è Akzeptables Ergebnis. Es sollten Ma√ünahmen zur Verbesserung geplant werden.</div>' : 
                                            '<div>‚ùå Kritisch. Dringende Ma√ünahmen erforderlich.</div>'
                                        }
                                        ${answeredQuestions < totalQuestions ? 
                                            '<div>‚ö†Ô∏è Nicht alle Fragen wurden bewertet. Bitte vervollst√§ndigen Sie das Audit.</div>' : ''}
                                        ${criticalQuestions.length > 0 ? 
                                            `<div>‚ö†Ô∏è ${criticalQuestions.length} kritische Fragen sollten priorisiert angegangen werden.</div>` : ''}
                                        ${imageCount > 0 ? 
                                            '<div>‚úÖ Bilder dokumentieren Abweichungen effektiv.</div>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FRAGEN TABELLE -->
                    <div class="questions-container report-element">
                        ${questionsHTML}
                    </div>
                    
                    <!-- LEGENDE -->
                    <div class="legend-container report-element">
                        <span class="status-indicator status-ok"></span> = I.O. (10 Punkte) &nbsp;&nbsp; | &nbsp;&nbsp;
                        <span class="status-indicator status-nok"></span> = N.I.O. (&lt; 10 Punkte) &nbsp;&nbsp; | &nbsp;&nbsp;
                        <span class="status-indicator status-na"></span> = Nicht bewertet
                    </div>
                    
                    <!-- UNTERSCHRIFTEN -->
                    <div class="signature-container report-element">
                        <div style="text-align: center; margin-bottom: 6mm; font-weight: bold; color: #003865;">
                            Unterschriften zur Best√§tigung der Audit-Ergebnisse
                        </div>
                        <div class="signature-grid">
                            <div class="signature-item">
                                Auditor / Pr√ºfer<br>
                                <div class="signature-line"></div>
                                <div style="font-size: 8pt; margin-top: 1mm; color: #666;">
                                    Name, Datum, Unterschrift
                                </div>
                            </div>
                            <div class="signature-item">
                                Auditierter / Bereichsverantwortlicher<br>
                                <div class="signature-line"></div>
                                <div style="font-size: 8pt; margin-top: 1mm; color: #666;">
                                    Name, Datum, Unterschrift
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRUCK-STEUERUNG -->
                    <div class="print-container report-element">
                        <button class="print-btn" onclick="window.print();">üñ®Ô∏è BERICHTSDRUCK STARTEN</button>
                    </div>
                    
                    <!-- FOOTER -->
                    <div class="footer-container report-element">
                        H√§usner Daniel | WI/SW2-PQT | ZfP Audit-Checkliste AD - 07.01.2026<br>
                        Erstellt mit ZfP Audit-Checkliste | Generiert am: ${new Date().toLocaleString('de-DE')}
                    </div>
                </div>
            </body>
            </html>
            `;
        }

        // === URSPR√úNGLICHE FUNKTIONEN (alle erhalten!) ===
        function loadAllAuditData() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const saved = localStorage.getItem(`zfpAudit_${auditType}`);
                if (!saved) {
                    const sections = AUDIT_DATA[auditType];
                    const allQuestionsForAudit = sections.flatMap(section => 
                        section.questions.map(q => ({
                            ...q,
                            sectionTitle: section.title,
                            sectionShort: section.short,
                            points: null,
                            evidence: "",
                            deviation: { text: "", responsible: "", hasImage: false }
                        }))
                    );
                    
                    const initialData = {
                        meta: {
                            created: new Date().toISOString(),
                            lastModified: new Date().toISOString(),
                            auditType: auditType,
                            title: AUDIT_TYPES[auditType].title,
                            standards: AUDIT_TYPES[auditType].standards
                        },
                        participants: { auditors: [], auditees: [] },
                        questions: allQuestionsForAudit,
                        images: {}
                    };
                    localStorage.setItem(`zfpAudit_${auditType}`, JSON.stringify(initialData));
                }
            });
        }

        function startAudit(auditType) {
            currentAuditType = auditType;
            
            document.getElementById('auditSelection').classList.remove('active');
            document.getElementById('auditContent').classList.add('active');
            
            loadCurrentAuditData();
            
            const auditInfo = AUDIT_TYPES[auditType];
            document.querySelector('h1').textContent = `ZfP Audit - ${auditInfo.title}`;
            document.querySelector('.subtitle').textContent = auditInfo.standards;
            
            renderAuditSections();
            setupDesktopEventListeners();
            updateCurrentAuditProgress();
            renderParticipants();
            setupMobileParticipants();
            
            const isMobile = window.innerWidth <= 768;
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (isMobile) {
                document.getElementById('desktopView').style.display = 'none';
                document.getElementById('mobileView').style.display = 'block';
                toggleBtn.textContent = 'üñ•Ô∏è Desktop';
                renderMobileQuestion();
            } else {
                document.getElementById('desktopView').style.display = 'block';
                document.getElementById('mobileView').style.display = 'none';
                toggleBtn.textContent = 'üì± Mobile';
            }
            
            document.getElementById('evaluation').style.display = 'none';
        }

        function loadCurrentAuditData() {
            const saved = localStorage.getItem(`zfpAudit_${currentAuditType}`);
            if (saved) {
                currentAuditData = JSON.parse(saved);
                allQuestions = currentAuditData.questions || [];
                participants = currentAuditData.participants || { auditors: [], auditees: [] };
                imageStorage = currentAuditData.images || {};
            } else {
                const sections = AUDIT_DATA[currentAuditType];
                allQuestions = sections.flatMap(section => 
                    section.questions.map(q => ({
                        ...q,
                        sectionTitle: section.title,
                        sectionShort: section.short,
                        points: null,
                        evidence: "",
                        deviation: { text: "", responsible: "", hasImage: false }
                    }))
                );
                
                currentAuditData = {
                    meta: {
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        auditType: currentAuditType,
                        title: AUDIT_TYPES[currentAuditType].title,
                        standards: AUDIT_TYPES[currentAuditType].standards
                    },
                    participants: { auditors: [], auditees: [] },
                    questions: allQuestions,
                    images: {}
                };
            }
            
            allQuestionElements = allQuestions;
        }

        function saveCurrentAuditData() {
            if (!currentAuditType || !currentAuditData) return;
            
            currentAuditData.questions = allQuestions;
            currentAuditData.participants = participants;
            currentAuditData.images = imageStorage;
            currentAuditData.meta.lastModified = new Date().toISOString();
            
            localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));
            updateAuditProgressDisplays();
            updateCurrentAuditProgress();
        }

        function goBackToSelection() {
            saveCurrentAuditData();
            
            currentAuditType = null;
            currentAuditData = null;
            allQuestions = [];
            allQuestionElements = [];
            
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            
            document.querySelector('h1').textContent = 'ZfP Audit-Checkliste';
            document.querySelector('.subtitle').textContent = 'Zerst√∂rungsfreie Pr√ºfverfahren - Schaeffler';
        }

        function updateAuditProgressDisplays() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const progress = calculateAuditProgress(auditType);
                const progressElement = document.getElementById(`${auditType}Progress`);
                if (progressElement) {
                    progressElement.textContent = `${progress.percent}%`;
                }
            });
        }

        function calculateAuditProgress(auditType) {
            const saved = localStorage.getItem(`zfpAudit_${auditType}`);
            if (!saved) {
                const sections = AUDIT_DATA[auditType];
                const total = sections.reduce((sum, section) => sum + section.questions.length, 0);
                return { answered: 0, total: total, percent: 0, points: 0, maxPoints: total * 10 };
            }
            
            const data = JSON.parse(saved);
            const questions = data.questions || [];
            const total = questions.length;
            const answered = questions.filter(q => q.points !== null).length;
            const points = questions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            
            return { answered, total, percent, points, maxPoints };
        }

        function updateCurrentAuditProgress() {
            if (!allQuestions.length) return;
            
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.points !== null).length;
            const points = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('progressText').textContent = `${percent}%`;
            document.getElementById('pointsTotal').textContent = points;
            document.getElementById('pointsMax').textContent = maxPoints;
            
            const progressBar = document.getElementById('auditProgressBar');
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${percent}%`;
            progressBar.style.backgroundColor = percent === 100 ? '#27ae60' : 
                                              percent >= 75 ? '#2ecc71' :
                                              percent >= 50 ? '#f39c12' :
                                              percent >= 25 ? '#e67e22' : '#e74c3c';
            
            if (currentAuditType) {
                updateAuditProgressDisplays();
            }
        }

        function renderAuditSections() {
            const container = document.getElementById('auditSections');
            container.innerHTML = '';
            
            if (!currentAuditType || !AUDIT_DATA[currentAuditType]) return;
            
            const sections = AUDIT_DATA[currentAuditType];
            
            sections.forEach((section, sectionIndex) => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section';
                sectionElement.innerHTML = `
                    <div class="section-header">
                        <h2>${section.title}</h2>
                        <span>‚ñ∂</span>
                    </div>
                    <div class="section-content" style="display: none;">
                        ${renderQuestions(section.questions)}
                    </div>
                `;
                container.appendChild(sectionElement);
            });
            
            setupSectionHeaders();
        }

        function renderQuestions(questions) {
            return questions.map(question => {
                const questionData = getQuestionData(question.id);
                const hasImage = imageStorage[question.id];
                const points = questionData.points;
                const pointsText = points !== null ? `${points} Punkte` : "Nicht bewertet";
                const pointsColor = getPointsColor(points);
                
                return `
                <div class="question" data-id="${question.id}">
                    <div class="question-header">
                        <div class="question-text">${question.text}</div>
                        <div class="question-id">${question.id}</div>
                    </div>
                    
                    <div class="points-display" style="background-color: ${pointsColor}20; color: ${pointsColor}; border-color: ${pointsColor};">
                        ${pointsText}
                    </div>

                    <div class="points-options">
                        <div class="points-option ${points === 0 ? 'selected' : ''}" data-points="0">0</div>
                        <div class="points-option ${points === 2 ? 'selected' : ''}" data-points="2">2</div>
                        <div class="points-option ${points === 4 ? 'selected' : ''}" data-points="4">4</div>
                        <div class="points-option ${points === 8 ? 'selected' : ''}" data-points="8">8</div>
                        <div class="points-option ${points === 10 ? 'selected' : ''}" data-points="10">10</div>
                    </div>

                    <textarea class="evidence" placeholder="Nachweis / Kommentar / Referenz">${questionData.evidence}</textarea>
                    
                    <div class="deviation-section" style="display: ${points !== null && points <= 8 ? 'block' : 'none'};">
                        <h4>Abweichungsinformationen (nur bei weniger als 10 Punkten)</h4>
                        <textarea class="deviation-field" placeholder="Beschreibung der Abweichung / Ma√ünahmen">${questionData.deviation.text || ''}</textarea>
                        <input type="text" class="responsible-field" placeholder="Verantwortlicher" value="${questionData.deviation.responsible || ''}">
                        <div class="image-upload">
                            <div class="file-input-wrapper">
                                <input type="file" accept="image/*" class="image-input" id="desktop_image-${question.id}" onchange="handleImageUploadDesktop(event, '${question.id}')">
                                <span class="file-input-label">Bild hochladen</span>
                            </div>
                            ${hasImage ? `
                                <img class="image-preview" id="desktop_preview-${question.id}" src="${hasImage}" style="display: block;">
                                <button type="button" class="remove-image" data-question="${question.id}" onclick="removeImageForQuestion('${question.id}')">Bild entfernen</button>
                            ` : `
                                <img class="image-preview" id="desktop_preview-${question.id}" style="display: none;">
                            `}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderMobileQuestion() {
            if (allQuestionElements.length === 0) return;
            
            const container = document.getElementById('mobileQuestions');
            const question = allQuestionElements[currentMobileQuestion];
            if (!question) return;
            
            const questionData = getQuestionData(question.id);
            const hasImage = imageStorage[question.id];
            const points = questionData.points;
            const pointsColor = getPointsColor(points);
            
            container.innerHTML = `
                <div class="question" data-id="${question.id}">
                    <div class="question-header">
                        <div class="question-text">${question.text}</div>
                        <div class="question-id">${question.id}</div>
                    </div>
                    
                    <div class="points-display" style="background-color: ${pointsColor}20; color: ${pointsColor}; border-color: ${pointsColor};">
                        ${points !== null ? `${points} Punkte` : "Nicht bewertet"}
                    </div>

                    <div class="points-options">
                        <div class="points-option ${points === 0 ? 'selected' : ''}" data-points="0">0</div>
                        <div class="points-option ${points === 2 ? 'selected' : ''}" data-points="2">2</div>
                        <div class="points-option ${points === 4 ? 'selected' : ''}" data-points="4">4</div>
                        <div class="points-option ${points === 8 ? 'selected' : ''}" data-points="8">8</div>
                        <div class="points-option ${points === 10 ? 'selected' : ''}" data-points="10">10</div>
                    </div>

                    <textarea class="evidence" placeholder="Nachweis / Kommentar / Referenz">${questionData.evidence}</textarea>
                    
                    <div class="deviation-section" style="display: ${points !== null && points <= 8 ? 'block' : 'none'};">
                        <h4>Abweichungsinformationen</h4>
                        <textarea class="deviation-field" placeholder="Beschreibung der Abweichung / Ma√ünahmen">${questionData.deviation.text || ''}</textarea>
                        <input type="text" class="responsible-field" placeholder="Verantwortlicher" value="${questionData.deviation.responsible || ''}">
                        <div class="image-upload">
                            <div class="file-input-wrapper">
                                <input type="file" accept="image/*" class="image-input" id="mobile_image-${question.id}" onchange="handleImageUploadMobile(event, '${question.id}')">
                                <span class="file-input-label">Bild hochladen</span>
                            </div>
                            ${hasImage ? `
                                <img class="image-preview" id="mobile_preview-${question.id}" src="${hasImage}" style="display: block;">
                                <button type="button" class="remove-image" data-question="${question.id}" onclick="removeImageForQuestion('${question.id}')">Bild entfernen</button>
                            ` : `
                                <img class="image-preview" id="mobile_preview-${question.id}" style="display: none;">
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mobileCounter').textContent = `Frage ${currentMobileQuestion + 1}/${allQuestionElements.length}`;
            renderMobileSectionSelector();
            
            setTimeout(() => {
                setupMobileQuestionListeners(question.id);
            }, 10);
        }

        function renderMobileSectionSelector() {
            const container = document.getElementById('sectionSelector');
            container.innerHTML = '';
            
            if (!currentAuditType || !AUDIT_DATA[currentAuditType]) return;
            
            const sections = AUDIT_DATA[currentAuditType];
            const sectionsData = [];
            
            let questionIndex = 0;
            sections.forEach((section, sectionIndex) => {
                sectionsData.push({
                    title: section.title,
                    short: section.short,
                    startIndex: questionIndex,
                    count: section.questions.length
                });
                questionIndex += section.questions.length;
            });
            
            sectionsData.forEach((section, index) => {
                const button = document.createElement('button');
                button.className = 'section-btn';
                button.textContent = section.short;
                button.title = section.title;
                button.addEventListener('click', function() {
                    currentMobileQuestion = section.startIndex;
                    renderMobileQuestion();
                    container.scrollIntoView({ behavior: 'smooth' });
                });
                container.appendChild(button);
            });
        }

        function getQuestionData(questionId) {
            return allQuestions.find(q => q.id === questionId) || {
                points: null,
                evidence: "",
                deviation: { text: "", responsible: "", hasImage: false }
            };
        }

        function getPointsColor(points) {
            const colors = {
                0: "#e74c3c",
                2: "#e67e22", 
                4: "#f39c12",
                8: "#2ecc71",
                10: "#27ae60"
            };
            return colors[points] || "#95a5a6";
        }

        function updateQuestionData(questionId, field, value) {
            const question = allQuestions.find(q => q.id === questionId);
            if (question) {
                if (field === 'deviation') {
                    question.deviation = { ...question.deviation, ...value };
                } else if (field === 'evidence') {
                    question.evidence = value;
                } else if (field === 'points') {
                    question.points = value;
                    
                    const questionElement = document.querySelector(`.question[data-id="${questionId}"]`);
                    if (questionElement) {
                        const deviationSection = questionElement.querySelector('.deviation-section');
                        if (deviationSection) {
                            if (value !== null && value <= 8) {
                                deviationSection.style.display = 'block';
                            } else {
                                deviationSection.style.display = 'none';
                            }
                        }
                    }
                }
                saveCurrentAuditData();
                updateCurrentAuditProgress();
            }
        }

        async function processAndLimitImage(file, maxWidth = 1200, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    reject(new Error(`Bild ist zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximale Gr√∂√üe: 10MB`));
                    return;
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    try {
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve({
                            dataUrl: compressedDataUrl,
                            originalSize: file.size,
                            compressedSize: Math.floor((compressedDataUrl.length - 'data:image/jpeg;base64,'.length) * 0.75),
                            dimensions: { width, height }
                        });
                    } catch (error) {
                        reject(new Error('Bild konnte nicht verarbeitet werden'));
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Bild konnte nicht geladen werden'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        async function handleImageUploadDesktop(event, questionId) {
            const file = event.target.files[0];
            if (!file) return;
            
            event.target.value = '';
            
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Bitte w√§hlen Sie eine Bilddatei aus');
                return;
            }
            
            try {
                const preview = document.getElementById(`desktop_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'block';
                    preview.src = '';
                }
                
                const result = await processAndLimitImage(file);
                
                if (preview) {
                    preview.src = result.dataUrl;
                }
                
                imageStorage[questionId] = result.dataUrl;
                saveCurrentAuditData();
                
                const question = allQuestions.find(q => q.id === questionId);
                if (question) {
                    question.deviation.hasImage = true;
                }
                
            } catch (error) {
                alert(`‚ùå ${error.message}`);
                const preview = document.getElementById(`desktop_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'none';
                }
            }
        }

        async function handleImageUploadMobile(event, questionId) {
            const file = event.target.files[0];
            if (!file) return;
            
            event.target.value = '';
            
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Bitte w√§hlen Sie eine Bilddatei aus');
                return;
            }
            
            try {
                const preview = document.getElementById(`mobile_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'block';
                    preview.src = '';
                }
                
                const result = await processAndLimitImage(file);
                
                if (preview) {
                    preview.src = result.dataUrl;
                }
                
                imageStorage[questionId] = result.dataUrl;
                saveCurrentAuditData();
                
                const question = allQuestions.find(q => q.id === questionId);
                if (question) {
                    question.deviation.hasImage = true;
                }
                
            } catch (error) {
                alert(`‚ùå ${error.message}`);
                const preview = document.getElementById(`mobile_preview-${questionId}`);
                if (preview) {
                    preview.style.display = 'none';
                }
            }
        }

        function removeImageForQuestion(questionId) {
            delete imageStorage[questionId];
            
            const question = allQuestions.find(q => q.id === questionId);
            if (question) {
                question.deviation.hasImage = false;
            }
            
            saveCurrentAuditData();
            
            const desktopPreview = document.getElementById(`desktop_preview-${questionId}`);
            if (desktopPreview) {
                desktopPreview.style.display = 'none';
                desktopPreview.src = '';
            }
            
            const mobilePreview = document.getElementById(`mobile_preview-${questionId}`);
            if (mobilePreview) {
                mobilePreview.style.display = 'none';
                mobilePreview.src = '';
            }
            
            if (document.getElementById('mobileView').style.display === 'block') {
                renderMobileQuestion();
            }
        }

        function renderParticipants() {
            renderParticipantList('auditor', 'auditorList');
            renderParticipantList('auditee', 'auditeeList');
            renderMobileParticipantList();
        }

        function renderParticipantList(type, containerId) {
            const container = document.getElementById(containerId);
            const items = participants[type + 's'] || [];
            
            container.innerHTML = '';
            items.forEach((participant, index) => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <span>${participant}</span>
                    <button class="remove-participant" onclick="removeParticipant('${type}', ${index})">√ó</button>
                `;
                container.appendChild(item);
            });
        }

        function renderMobileParticipantList() {
            const container = document.getElementById('mobileParticipantList');
            const items = participants[currentMobileParticipantType + 's'] || [];
            
            container.innerHTML = '';
            items.forEach((participant, index) => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <span>${participant}</span>
                    <button class="remove-participant" onclick="removeMobileParticipant(${index})">√ó</button>
                `;
                container.appendChild(item);
            });
        }

        function addParticipant(type) {
            const input = document.getElementById(`${type}Input`);
            const name = input.value.trim();
            
            if (name) {
                participants[type + 's'].push(name);
                input.value = '';
                renderParticipants();
                saveCurrentAuditData();
            }
        }

        function addMobileParticipant() {
            const input = document.getElementById('mobileParticipantInput');
            const name = input.value.trim();
            
            if (name) {
                participants[currentMobileParticipantType + 's'].push(name);
                input.value = '';
                renderMobileParticipantList();
                saveCurrentAuditData();
            }
        }

        function removeParticipant(type, index) {
            participants[type + 's'].splice(index, 1);
            renderParticipants();
            saveCurrentAuditData();
        }

        function removeMobileParticipant(index) {
            participants[currentMobileParticipantType + 's'].splice(index, 1);
            renderMobileParticipantList();
            saveCurrentAuditData();
        }

        function setupMobileParticipants() {
            const typeButtons = document.querySelectorAll('.mobile-participant-type-btn');
            typeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMobileParticipantType = this.dataset.type;
                    renderMobileParticipantList();
                });
            });
        }

        function setupEventListeners() {
            // Audit-Auswahl Buttons
            document.querySelectorAll('.audit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    startAudit(this.dataset.audit);
                });
            });

            // Zur√ºck-Button
            document.getElementById('backBtn').addEventListener('click', goBackToSelection);

            // BERICHT-BUTTON
            document.getElementById('reportBtn').addEventListener('click', generateReport);

            // Ansicht umschalten
            document.getElementById('toggleViewBtn').addEventListener('click', toggleView);

            // Reset Button
            document.getElementById('resetBtn').addEventListener('click', function(e) {
                e.preventDefault();
                showResetConfirmation();
            });

            // Evaluation Button
            document.getElementById('evaluationBtn').addEventListener('click', showEvaluation);

            // Mobile Navigation
            document.getElementById('prevBtn').addEventListener('click', function() {
                if (currentMobileQuestion > 0) {
                    currentMobileQuestion--;
                    renderMobileQuestion();
                }
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                if (currentMobileQuestion < allQuestionElements.length - 1) {
                    currentMobileQuestion++;
                    renderMobileQuestion();
                }
            });

            // Responsive Anpassungen
            window.addEventListener('resize', handleResize);
        }

        function setupDesktopEventListeners() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('points-option')) {
                    const questionElement = e.target.closest('.question');
                    if (!questionElement) return;
                    
                    const questionId = questionElement.dataset.id;
                    const points = parseInt(e.target.dataset.points);
                    
                    updateQuestionData(questionId, 'points', points);
                    
                    questionElement.querySelectorAll('.points-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    
                    const pointsDisplay = questionElement.querySelector('.points-display');
                    if (pointsDisplay) {
                        pointsDisplay.textContent = `${points} Punkte`;
                        pointsDisplay.style.backgroundColor = `${getPointsColor(points)}20`;
                        pointsDisplay.style.color = getPointsColor(points);
                        pointsDisplay.style.borderColor = getPointsColor(points);
                    }
                    
                    const deviationSection = questionElement.querySelector('.deviation-section');
                    if (deviationSection) {
                        if (points !== null && points <= 8) {
                            deviationSection.style.display = 'block';
                        } else {
                            deviationSection.style.display = 'none';
                        }
                    }
                    
                    if (document.getElementById('mobileView').style.display === 'block') {
                        renderMobileQuestion();
                    }
                }
            });

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('evidence')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'evidence', e.target.value);
                }
            });

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('deviation-field')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'deviation', { text: e.target.value });
                }
            });

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('responsible-field')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'deviation', { responsible: e.target.value });
                }
            });
        }

        function setupSectionHeaders() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
                
                newHeader.addEventListener('click', handleSectionClick);
            });
        }

        function handleSectionClick() {
            const section = this.parentElement;
            const isExpanded = section.classList.contains('expanded');
            
            section.classList.toggle('expanded');
            const span = this.querySelector('span');
            span.textContent = section.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
            
            const content = section.querySelector('.section-content');
            if (content) {
                content.style.display = section.classList.contains('expanded') ? 'block' : 'none';
            }
        }

        function setupMobileQuestionListeners(questionId) {
            const pointsOptions = document.querySelectorAll('.points-option');
            pointsOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const points = parseInt(this.dataset.points);
                    updateQuestionData(questionId, 'points', points);
                    
                    pointsOptions.forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    const pointsDisplay = document.querySelector('.points-display');
                    if (pointsDisplay) {
                        pointsDisplay.textContent = `${points} Punkte`;
                        pointsDisplay.style.backgroundColor = `${getPointsColor(points)}20`;
                        pointsDisplay.style.color = getPointsColor(points);
                        pointsDisplay.style.borderColor = getPointsColor(points);
                    }
                    
                    const deviationSection = document.querySelector('.deviation-section');
                    if (deviationSection) {
                        if (points !== null && points <= 8) {
                            deviationSection.style.display = 'block';
                        } else {
                            deviationSection.style.display = 'none';
                        }
                    }
                    
                    renderAuditSections();
                    setupSectionHeaders();
                });
            });

            const evidenceTextarea = document.querySelector('.evidence');
            if (evidenceTextarea) {
                evidenceTextarea.addEventListener('input', function() {
                    updateQuestionData(questionId, 'evidence', this.value);
                });
            }

            const deviationTextarea = document.querySelector('.deviation-field');
            if (deviationTextarea) {
                deviationTextarea.addEventListener('input', function() {
                    updateQuestionData(questionId, 'deviation', { text: this.value });
                });
            }

            const responsibleInput = document.querySelector('.responsible-field');
            if (responsibleInput) {
                responsibleInput.addEventListener('input', function() {
                    updateQuestionData(questionId, 'deviation', { responsible: this.value });
                });
            }
        }

        function toggleView() {
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (desktopView.style.display === 'block') {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                toggleBtn.textContent = 'üñ•Ô∏è Desktop';
                renderMobileQuestion();
            } else {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                toggleBtn.textContent = 'üì± Mobile';
                renderAuditSections();
                setupSectionHeaders();
            }
        }

        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (isMobile && desktopView.style.display === 'block') {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                toggleBtn.textContent = 'üñ•Ô∏è Desktop';
                renderMobileQuestion();
            } else if (!isMobile && mobileView.style.display === 'block') {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                toggleBtn.textContent = 'üì± Mobile';
                renderAuditSections();
                setupSectionHeaders();
            }
        }

        function showResetConfirmation() {
            const dialogHtml = `
                <div id="resetConfirmDialog" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                ">
                    <div style="
                        background: white;
                        padding: 20px;
                        border-radius: 10px;
                        max-width: 90%;
                        width: 300px;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    ">
                        <h3 style="margin-bottom: 15px; color: #e74c3c; font-size: 1.1em;">‚ö†Ô∏è Audit zur√ºcksetzen</h3>
                        <p style="margin-bottom: 20px; color: #333; font-size: 0.9em; line-height: 1.4;">
                            Sind Sie sicher?<br>
                            Alle Daten f√ºr dieses Audit werden gel√∂scht.
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="resetCancelBtn" style="
                                padding: 10px 16px;
                                background: #95a5a6;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 0.9em;
                                min-width: 80px;
                            ">Abbrechen</button>
                            <button id="resetConfirmBtn" style="
                                padding: 10px 16px;
                                background: #e74c3c;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 0.9em;
                                min-width: 80px;
                            ">L√∂schen</button>
                        </div>
                    </div>
                </div>
            `;
            
            const dialogContainer = document.createElement('div');
            dialogContainer.innerHTML = dialogHtml;
            document.body.appendChild(dialogContainer.firstElementChild);
            
            document.getElementById('resetCancelBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const dialog = document.getElementById('resetConfirmDialog');
                if (dialog) {
                    dialog.remove();
                }
            });
            
            document.getElementById('resetConfirmBtn').addEventListener('click', function(e) {
                e.preventDefault();
                const dialog = document.getElementById('resetConfirmDialog');
                if (dialog) {
                    dialog.remove();
                }
                resetAudit();
            });
            
            document.getElementById('resetConfirmDialog').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        }

        // === EXPORT FUNKTIONEN ===
        async function exportSingleFile() {
            if (!currentAuditType || !currentAuditData) return;
            
            saveCurrentAuditData();
            
            const exportData = { ...currentAuditData };
            exportData.images = imageStorage;
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            a.download = `ZfP-Audit_${AUDIT_TYPES[currentAuditType].title}_${timestamp}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const imageCount = Object.keys(imageStorage).length;
            const answeredQuestions = allQuestions.filter(q => q.points !== null).length;
            const totalQuestions = allQuestions.length;
            
            alert(`‚úÖ Audit wurde exportiert\n\nüìÅ Dateiname: ${a.download}\nüìä Enthaltene Daten:\n‚Ä¢ ${answeredQuestions}/${totalQuestions} Fragen bewertet\n‚Ä¢ ${participants.auditors.length} Auditor(en)\n‚Ä¢ ${participants.auditees.length} auditierte Person(en)\n‚Ä¢ ${imageCount} Bild(er) als Base64 kodiert`);
        }

        async function exportWithImagesSeparate() {
            if (!currentAuditType || !currentAuditData) return;
            
            saveCurrentAuditData();
            
            const exportData = { ...currentAuditData };
            exportData.images = {};
            exportData.meta.exportMode = 'separate';
            exportData.meta.imageReferences = {};
            
            Object.keys(imageStorage).forEach(questionId => {
                const imageData = imageStorage[questionId];
                const matches = imageData.match(/^data:(image\/[a-zA-Z]*);base64,(.*)$/);
                if (matches) {
                    const mimeType = matches[1];
                    const extension = mimeType.split('/')[1] || 'jpg';
                    exportData.meta.imageReferences[questionId] = `${questionId}.${extension}`;
                }
            });
            
            const jsonStr = JSON.stringify(exportData, null, 2);
            const jsonBlob = new Blob([jsonStr], { type: 'application/json' });
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const jsonFilename = `ZfP-Audit_${AUDIT_TYPES[currentAuditType].title}_${timestamp}.json`;
            
            downloadFile(jsonBlob, jsonFilename);
            
            let imageCount = 0;
            const imagePromises = [];
            
            for (const [questionId, imageData] of Object.entries(imageStorage)) {
                const matches = imageData.match(/^data:(image\/[a-zA-Z]*);base64,(.*)$/);
                if (matches) {
                    imagePromises.push(
                        new Promise((resolve) => {
                            setTimeout(() => {
                                const mimeType = matches[1];
                                const base64Data = matches[2];
                                const extension = mimeType.split('/')[1] || 'jpg';
                                
                                const byteCharacters = atob(base64Data);
                                const byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                const byteArray = new Uint8Array(byteNumbers);
                                const blob = new Blob([byteArray], { type: mimeType });
                                
                                downloadFile(blob, `${questionId}.${extension}`);
                                imageCount++;
                                resolve();
                            }, 300 * imageCount);
                        })
                    );
                }
            }
            
            await Promise.all(imagePromises);
            
            setTimeout(() => {
                alert(`‚úÖ Export erfolgreich!\n\nüìÅ Exportierte Dateien:\n‚Ä¢ ${jsonFilename} (Audit-Daten)\n‚Ä¢ ${imageCount} Bilddatei(en)\n\n‚ö†Ô∏è Wichtig: JSON-Datei und Bilder m√ºssen im gleichen Ordner bleiben!`);
            }, 500);
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (!loadedData.meta || !loadedData.meta.auditType) {
                        throw new Error('Ung√ºltiges Audit-Datenformat');
                    }
                    
                    const auditType = loadedData.meta.auditType;
                    
                    if (currentAuditType !== auditType) {
                        if (confirm(`Sie haben ein ${AUDIT_TYPES[auditType].title}-Audit geladen.\nM√∂chten Sie zu diesem Audit wechseln?`)) {
                            startAudit(auditType);
                        }
                    }
                    
                    currentAuditData = loadedData;
                    allQuestions = currentAuditData.questions || [];
                    participants = currentAuditData.participants || { auditors: [], auditees: [] };
                    imageStorage = currentAuditData.images || {};
                    
                    localStorage.setItem(`zfpAudit_${auditType}`, JSON.stringify(currentAuditData));
                    
                    renderAuditSections();
                    setupSectionHeaders();
                    renderParticipants();
                    renderMobileQuestion();
                    updateCurrentAuditProgress();
                    
                    alert(`‚úÖ Audit wurde geladen:\n\n${loadedData.meta.title}\nStandards: ${loadedData.meta.standards}\nLetzte √Ñnderung: ${new Date(loadedData.meta.lastModified).toLocaleDateString()}`);
                    
                } catch (error) {
                    alert(`‚ùå Fehler beim Laden: ${error.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetAudit() {
            if (!currentAuditType) return;
            
            const sections = AUDIT_DATA[currentAuditType];
            allQuestions = sections.flatMap(section => 
                section.questions.map(q => ({
                    ...q,
                    sectionTitle: section.title,
                    sectionShort: section.short,
                    points: null,
                    evidence: "",
                    deviation: { text: "", responsible: "", hasImage: false }
                }))
            );
            
            participants = { auditors: [], auditees: [] };
            imageStorage = {};
            
            currentAuditData = {
                meta: {
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    auditType: currentAuditType,
                    title: AUDIT_TYPES[currentAuditType].title,
                    standards: AUDIT_TYPES[currentAuditType].standards
                },
                participants: participants,
                questions: allQuestions,
                images: imageStorage
            };
            
            localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));
            
            renderAuditSections();
            setupSectionHeaders();
            renderParticipants();
            renderMobileQuestion();
            updateCurrentAuditProgress();
            
            alert('‚úÖ Audit wurde zur√ºckgesetzt');
        }

        function printAudit() {
            saveCurrentAuditData();
            window.print();
        }

        function showEvaluation() {
            const evaluation = document.getElementById('evaluation');
            evaluation.style.display = evaluation.style.display === 'block' ? 'none' : 'block';
            
            if (evaluation.style.display === 'block') {
                renderEvaluation();
            }
        }

        function renderEvaluation() {
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.points !== null).length;
            const points = allQuestions.reduce((sum, q) => sum + (q.points || 0), 0);
            const maxPoints = total * 10;
            const percent = total > 0 ? (points / maxPoints) * 100 : 0;
            
            let grade = 'A';
            let color = '#27ae60';
            
            if (percent >= 90) {
                grade = 'A';
                color = '#27ae60';
            } else if (percent >= 80) {
                grade = 'B';
                color = '#2ecc71';
            } else if (percent >= 70) {
                grade = 'C';
                color = '#f39c12';
            } else if (percent >= 60) {
                grade = 'D';
                color = '#e67e22';
            } else {
                grade = 'F';
                color = '#e74c3c';
            }
            
            const lowScoreQuestions = allQuestions
                .filter(q => q.points !== null && q.points <= 4)
                .map(q => ({
                    id: q.id,
                    text: q.text,
                    points: q.points,
                    deviation: q.deviation?.text || 'Keine Abweichung'
                }));
            
            const evaluationContent = document.getElementById('evaluationContent');
            evaluationContent.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <h3 style="margin-bottom: 10px; color: #2c3e50;">Zusammenfassung</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Gesamtpunkte</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${points}/${maxPoints}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Prozent</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: ${color};">${percent.toFixed(1)}%</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Note</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: ${color};">${grade}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: white; border-radius: 4px;">
                            <div style="font-size: 0.8em; color: #7f8c8d;">Beantwortet</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${answered}/${total}</div>
                        </div>
                    </div>
                </div>
                
                ${lowScoreQuestions.length > 0 ? `
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #fff3f3; border-radius: 5px; border-left: 4px solid #e74c3c;">
                        <h3 style="margin-bottom: 10px; color: #c0392b;">Kritische Fragen (‚â§ 4 Punkte)</h3>
                        <div style="font-size: 0.9em;">
                            ${lowScoreQuestions.map(q => `
                                <div style="margin-bottom: 8px; padding: 8px; background-color: white; border-radius: 4px;">
                                    <strong style="color: #e74c3c;">${q.id} (${q.points} Punkte)</strong><br>
                                    ${q.text}<br>
                                    <em style="color: #7f8c8d; font-size: 0.9em;">Abweichung: ${q.deviation}</em>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 15px; padding: 10px; background-color: #e8f4fc; border-radius: 5px;">
                    <h3 style="margin-bottom: 10px; color: #2c3e50;">Empfehlungen</h3>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        ${percent >= 90 ? 
                            '<li>‚úÖ Sehr gutes Ergebnis. Der Prozess ist effektiv und gut dokumentiert.</li>' : 
                        percent >= 80 ? 
                            '<li>‚ö†Ô∏è Gutes Ergebnis. Einige Verbesserungspotentiale vorhanden.</li>' : 
                        percent >= 70 ? 
                            '<li>‚ö†Ô∏è Akzeptables Ergebnis. Es sollten Ma√ünahmen zur Verbesserung geplant werden.</li>' : 
                            '<li>‚ùå Kritisches Ergebnis. Es sind dringende Ma√ünahmen erforderlich.</li>'}
                        ${answered < total ? 
                            '<li>‚ö†Ô∏è Nicht alle Fragen wurden bewertet. Bitte vervollst√§ndigen Sie das Audit.</li>' : ''}
                        ${lowScoreQuestions.length > 0 ? 
                            `<li>‚ö†Ô∏è ${lowScoreQuestions.length} Fragen haben kritisch niedrige Punktzahlen. Diese sollten priorisiert angegangen werden.</li>` : ''}
                    </ul>
                </div>
            `;
        }
    </script>
</body>
</html>
